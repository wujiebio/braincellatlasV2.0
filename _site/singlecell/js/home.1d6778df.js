(self["webpackChunksingle_cell_vis"]=self["webpackChunksingle_cell_vis"]||[]).push([[962],{374:function(e,t,r){"use strict";r.d(t,{Sr:function(){return s},WE:function(){return l},un:function(){return o}});class n{constructor(e=1e3){this.frames=0,this.lastTime=performance.now(),this.fps=0,this.updateInterval=e}update(){this.frames++;const e=performance.now(),t=e-this.lastTime;return t>=this.updateInterval&&(this.fps=1e3*this.frames/t,this.lastTime=e,this.frames=0),this.fps}}class i{constructor(){this.marks=new Map,this.timings={},this.lastRenderTime=0,this.averageRenderTime=0,this.renderCount=0}startMark(e){this.marks.set(e,performance.now())}endMark(e){if(!this.marks.has(e))return 0;const t=this.marks.get(e),r=performance.now()-t;this.timings[e]||(this.timings[e]={total:0,count:0,average:0,min:r,max:r});const n=this.timings[e];return n.total+=r,n.count++,n.average=n.total/n.count,n.min=Math.min(n.min,r),n.max=Math.max(n.max,r),this.marks.delete(e),r}trackRenderTime(e){this.lastRenderTime=e,this.renderCount++,this.averageRenderTime=(this.averageRenderTime*(this.renderCount-1)+e)/this.renderCount}getTimings(){return this.timings}getAverageRenderTime(){return this.averageRenderTime}clear(){this.marks.clear(),this.timings={}}}class a{constructor(e={}){this.thresholds={renderTime:16,loadTime:500,memoryLimit:209715200,...e},this.warnings=[]}checkRenderTime(e){if(e>this.thresholds.renderTime){const t=`渲染时间(${e.toFixed(2)}ms)超过阈值(${this.thresholds.renderTime}ms)`;return this.warnings.push({type:"render",message:t,time:performance.now()}),t}return null}checkLoadTime(e){if(e>this.thresholds.loadTime){const t=`加载时间(${e.toFixed(2)}ms)超过阈值(${this.thresholds.loadTime}ms)`;return this.warnings.push({type:"load",message:t,time:performance.now()}),t}return null}checkMemoryUsage(){if(window.performance&&window.performance.memory){const e=window.performance.memory.usedJSHeapSize;if(e>this.thresholds.memoryLimit){const t=`内存使用(${(e/1024/1024).toFixed(2)}MB)超过阈值(${(this.thresholds.memoryLimit/1024/1024).toFixed(2)}MB)`;return this.warnings.push({type:"memory",message:t,time:performance.now()}),t}}return null}getWarnings(){return this.warnings}clearWarnings(){this.warnings=[]}}const s=new i,o=new a,l=new n},867:function(e){(function(t,r){e.exports=r()})(0,(function(){"use strict";var e=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray},t=function(e,t){for(var r=Object.keys(t),n=0;n<r.length;++n)e[r[n]]=t[r[n]];return e},r="\n";function n(e){return"undefined"!==typeof atob?atob(e):"base64:"+e}function i(e){var t=new Error("(regl) "+e);throw console.error(t),t}function a(e,t){e||i(t)}function s(e){return e?": "+e:""}function o(e,t,r){e in t||i("unknown parameter ("+e+")"+s(r)+". possible values: "+Object.keys(t).join())}function l(t,r){e(t)||i("invalid parameter type"+s(r)+". must be a typed array")}function c(e,t){switch(t){case"number":return"number"===typeof e;case"object":return"object"===typeof e;case"string":return"string"===typeof e;case"boolean":return"boolean"===typeof e;case"function":return"function"===typeof e;case"undefined":return"undefined"===typeof e;case"symbol":return"symbol"===typeof e}}function u(e,t,r){c(e,t)||i("invalid parameter type"+s(r)+". expected "+t+", got "+typeof e)}function h(e,t){e>=0&&(0|e)===e||i("invalid parameter type, ("+e+")"+s(t)+". must be a nonnegative integer")}function d(e,t,r){t.indexOf(e)<0&&i("invalid value"+s(r)+". must be one of: "+t)}var f=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function g(e){Object.keys(e).forEach((function(e){f.indexOf(e)<0&&i('invalid regl constructor argument "'+e+'". must be one of '+f)}))}function p(e,t){e+="";while(e.length<t)e=" "+e;return e}function m(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function v(e,t){this.number=e,this.line=t,this.errors=[]}function y(e,t,r){this.file=e,this.line=t,this.message=r}function b(){var e=new Error,t=(e.stack||e).toString(),r=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(t);if(r)return r[1];var n=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(t);return n?n[1]:"unknown"}function x(){var e=new Error,t=(e.stack||e).toString(),r=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(t);if(r)return r[1];var n=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(t);return n?n[1]:"unknown"}function w(e,t){var r=e.split("\n"),i=1,a=0,s={unknown:new m,0:new m};s.unknown.name=s[0].name=t||b(),s.unknown.lines.push(new v(0,""));for(var o=0;o<r.length;++o){var l=r[o],c=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(l);if(c)switch(c[1]){case"line":var u=/(\d+)(\s+\d+)?/.exec(c[2]);u&&(i=0|u[1],u[2]&&(a=0|u[2],a in s||(s[a]=new m)));break;case"define":var h=/SHADER_NAME(_B64)?\s+(.*)$/.exec(c[2]);h&&(s[a].name=h[1]?n(h[2]):h[2]);break}s[a].lines.push(new v(i++,l))}return Object.keys(s).forEach((function(e){var t=s[e];t.lines.forEach((function(e){t.index[e.number]=e}))})),s}function S(e){var t=[];return e.split("\n").forEach((function(e){if(!(e.length<5)){var r=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(e);r?t.push(new y(0|r[1],0|r[2],r[3].trim())):e.length>0&&t.push(new y("unknown",0,e))}})),t}function C(e,t){t.forEach((function(t){var r=e[t.file];if(r){var n=r.index[t.line];if(n)return n.errors.push(t),void(r.hasErrors=!0)}e.unknown.hasErrors=!0,e.unknown.lines[0].errors.push(t)}))}function A(e,t,n,i,s){if(!e.getShaderParameter(t,e.COMPILE_STATUS)){var o=e.getShaderInfoLog(t),l=i===e.FRAGMENT_SHADER?"fragment":"vertex";I(n,"string",l+" shader source must be a string",s);var c=w(n,s),u=S(o);C(c,u),Object.keys(c).forEach((function(e){var t=c[e];if(t.hasErrors){var n=[""],i=[""];a("file number "+e+": "+t.name+"\n","color:red;text-decoration:underline;font-weight:bold"),t.lines.forEach((function(e){if(e.errors.length>0){a(p(e.number,4)+"|  ","background-color:yellow; font-weight:bold"),a(e.line+r,"color:red; background-color:yellow; font-weight:bold");var t=0;e.errors.forEach((function(n){var i=n.message,s=/^\s*'(.*)'\s*:\s*(.*)$/.exec(i);if(s){var o=s[1];switch(i=s[2],o){case"assign":o="=";break}t=Math.max(e.line.indexOf(o,t),0)}else t=0;a(p("| ",6)),a(p("^^^",t+3)+r,"font-weight:bold"),a(p("| ",6)),a(i+r,"font-weight:bold")})),a(p("| ",6)+r)}else a(p(e.number,4)+"|  "),a(e.line+r,"color:red")})),"undefined"===typeof document||window.chrome?console.log(n.join("")):(i[0]=n.join("%c"),console.log.apply(console,i))}function a(e,t){n.push(e),i.push(t||"")}})),a.raise("Error compiling "+l+" shader, "+c[0].name)}}function _(e,t,n,i,s){if(!e.getProgramParameter(t,e.LINK_STATUS)){var o=e.getProgramInfoLog(t),l=w(n,s),c=w(i,s),u='Error linking program with vertex shader, "'+c[0].name+'", and fragment shader "'+l[0].name+'"';"undefined"!==typeof document?console.log("%c"+u+r+"%c"+o,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(u+r+o),a.raise(u)}}function k(e){e._commandRef=b()}function E(e,t,r,n){function i(e){return e?n.id(e):0}function a(e,t){Object.keys(t).forEach((function(t){e[n.id(t)]=!0}))}k(e),e._fragId=i(e.static.frag),e._vertId=i(e.static.vert);var s=e._uniformSet={};a(s,t.static),a(s,t.dynamic);var o=e._attributeSet={};a(o,r.static),a(o,r.dynamic),e._hasCount="count"in e.static||"count"in e.dynamic||"elements"in e.static||"elements"in e.dynamic}function D(e,t){var r=x();i(e+" in command "+(t||b())+("unknown"===r?"":" called from "+r))}function T(e,t,r){e||D(t,r||b())}function $(e,t,r,n){e in t||D("unknown parameter ("+e+")"+s(r)+". possible values: "+Object.keys(t).join(),n||b())}function I(e,t,r,n){c(e,t)||D("invalid parameter type"+s(r)+". expected "+t+", got "+typeof e,n||b())}function R(e){e()}function L(e,t,r){e.texture?d(e.texture._texture.internalformat,t,"unsupported texture format for attachment"):d(e.renderbuffer._renderbuffer.format,r,"unsupported renderbuffer format for attachment")}var O=33071,z=9728,F=9984,M=9985,V=9986,B=9987,H=5120,N=5121,P=5122,G=5123,j=5124,W=5125,q=5126,U=32819,X=32820,Y=33635,Z=34042,K=36193,Q={};function J(e,t){return e===X||e===U||e===Y?2:e===Z?4:Q[e]*t}function ee(e){return!(e&e-1)&&!!e}function te(e,t,r){var n,i=t.width,s=t.height,o=t.channels;a(i>0&&i<=r.maxTextureSize&&s>0&&s<=r.maxTextureSize,"invalid texture shape"),e.wrapS===O&&e.wrapT===O||a(ee(i)&&ee(s),"incompatible wrap mode for texture, both width and height must be power of 2"),1===t.mipmask?1!==i&&1!==s&&a(e.minFilter!==F&&e.minFilter!==V&&e.minFilter!==M&&e.minFilter!==B,"min filter requires mipmap"):(a(ee(i)&&ee(s),"texture must be a square power of 2 to support mipmapping"),a(t.mipmask===(i<<1)-1,"missing or incomplete mipmap data")),t.type===q&&(r.extensions.indexOf("oes_texture_float_linear")<0&&a(e.minFilter===z&&e.magFilter===z,"filter not supported, must enable oes_texture_float_linear"),a(!e.genMipmaps,"mipmap generation not supported with float textures"));var l=t.images;for(n=0;n<16;++n)if(l[n]){var c=i>>n,u=s>>n;a(t.mipmask&1<<n,"missing mipmap data");var h=l[n];if(a(h.width===c&&h.height===u,"invalid shape for mip images"),a(h.format===t.format&&h.internalformat===t.internalformat&&h.type===t.type,"incompatible type for mip image"),h.compressed);else if(h.data){var d=Math.ceil(J(h.type,o)*c/h.unpackAlignment)*h.unpackAlignment;a(h.data.byteLength===d*u,"invalid data for image, buffer size is inconsistent with image format")}else h.element||h.copy}else e.genMipmaps||a(0===(t.mipmask&1<<n),"extra mipmap data");t.compressed&&a(!e.genMipmaps,"mipmap generation for compressed images not supported")}function re(e,t,r,n){var i=e.width,s=e.height,o=e.channels;a(i>0&&i<=n.maxTextureSize&&s>0&&s<=n.maxTextureSize,"invalid texture shape"),a(i===s,"cube map must be square"),a(t.wrapS===O&&t.wrapT===O,"wrap mode not supported by cube map");for(var l=0;l<r.length;++l){var c=r[l];a(c.width===i&&c.height===s,"inconsistent cube map face shape"),t.genMipmaps&&(a(!c.compressed,"can not generate mipmap for compressed textures"),a(1===c.mipmask,"can not specify mipmaps and generate mipmaps"));for(var u=c.images,h=0;h<16;++h){var d=u[h];if(d){var f=i>>h,g=s>>h;a(c.mipmask&1<<h,"missing mipmap data"),a(d.width===f&&d.height===g,"invalid shape for mip images"),a(d.format===e.format&&d.internalformat===e.internalformat&&d.type===e.type,"incompatible type for mip image"),d.compressed||(d.data?a(d.data.byteLength===f*g*Math.max(J(d.type,o),d.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):d.element||d.copy)}}}}Q[H]=Q[N]=1,Q[P]=Q[G]=Q[K]=Q[Y]=Q[U]=Q[X]=2,Q[j]=Q[W]=Q[q]=Q[Z]=4;var ne=t(a,{optional:R,raise:i,commandRaise:D,command:T,parameter:o,commandParameter:$,constructor:g,type:u,commandType:I,isTypedArray:l,nni:h,oneOf:d,shaderError:A,linkError:_,callSite:x,saveCommandRef:k,saveDrawInfo:E,framebufferFormat:L,guessCommand:b,texture2D:te,textureCube:re}),ie=0,ae=0,se=5,oe=6;function le(e,t){this.id=ie++,this.type=e,this.data=t}function ce(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function ue(e){if(0===e.length)return[];var t=e.charAt(0),r=e.charAt(e.length-1);if(e.length>1&&t===r&&('"'===t||"'"===t))return['"'+ce(e.substr(1,e.length-2))+'"'];var n=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e);if(n)return ue(e.substr(0,n.index)).concat(ue(n[1])).concat(ue(e.substr(n.index+n[0].length)));var i=e.split(".");if(1===i.length)return['"'+ce(e)+'"'];for(var a=[],s=0;s<i.length;++s)a=a.concat(ue(i[s]));return a}function he(e){return"["+ue(e).join("][")+"]"}function de(e,t){return new le(e,he(t+""))}function fe(e){return"function"===typeof e&&!e._reglType||e instanceof le}function ge(e,t){return"function"===typeof e?new le(ae,e):"number"===typeof e||"boolean"===typeof e?new le(se,e):Array.isArray(e)?new le(oe,e.map((function(e,r){return ge(e,t+"["+r+"]")}))):e instanceof le?e:void ne(!1,"invalid option type in uniform "+t)}var pe={DynamicVariable:le,define:de,isDynamic:fe,unbox:ge,accessor:he},me={next:"function"===typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"===typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},ve="undefined"!==typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function ye(){var e={"":0},t=[""];return{id:function(r){var n=e[r];return n||(n=e[r]=t.length,t.push(r),n)},str:function(e){return t[e]}}}function be(e,r,n){var i,a=document.createElement("canvas");function s(){var t=window.innerWidth,r=window.innerHeight;if(e!==document.body){var i=a.getBoundingClientRect();t=i.right-i.left,r=i.bottom-i.top}a.width=n*t,a.height=n*r}function o(){i?i.disconnect():window.removeEventListener("resize",s),e.removeChild(a)}return t(a.style,{border:0,margin:0,padding:0,top:0,left:0,width:"100%",height:"100%"}),e.appendChild(a),e===document.body&&(a.style.position="absolute",t(e.style,{margin:0,padding:0})),e!==document.body&&"function"===typeof ResizeObserver?(i=new ResizeObserver((function(){setTimeout(s)})),i.observe(e)):window.addEventListener("resize",s,!1),s(),{canvas:a,onDestroy:o}}function xe(e,t){function r(r){try{return e.getContext(r,t)}catch(n){return null}}return r("webgl")||r("experimental-webgl")||r("webgl-experimental")}function we(e){return"string"===typeof e.nodeName&&"function"===typeof e.appendChild&&"function"===typeof e.getBoundingClientRect}function Se(e){return"function"===typeof e.drawArrays||"function"===typeof e.drawElements}function Ce(e){return"string"===typeof e?e.split():(ne(Array.isArray(e),"invalid extension array"),e)}function Ae(e){return"string"===typeof e?(ne("undefined"!==typeof document,"not supported outside of DOM"),document.querySelector(e)):e}function _e(e){var t,r,n,i,a=e||{},s={},o=[],l=[],c="undefined"===typeof window?1:window.devicePixelRatio,u=!1,h=function(e){e&&ne.raise(e)},d=function(){};if("string"===typeof a?(ne("undefined"!==typeof document,"selector queries only supported in DOM environments"),t=document.querySelector(a),ne(t,"invalid query string for element")):"object"===typeof a?we(a)?t=a:Se(a)?(i=a,n=i.canvas):(ne.constructor(a),"gl"in a?i=a.gl:"canvas"in a?n=Ae(a.canvas):"container"in a&&(r=Ae(a.container)),"attributes"in a&&(s=a.attributes,ne.type(s,"object","invalid context attributes")),"extensions"in a&&(o=Ce(a.extensions)),"optionalExtensions"in a&&(l=Ce(a.optionalExtensions)),"onDone"in a&&(ne.type(a.onDone,"function","invalid or missing onDone callback"),h=a.onDone),"profile"in a&&(u=!!a.profile),"pixelRatio"in a&&(c=+a.pixelRatio,ne(c>0,"invalid pixel ratio"))):ne.raise("invalid arguments to regl"),t&&("canvas"===t.nodeName.toLowerCase()?n=t:r=t),!i){if(!n){ne("undefined"!==typeof document,"must manually specify webgl context outside of DOM environments");var f=be(r||document.body,h,c);if(!f)return null;n=f.canvas,d=f.onDestroy}void 0===s.premultipliedAlpha&&(s.premultipliedAlpha=!0),i=xe(n,s)}return i?{gl:i,canvas:n,container:r,extensions:o,optionalExtensions:l,pixelRatio:c,profile:u,onDone:h,onDestroy:d}:(d(),h("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function ke(e,t){var r={};function n(t){ne.type(t,"string","extension name must be string");var n,i=t.toLowerCase();try{n=r[i]=e.getExtension(i)}catch(a){}return!!n}for(var i=0;i<t.extensions.length;++i){var a=t.extensions[i];if(!n(a))return t.onDestroy(),t.onDone('"'+a+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(n),{extensions:r,restore:function(){Object.keys(r).forEach((function(e){if(r[e]&&!n(e))throw new Error("(regl): error restoring extension "+e)}))}}}function Ee(e,t){for(var r=Array(e),n=0;n<e;++n)r[n]=t(n);return r}var De=5120,Te=5121,$e=5122,Ie=5123,Re=5124,Le=5125,Oe=5126;function ze(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}function Fe(e){var t,r;return t=(e>65535)<<4,e>>>=t,r=(e>255)<<3,e>>>=r,t|=r,r=(e>15)<<2,e>>>=r,t|=r,r=(e>3)<<1,e>>>=r,t|=r,t|e>>1}function Me(){var e=Ee(8,(function(){return[]}));function t(t){var r=ze(t),n=e[Fe(r)>>2];return n.length>0?n.pop():new ArrayBuffer(r)}function r(t){e[Fe(t.byteLength)>>2].push(t)}function n(e,r){var n=null;switch(e){case De:n=new Int8Array(t(r),0,r);break;case Te:n=new Uint8Array(t(r),0,r);break;case $e:n=new Int16Array(t(2*r),0,r);break;case Ie:n=new Uint16Array(t(2*r),0,r);break;case Re:n=new Int32Array(t(4*r),0,r);break;case Le:n=new Uint32Array(t(4*r),0,r);break;case Oe:n=new Float32Array(t(4*r),0,r);break;default:return null}return n.length!==r?n.subarray(0,r):n}function i(e){r(e.buffer)}return{alloc:t,free:r,allocType:n,freeType:i}}var Ve=Me();Ve.zero=Me();var Be=3408,He=3410,Ne=3411,Pe=3412,Ge=3413,je=3414,We=3415,qe=33901,Ue=33902,Xe=3379,Ye=3386,Ze=34921,Ke=36347,Qe=36348,Je=35661,et=35660,tt=34930,rt=36349,nt=34076,it=34024,at=7936,st=7937,ot=7938,lt=35724,ct=34047,ut=36063,ht=34852,dt=3553,ft=34067,gt=34069,pt=33984,mt=6408,vt=5126,yt=5121,bt=36160,xt=36053,wt=36064,St=16384,Ct=function(e,t){var r=1;t.ext_texture_filter_anisotropic&&(r=e.getParameter(ct));var n=1,i=1;t.webgl_draw_buffers&&(n=e.getParameter(ht),i=e.getParameter(ut));var a=!!t.oes_texture_float;if(a){var s=e.createTexture();e.bindTexture(dt,s),e.texImage2D(dt,0,mt,1,1,0,mt,vt,null);var o=e.createFramebuffer();if(e.bindFramebuffer(bt,o),e.framebufferTexture2D(bt,wt,dt,s,0),e.bindTexture(dt,null),e.checkFramebufferStatus(bt)!==xt)a=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(St);var l=Ve.allocType(vt,4);e.readPixels(0,0,1,1,mt,vt,l),e.getError()?a=!1:(e.deleteFramebuffer(o),e.deleteTexture(s),a=1===l[0]),Ve.freeType(l)}}var c="undefined"!==typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent)),u=!0;if(!c){var h=e.createTexture(),d=Ve.allocType(yt,36);e.activeTexture(pt),e.bindTexture(ft,h),e.texImage2D(gt,0,mt,3,3,0,mt,yt,d),Ve.freeType(d),e.bindTexture(ft,null),e.deleteTexture(h),u=!e.getError()}return{colorBits:[e.getParameter(He),e.getParameter(Ne),e.getParameter(Pe),e.getParameter(Ge)],depthBits:e.getParameter(je),stencilBits:e.getParameter(We),subpixelBits:e.getParameter(Be),extensions:Object.keys(t).filter((function(e){return!!t[e]})),maxAnisotropic:r,maxDrawbuffers:n,maxColorAttachments:i,pointSizeDims:e.getParameter(qe),lineWidthDims:e.getParameter(Ue),maxViewportDims:e.getParameter(Ye),maxCombinedTextureUnits:e.getParameter(Je),maxCubeMapSize:e.getParameter(nt),maxRenderbufferSize:e.getParameter(it),maxTextureUnits:e.getParameter(tt),maxTextureSize:e.getParameter(Xe),maxAttributes:e.getParameter(Ze),maxVertexUniforms:e.getParameter(Ke),maxVertexTextureUnits:e.getParameter(et),maxVaryingVectors:e.getParameter(Qe),maxFragmentUniforms:e.getParameter(rt),glsl:e.getParameter(lt),renderer:e.getParameter(st),vendor:e.getParameter(at),version:e.getParameter(ot),readFloat:a,npotTextureCube:u}};function At(t){return!!t&&"object"===typeof t&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"===typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||e(t.data))}var _t=function(e){return Object.keys(e).map((function(t){return e[t]}))},kt={shape:Rt,flatten:It};function Et(e,t,r){for(var n=0;n<t;++n)r[n]=e[n]}function Dt(e,t,r,n){for(var i=0,a=0;a<t;++a)for(var s=e[a],o=0;o<r;++o)n[i++]=s[o]}function Tt(e,t,r,n,i,a){for(var s=a,o=0;o<t;++o)for(var l=e[o],c=0;c<r;++c)for(var u=l[c],h=0;h<n;++h)i[s++]=u[h]}function $t(e,t,r,n,i){for(var a=1,s=r+1;s<t.length;++s)a*=t[s];var o=t[r];if(t.length-r===4){var l=t[r+1],c=t[r+2],u=t[r+3];for(s=0;s<o;++s)Tt(e[s],l,c,u,n,i),i+=a}else for(s=0;s<o;++s)$t(e[s],t,r+1,n,i),i+=a}function It(e,t,r,n){var i=1;if(t.length)for(var a=0;a<t.length;++a)i*=t[a];else i=0;var s=n||Ve.allocType(r,i);switch(t.length){case 0:break;case 1:Et(e,t[0],s);break;case 2:Dt(e,t[0],t[1],s);break;case 3:Tt(e,t[0],t[1],t[2],s,0);break;default:$t(e,t,0,s,0)}return s}function Rt(e){for(var t=[],r=e;r.length;r=r[0])t.push(r.length);return t}var Lt={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},Ot=5120,zt=5122,Ft=5124,Mt=5121,Vt=5123,Bt=5125,Ht=5126,Nt=5126,Pt={int8:Ot,int16:zt,int32:Ft,uint8:Mt,uint16:Vt,uint32:Bt,float:Ht,float32:Nt},Gt=35048,jt=35040,Wt={dynamic:Gt,stream:jt,static:35044},qt=kt.flatten,Ut=kt.shape,Xt=35044,Yt=35040,Zt=5121,Kt=5126,Qt=[];function Jt(e){return 0|Lt[Object.prototype.toString.call(e)]}function er(e,t){for(var r=0;r<t.length;++r)e[r]=t[r]}function tr(e,t,r,n,i,a,s){for(var o=0,l=0;l<r;++l)for(var c=0;c<n;++c)e[o++]=t[i*l+a*c+s]}function rr(t,r,n,i){var a=0,s={};function o(e){this.id=a++,this.buffer=t.createBuffer(),this.type=e,this.usage=Xt,this.byteLength=0,this.dimension=1,this.dtype=Zt,this.persistentData=null,n.profile&&(this.stats={size:0})}o.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},o.prototype.destroy=function(){f(this)};var l=[];function c(e,t){var r=l.pop();return r||(r=new o(e)),r.bind(),d(r,t,Yt,0,1,!1),r}function u(e){l.push(e)}function h(e,r,n){e.byteLength=r.byteLength,t.bufferData(e.type,r,n)}function d(t,r,n,i,a,s){var o,l;if(t.usage=n,Array.isArray(r)){if(t.dtype=i||Kt,r.length>0)if(Array.isArray(r[0])){o=Ut(r);for(var c=1,u=1;u<o.length;++u)c*=o[u];t.dimension=c,l=qt(r,o,t.dtype),h(t,l,n),s?t.persistentData=l:Ve.freeType(l)}else if("number"===typeof r[0]){t.dimension=a;var d=Ve.allocType(t.dtype,r.length);er(d,r),h(t,d,n),s?t.persistentData=d:Ve.freeType(d)}else e(r[0])?(t.dimension=r[0].length,t.dtype=i||Jt(r[0])||Kt,l=qt(r,[r.length,r[0].length],t.dtype),h(t,l,n),s?t.persistentData=l:Ve.freeType(l)):ne.raise("invalid buffer data")}else if(e(r))t.dtype=i||Jt(r),t.dimension=a,h(t,r,n),s&&(t.persistentData=new Uint8Array(new Uint8Array(r.buffer)));else if(At(r)){o=r.shape;var f=r.stride,g=r.offset,p=0,m=0,v=0,y=0;1===o.length?(p=o[0],m=1,v=f[0],y=0):2===o.length?(p=o[0],m=o[1],v=f[0],y=f[1]):ne.raise("invalid shape"),t.dtype=i||Jt(r.data)||Kt,t.dimension=m;var b=Ve.allocType(t.dtype,p*m);tr(b,r.data,p,m,v,y,g),h(t,b,n),s?t.persistentData=b:Ve.freeType(b)}else r instanceof ArrayBuffer?(t.dtype=Zt,t.dimension=a,h(t,r,n),s&&(t.persistentData=new Uint8Array(new Uint8Array(r)))):ne.raise("invalid buffer data")}function f(e){r.bufferCount--,i(e);var n=e.buffer;ne(n,"buffer must not be deleted already"),t.deleteBuffer(n),e.buffer=null,delete s[e.id]}function g(i,a,l,c){r.bufferCount++;var u=new o(a);function h(r){var i=Xt,a=null,s=0,o=0,l=1;return Array.isArray(r)||e(r)||At(r)||r instanceof ArrayBuffer?a=r:"number"===typeof r?s=0|r:r&&(ne.type(r,"object","buffer arguments must be an object, a number or an array"),"data"in r&&(ne(null===a||Array.isArray(a)||e(a)||At(a),"invalid data for buffer"),a=r.data),"usage"in r&&(ne.parameter(r.usage,Wt,"invalid buffer usage"),i=Wt[r.usage]),"type"in r&&(ne.parameter(r.type,Pt,"invalid buffer type"),o=Pt[r.type]),"dimension"in r&&(ne.type(r.dimension,"number","invalid dimension"),l=0|r.dimension),"length"in r&&(ne.nni(s,"buffer length must be a nonnegative integer"),s=0|r.length)),u.bind(),a?d(u,a,i,o,l,c):(s&&t.bufferData(u.type,s,i),u.dtype=o||Zt,u.usage=i,u.dimension=l,u.byteLength=s),n.profile&&(u.stats.size=u.byteLength*Qt[u.dtype]),h}function g(e,r){ne(r+e.byteLength<=u.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+e.byteLength+" starting from offset "+r+" to a buffer of size "+u.byteLength),t.bufferSubData(u.type,r,e)}function p(t,r){var n,i=0|(r||0);if(u.bind(),e(t)||t instanceof ArrayBuffer)g(t,i);else if(Array.isArray(t)){if(t.length>0)if("number"===typeof t[0]){var a=Ve.allocType(u.dtype,t.length);er(a,t),g(a,i),Ve.freeType(a)}else if(Array.isArray(t[0])||e(t[0])){n=Ut(t);var s=qt(t,n,u.dtype);g(s,i),Ve.freeType(s)}else ne.raise("invalid buffer data")}else if(At(t)){n=t.shape;var o=t.stride,l=0,c=0,d=0,f=0;1===n.length?(l=n[0],c=1,d=o[0],f=0):2===n.length?(l=n[0],c=n[1],d=o[0],f=o[1]):ne.raise("invalid shape");var p=Array.isArray(t.data)?u.dtype:Jt(t.data),m=Ve.allocType(p,l*c);tr(m,t.data,l,c,d,f,t.offset),g(m,i),Ve.freeType(m)}else ne.raise("invalid data for buffer subdata");return h}return s[u.id]=u,l||h(i),h._reglType="buffer",h._buffer=u,h.subdata=p,n.profile&&(h.stats=u.stats),h.destroy=function(){f(u)},h}function p(){_t(s).forEach((function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)}))}return n.profile&&(r.getTotalBufferSize=function(){var e=0;return Object.keys(s).forEach((function(t){e+=s[t].stats.size})),e}),{create:g,createStream:c,destroyStream:u,clear:function(){_t(s).forEach(f),l.forEach(f)},getBuffer:function(e){return e&&e._buffer instanceof o?e._buffer:null},restore:p,_initBuffer:d}}Qt[5120]=1,Qt[5122]=2,Qt[5124]=4,Qt[5121]=1,Qt[5123]=2,Qt[5125]=4,Qt[5126]=4;var nr=0,ir=0,ar=1,sr=1,or=4,lr=4,cr={points:nr,point:ir,lines:ar,line:sr,triangles:or,triangle:lr,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},ur=0,hr=1,dr=4,fr=5120,gr=5121,pr=5122,mr=5123,vr=5124,yr=5125,br=34963,xr=35040,wr=35044;function Sr(t,r,n,i){var a={},s=0,o={uint8:gr,uint16:mr};function l(e){this.id=s++,a[this.id]=this,this.buffer=e,this.primType=dr,this.vertCount=0,this.type=0}r.oes_element_index_uint&&(o.uint32=yr),l.prototype.bind=function(){this.buffer.bind()};var c=[];function u(e){var t=c.pop();return t||(t=new l(n.create(null,br,!0,!1)._buffer)),d(t,e,xr,-1,-1,0,0),t}function h(e){c.push(e)}function d(i,a,s,o,l,c,u){var h;if(i.buffer.bind(),a){var d=u;u||e(a)&&(!At(a)||e(a.data))||(d=r.oes_element_index_uint?yr:mr),n._initBuffer(i.buffer,a,s,d,3)}else t.bufferData(br,c,s),i.buffer.dtype=h||gr,i.buffer.usage=s,i.buffer.dimension=3,i.buffer.byteLength=c;if(h=u,!u){switch(i.buffer.dtype){case gr:case fr:h=gr;break;case mr:case pr:h=mr;break;case yr:case vr:h=yr;break;default:ne.raise("unsupported type for element array")}i.buffer.dtype=h}i.type=h,ne(h!==yr||!!r.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var f=l;f<0&&(f=i.buffer.byteLength,h===mr?f>>=1:h===yr&&(f>>=2)),i.vertCount=f;var g=o;if(o<0){g=dr;var p=i.buffer.dimension;1===p&&(g=ur),2===p&&(g=hr),3===p&&(g=dr)}i.primType=g}function f(e){i.elementsCount--,ne(null!==e.buffer,"must not double destroy elements"),delete a[e.id],e.buffer.destroy(),e.buffer=null}function g(t,r){var a=n.create(null,br,!0),s=new l(a._buffer);function c(t){if(t)if("number"===typeof t)a(t),s.primType=dr,s.vertCount=0|t,s.type=gr;else{var r=null,n=wr,i=-1,l=-1,u=0,h=0;Array.isArray(t)||e(t)||At(t)?r=t:(ne.type(t,"object","invalid arguments for elements"),"data"in t&&(r=t.data,ne(Array.isArray(r)||e(r)||At(r),"invalid data for element buffer")),"usage"in t&&(ne.parameter(t.usage,Wt,"invalid element buffer usage"),n=Wt[t.usage]),"primitive"in t&&(ne.parameter(t.primitive,cr,"invalid element buffer primitive"),i=cr[t.primitive]),"count"in t&&(ne("number"===typeof t.count&&t.count>=0,"invalid vertex count for elements"),l=0|t.count),"type"in t&&(ne.parameter(t.type,o,"invalid buffer type"),h=o[t.type]),"length"in t?u=0|t.length:(u=l,h===mr||h===pr?u*=2:h!==yr&&h!==vr||(u*=4))),d(s,r,n,i,l,u,h)}else a(),s.primType=dr,s.vertCount=0,s.type=gr;return c}return i.elementsCount++,c(t),c._reglType="elements",c._elements=s,c.subdata=function(e,t){return a.subdata(e,t),c},c.destroy=function(){f(s)},c}return{create:g,createStream:u,destroyStream:h,getElements:function(e){return"function"===typeof e&&e._elements instanceof l?e._elements:null},clear:function(){_t(a).forEach(f)}}}var Cr=new Float32Array(1),Ar=new Uint32Array(Cr.buffer),_r=5123;function kr(e){for(var t=Ve.allocType(_r,e.length),r=0;r<e.length;++r)if(isNaN(e[r]))t[r]=65535;else if(e[r]===1/0)t[r]=31744;else if(e[r]===-1/0)t[r]=64512;else{Cr[0]=e[r];var n=Ar[0],i=n>>>31<<15,a=(n<<1>>>24)-127,s=n>>13&1023;if(a<-24)t[r]=i;else if(a<-14){var o=-14-a;t[r]=i+(s+1024>>o)}else t[r]=a>15?i+31744:i+(a+15<<10)+s}return t}function Er(t){return Array.isArray(t)||e(t)}var Dr=function(e){return!(e&e-1)&&!!e},Tr=34467,$r=3553,Ir=34067,Rr=34069,Lr=6408,Or=6406,zr=6407,Fr=6409,Mr=6410,Vr=32854,Br=32855,Hr=36194,Nr=32819,Pr=32820,Gr=33635,jr=34042,Wr=6402,qr=34041,Ur=35904,Xr=35906,Yr=36193,Zr=33776,Kr=33777,Qr=33778,Jr=33779,en=35986,tn=35987,rn=34798,nn=35840,an=35841,sn=35842,on=35843,ln=36196,cn=5121,un=5123,hn=5125,dn=5126,fn=10242,gn=10243,pn=10497,mn=33071,vn=33648,yn=10240,bn=10241,xn=9728,wn=9729,Sn=9984,Cn=9985,An=9986,_n=9987,kn=33170,En=4352,Dn=4353,Tn=4354,$n=34046,In=3317,Rn=37440,Ln=37441,On=37443,zn=37444,Fn=33984,Mn=[Sn,An,Cn,_n],Vn=[0,Fr,Mr,zr,Lr],Bn={};function Hn(e){return"[object "+e+"]"}Bn[Fr]=Bn[Or]=Bn[Wr]=1,Bn[qr]=Bn[Mr]=2,Bn[zr]=Bn[Ur]=3,Bn[Lr]=Bn[Xr]=4;var Nn=Hn("HTMLCanvasElement"),Pn=Hn("OffscreenCanvas"),Gn=Hn("CanvasRenderingContext2D"),jn=Hn("ImageBitmap"),Wn=Hn("HTMLImageElement"),qn=Hn("HTMLVideoElement"),Un=Object.keys(Lt).concat([Nn,Pn,Gn,jn,Wn,qn]),Xn=[];Xn[cn]=1,Xn[dn]=4,Xn[Yr]=2,Xn[un]=2,Xn[hn]=4;var Yn=[];function Zn(e){return Array.isArray(e)&&(0===e.length||"number"===typeof e[0])}function Kn(e){if(!Array.isArray(e))return!1;var t=e.length;return!(0===t||!Er(e[0]))}function Qn(e){return Object.prototype.toString.call(e)}function Jn(e){return Qn(e)===Nn}function ei(e){return Qn(e)===Pn}function ti(e){return Qn(e)===Gn}function ri(e){return Qn(e)===jn}function ni(e){return Qn(e)===Wn}function ii(e){return Qn(e)===qn}function ai(e){if(!e)return!1;var t=Qn(e);return Un.indexOf(t)>=0||(Zn(e)||Kn(e)||At(e))}function si(e){return 0|Lt[Object.prototype.toString.call(e)]}function oi(e,t){var r=t.length;switch(e.type){case cn:case un:case hn:case dn:var n=Ve.allocType(e.type,r);n.set(t),e.data=n;break;case Yr:e.data=kr(t);break;default:ne.raise("unsupported texture type, must specify a typed array")}}function li(e,t){return Ve.allocType(e.type===Yr?dn:e.type,t)}function ci(e,t){e.type===Yr?(e.data=kr(t),Ve.freeType(t)):e.data=t}function ui(e,t,r,n,i,a){for(var s=e.width,o=e.height,l=e.channels,c=s*o*l,u=li(e,c),h=0,d=0;d<o;++d)for(var f=0;f<s;++f)for(var g=0;g<l;++g)u[h++]=t[r*f+n*d+i*g+a];ci(e,u)}function hi(e,t,r,n,i,a){var s;if(s="undefined"!==typeof Yn[e]?Yn[e]:Bn[e]*Xn[t],a&&(s*=6),i){var o=0,l=r;while(l>=1)o+=s*l*l,l/=2;return o}return s*r*n}function di(r,n,i,a,s,o,l){var c={"don't care":En,"dont care":En,nice:Tn,fast:Dn},u={repeat:pn,clamp:mn,mirror:vn},h={nearest:xn,linear:wn},d=t({mipmap:_n,"nearest mipmap nearest":Sn,"linear mipmap nearest":Cn,"nearest mipmap linear":An,"linear mipmap linear":_n},h),f={none:0,browser:zn},g={uint8:cn,rgba4:Nr,rgb565:Gr,"rgb5 a1":Pr},p={alpha:Or,luminance:Fr,"luminance alpha":Mr,rgb:zr,rgba:Lr,rgba4:Vr,"rgb5 a1":Br,rgb565:Hr},m={};n.ext_srgb&&(p.srgb=Ur,p.srgba=Xr),n.oes_texture_float&&(g.float32=g.float=dn),n.oes_texture_half_float&&(g["float16"]=g["half float"]=Yr),n.webgl_depth_texture&&(t(p,{depth:Wr,"depth stencil":qr}),t(g,{uint16:un,uint32:hn,"depth stencil":jr})),n.webgl_compressed_texture_s3tc&&t(m,{"rgb s3tc dxt1":Zr,"rgba s3tc dxt1":Kr,"rgba s3tc dxt3":Qr,"rgba s3tc dxt5":Jr}),n.webgl_compressed_texture_atc&&t(m,{"rgb atc":en,"rgba atc explicit alpha":tn,"rgba atc interpolated alpha":rn}),n.webgl_compressed_texture_pvrtc&&t(m,{"rgb pvrtc 4bppv1":nn,"rgb pvrtc 2bppv1":an,"rgba pvrtc 4bppv1":sn,"rgba pvrtc 2bppv1":on}),n.webgl_compressed_texture_etc1&&(m["rgb etc1"]=ln);var v=Array.prototype.slice.call(r.getParameter(Tr));Object.keys(m).forEach((function(e){var t=m[e];v.indexOf(t)>=0&&(p[e]=t)}));var y=Object.keys(p);i.textureFormats=y;var b=[];Object.keys(p).forEach((function(e){var t=p[e];b[t]=e}));var x=[];Object.keys(g).forEach((function(e){var t=g[e];x[t]=e}));var w=[];Object.keys(h).forEach((function(e){var t=h[e];w[t]=e}));var S=[];Object.keys(d).forEach((function(e){var t=d[e];S[t]=e}));var C=[];Object.keys(u).forEach((function(e){var t=u[e];C[t]=e}));var A=y.reduce((function(e,t){var r=p[t];return r===Fr||r===Or||r===Fr||r===Mr||r===Wr||r===qr||n.ext_srgb&&(r===Ur||r===Xr)?e[r]=r:r===Br||t.indexOf("rgba")>=0?e[r]=Lr:e[r]=zr,e}),{});function _(){this.internalformat=Lr,this.format=Lr,this.type=cn,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=zn,this.width=0,this.height=0,this.channels=0}function k(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function E(e,t){if("object"===typeof t&&t){if("premultiplyAlpha"in t&&(ne.type(t.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(ne.type(t.flipY,"boolean","invalid texture flip"),e.flipY=t.flipY),"alignment"in t&&(ne.oneOf(t.alignment,[1,2,4,8],"invalid texture unpack alignment"),e.unpackAlignment=t.alignment),"colorSpace"in t&&(ne.parameter(t.colorSpace,f,"invalid colorSpace"),e.colorSpace=f[t.colorSpace]),"type"in t){var r=t.type;ne(n.oes_texture_float||!("float"===r||"float32"===r),"you must enable the OES_texture_float extension in order to use floating point textures."),ne(n.oes_texture_half_float||!("half float"===r||"float16"===r),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),ne(n.webgl_depth_texture||!("uint16"===r||"uint32"===r||"depth stencil"===r),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),ne.parameter(r,g,"invalid texture type"),e.type=g[r]}var a=e.width,s=e.height,o=e.channels,l=!1;"shape"in t?(ne(Array.isArray(t.shape)&&t.shape.length>=2,"shape must be an array"),a=t.shape[0],s=t.shape[1],3===t.shape.length&&(o=t.shape[2],ne(o>0&&o<=4,"invalid number of channels"),l=!0),ne(a>=0&&a<=i.maxTextureSize,"invalid width"),ne(s>=0&&s<=i.maxTextureSize,"invalid height")):("radius"in t&&(a=s=t.radius,ne(a>=0&&a<=i.maxTextureSize,"invalid radius")),"width"in t&&(a=t.width,ne(a>=0&&a<=i.maxTextureSize,"invalid width")),"height"in t&&(s=t.height,ne(s>=0&&s<=i.maxTextureSize,"invalid height")),"channels"in t&&(o=t.channels,ne(o>0&&o<=4,"invalid number of channels"),l=!0)),e.width=0|a,e.height=0|s,e.channels=0|o;var c=!1;if("format"in t){var u=t.format;ne(n.webgl_depth_texture||!("depth"===u||"depth stencil"===u),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),ne.parameter(u,p,"invalid texture format");var h=e.internalformat=p[u];e.format=A[h],u in g&&("type"in t||(e.type=g[u])),u in m&&(e.compressed=!0),c=!0}!l&&c?e.channels=Bn[e.format]:l&&!c?e.channels!==Vn[e.format]&&(e.format=e.internalformat=Vn[e.channels]):c&&l&&ne(e.channels===Bn[e.format],"number of channels inconsistent with specified format")}}function D(e){r.pixelStorei(Rn,e.flipY),r.pixelStorei(Ln,e.premultiplyAlpha),r.pixelStorei(On,e.colorSpace),r.pixelStorei(In,e.unpackAlignment)}function T(){_.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function $(t,r){var n=null;if(ai(r)?n=r:r&&(ne.type(r,"object","invalid pixel data type"),E(t,r),"x"in r&&(t.xOffset=0|r.x),"y"in r&&(t.yOffset=0|r.y),ai(r.data)&&(n=r.data)),ne(!t.compressed||n instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),r.copy){ne(!n,"can not specify copy and data field for the same texture");var a=s.viewportWidth,o=s.viewportHeight;t.width=t.width||a-t.xOffset,t.height=t.height||o-t.yOffset,t.needsCopy=!0,ne(t.xOffset>=0&&t.xOffset<a&&t.yOffset>=0&&t.yOffset<o&&t.width>0&&t.width<=a&&t.height>0&&t.height<=o,"copy texture read out of bounds")}else if(n){if(e(n))t.channels=t.channels||4,t.data=n,"type"in r||t.type!==cn||(t.type=si(n));else if(Zn(n))t.channels=t.channels||4,oi(t,n),t.alignment=1,t.needsFree=!0;else if(At(n)){var l=n.data;Array.isArray(l)||t.type!==cn||(t.type=si(l));var c,u,h,d,f,g,p=n.shape,m=n.stride;3===p.length?(h=p[2],g=m[2]):(ne(2===p.length,"invalid ndarray pixel data, must be 2 or 3D"),h=1,g=1),c=p[0],u=p[1],d=m[0],f=m[1],t.alignment=1,t.width=c,t.height=u,t.channels=h,t.format=t.internalformat=Vn[h],t.needsFree=!0,ui(t,l,d,f,g,n.offset)}else if(Jn(n)||ei(n)||ti(n))Jn(n)||ei(n)?t.element=n:t.element=n.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(ri(n))t.element=n,t.width=n.width,t.height=n.height,t.channels=4;else if(ni(n))t.element=n,t.width=n.naturalWidth,t.height=n.naturalHeight,t.channels=4;else if(ii(n))t.element=n,t.width=n.videoWidth,t.height=n.videoHeight,t.channels=4;else if(Kn(n)){var v=t.width||n[0].length,y=t.height||n.length,b=t.channels;b=Er(n[0][0])?b||n[0][0].length:b||1;for(var x=kt.shape(n),w=1,S=0;S<x.length;++S)w*=x[S];var C=li(t,w);kt.flatten(n,x,"",C),ci(t,C),t.alignment=1,t.width=v,t.height=y,t.channels=b,t.format=t.internalformat=Vn[b],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4;t.type===dn?ne(i.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):t.type===Yr&&ne(i.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function I(e,t,n){var i=e.element,s=e.data,o=e.internalformat,l=e.format,c=e.type,u=e.width,h=e.height;D(e),i?r.texImage2D(t,n,l,l,c,i):e.compressed?r.compressedTexImage2D(t,n,o,u,h,0,s):e.needsCopy?(a(),r.copyTexImage2D(t,n,l,e.xOffset,e.yOffset,u,h,0)):r.texImage2D(t,n,l,u,h,0,l,c,s||null)}function R(e,t,n,i,s){var o=e.element,l=e.data,c=e.internalformat,u=e.format,h=e.type,d=e.width,f=e.height;D(e),o?r.texSubImage2D(t,s,n,i,u,h,o):e.compressed?r.compressedTexSubImage2D(t,s,n,i,c,d,f,l):e.needsCopy?(a(),r.copyTexSubImage2D(t,s,n,i,e.xOffset,e.yOffset,d,f)):r.texSubImage2D(t,s,n,i,d,f,u,h,l)}var L=[];function O(){return L.pop()||new T}function z(e){e.needsFree&&Ve.freeType(e.data),T.call(e),L.push(e)}function F(){_.call(this),this.genMipmaps=!1,this.mipmapHint=En,this.mipmask=0,this.images=Array(16)}function M(e,t,r){var n=e.images[0]=O();e.mipmask=1,n.width=e.width=t,n.height=e.height=r,n.channels=e.channels=4}function V(e,t){var r=null;if(ai(t))r=e.images[0]=O(),k(r,e),$(r,t),e.mipmask=1;else if(E(e,t),Array.isArray(t.mipmap))for(var n=t.mipmap,i=0;i<n.length;++i)r=e.images[i]=O(),k(r,e),r.width>>=i,r.height>>=i,$(r,n[i]),e.mipmask|=1<<i;else r=e.images[0]=O(),k(r,e),$(r,t),e.mipmask=1;k(e,e.images[0]),!e.compressed||e.internalformat!==Zr&&e.internalformat!==Kr&&e.internalformat!==Qr&&e.internalformat!==Jr||ne(e.width%4===0&&e.height%4===0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function B(e,t){for(var r=e.images,n=0;n<r.length;++n){if(!r[n])return;I(r[n],t,n)}}var H=[];function N(){var e=H.pop()||new F;_.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function P(e){for(var t=e.images,r=0;r<t.length;++r)t[r]&&z(t[r]),t[r]=null;H.push(e)}function G(){this.minFilter=xn,this.magFilter=xn,this.wrapS=mn,this.wrapT=mn,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=En}function j(e,t){if("min"in t){var r=t.min;ne.parameter(r,d),e.minFilter=d[r],Mn.indexOf(e.minFilter)>=0&&!("faces"in t)&&(e.genMipmaps=!0)}if("mag"in t){var n=t.mag;ne.parameter(n,h),e.magFilter=h[n]}var a=e.wrapS,s=e.wrapT;if("wrap"in t){var o=t.wrap;"string"===typeof o?(ne.parameter(o,u),a=s=u[o]):Array.isArray(o)&&(ne.parameter(o[0],u),ne.parameter(o[1],u),a=u[o[0]],s=u[o[1]])}else{if("wrapS"in t){var l=t.wrapS;ne.parameter(l,u),a=u[l]}if("wrapT"in t){var f=t.wrapT;ne.parameter(f,u),s=u[f]}}if(e.wrapS=a,e.wrapT=s,"anisotropic"in t){var g=t.anisotropic;ne("number"===typeof g&&g>=1&&g<=i.maxAnisotropic,"aniso samples must be between 1 and "),e.anisotropic=t.anisotropic}if("mipmap"in t){var p=!1;switch(typeof t.mipmap){case"string":ne.parameter(t.mipmap,c,"invalid mipmap hint"),e.mipmapHint=c[t.mipmap],e.genMipmaps=!0,p=!0;break;case"boolean":p=e.genMipmaps=t.mipmap;break;case"object":ne(Array.isArray(t.mipmap),"invalid mipmap type"),e.genMipmaps=!1,p=!0;break;default:ne.raise("invalid mipmap type")}p&&!("min"in t)&&(e.minFilter=Sn)}}function W(e,t){r.texParameteri(t,bn,e.minFilter),r.texParameteri(t,yn,e.magFilter),r.texParameteri(t,fn,e.wrapS),r.texParameteri(t,gn,e.wrapT),n.ext_texture_filter_anisotropic&&r.texParameteri(t,$n,e.anisotropic),e.genMipmaps&&(r.hint(kn,e.mipmapHint),r.generateMipmap(t))}var q=0,U={},X=i.maxTextureUnits,Y=Array(X).map((function(){return null}));function Z(e){_.call(this),this.mipmask=0,this.internalformat=Lr,this.id=q++,this.refCount=1,this.target=e,this.texture=r.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new G,l.profile&&(this.stats={size:0})}function K(e){r.activeTexture(Fn),r.bindTexture(e.target,e.texture)}function Q(){var e=Y[0];e?r.bindTexture(e.target,e.texture):r.bindTexture($r,null)}function J(e){var t=e.texture;ne(t,"must not double destroy texture");var n=e.unit,i=e.target;n>=0&&(r.activeTexture(Fn+n),r.bindTexture(i,null),Y[n]=null),r.deleteTexture(t),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete U[e.id],o.textureCount--}function ee(e,t){var n=new Z($r);function a(e,t){var r=n.texInfo;G.call(r);var s=N();return"number"===typeof e?M(s,0|e,"number"===typeof t?0|t:0|e):e?(ne.type(e,"object","invalid arguments to regl.texture"),j(r,e),V(s,e)):M(s,1,1),r.genMipmaps&&(s.mipmask=(s.width<<1)-1),n.mipmask=s.mipmask,k(n,s),ne.texture2D(r,s,i),n.internalformat=s.internalformat,a.width=s.width,a.height=s.height,K(n),B(s,$r),W(r,$r),Q(),P(s),l.profile&&(n.stats.size=hi(n.internalformat,n.type,s.width,s.height,r.genMipmaps,!1)),a.format=b[n.internalformat],a.type=x[n.type],a.mag=w[r.magFilter],a.min=S[r.minFilter],a.wrapS=C[r.wrapS],a.wrapT=C[r.wrapT],a}function s(e,t,r,i){ne(!!e,"must specify image data");var s=0|t,o=0|r,l=0|i,c=O();return k(c,n),c.width=0,c.height=0,$(c,e),c.width=c.width||(n.width>>l)-s,c.height=c.height||(n.height>>l)-o,ne(n.type===c.type&&n.format===c.format&&n.internalformat===c.internalformat,"incompatible format for texture.subimage"),ne(s>=0&&o>=0&&s+c.width<=n.width&&o+c.height<=n.height,"texture.subimage write out of bounds"),ne(n.mipmask&1<<l,"missing mipmap data"),ne(c.data||c.element||c.needsCopy,"missing image data"),K(n),R(c,$r,s,o,l),Q(),z(c),a}function c(e,t){var i=0|e,s=0|t||i;if(i===n.width&&s===n.height)return a;a.width=n.width=i,a.height=n.height=s,K(n);for(var o=0;n.mipmask>>o;++o){var c=i>>o,u=s>>o;if(!c||!u)break;r.texImage2D($r,o,n.format,c,u,0,n.format,n.type,null)}return Q(),l.profile&&(n.stats.size=hi(n.internalformat,n.type,i,s,!1,!1)),a}return U[n.id]=n,o.textureCount++,a(e,t),a.subimage=s,a.resize=c,a._reglType="texture2d",a._texture=n,l.profile&&(a.stats=n.stats),a.destroy=function(){n.decRef()},a}function te(e,t,n,a,s,c){var u=new Z(Ir);U[u.id]=u,o.cubeCount++;var h=new Array(6);function d(e,t,r,n,a,s){var o,c=u.texInfo;for(G.call(c),o=0;o<6;++o)h[o]=N();if("number"!==typeof e&&e)if("object"===typeof e)if(t)V(h[0],e),V(h[1],t),V(h[2],r),V(h[3],n),V(h[4],a),V(h[5],s);else if(j(c,e),E(u,e),"faces"in e){var f=e.faces;for(ne(Array.isArray(f)&&6===f.length,"cube faces must be a length 6 array"),o=0;o<6;++o)ne("object"===typeof f[o]&&!!f[o],"invalid input for cube map face"),k(h[o],u),V(h[o],f[o])}else for(o=0;o<6;++o)V(h[o],e);else ne.raise("invalid arguments to cube map");else{var g=0|e||1;for(o=0;o<6;++o)M(h[o],g,g)}for(k(u,h[0]),ne.optional((function(){i.npotTextureCube||ne(Dr(u.width)&&Dr(u.height),"your browser does not support non power or two texture dimensions")})),c.genMipmaps?u.mipmask=(h[0].width<<1)-1:u.mipmask=h[0].mipmask,ne.textureCube(u,c,h,i),u.internalformat=h[0].internalformat,d.width=h[0].width,d.height=h[0].height,K(u),o=0;o<6;++o)B(h[o],Rr+o);for(W(c,Ir),Q(),l.profile&&(u.stats.size=hi(u.internalformat,u.type,d.width,d.height,c.genMipmaps,!0)),d.format=b[u.internalformat],d.type=x[u.type],d.mag=w[c.magFilter],d.min=S[c.minFilter],d.wrapS=C[c.wrapS],d.wrapT=C[c.wrapT],o=0;o<6;++o)P(h[o]);return d}function f(e,t,r,n,i){ne(!!t,"must specify image data"),ne("number"===typeof e&&e===(0|e)&&e>=0&&e<6,"invalid face");var a=0|r,s=0|n,o=0|i,l=O();return k(l,u),l.width=0,l.height=0,$(l,t),l.width=l.width||(u.width>>o)-a,l.height=l.height||(u.height>>o)-s,ne(u.type===l.type&&u.format===l.format&&u.internalformat===l.internalformat,"incompatible format for texture.subimage"),ne(a>=0&&s>=0&&a+l.width<=u.width&&s+l.height<=u.height,"texture.subimage write out of bounds"),ne(u.mipmask&1<<o,"missing mipmap data"),ne(l.data||l.element||l.needsCopy,"missing image data"),K(u),R(l,Rr+e,a,s,o),Q(),z(l),d}function g(e){var t=0|e;if(t!==u.width){d.width=u.width=t,d.height=u.height=t,K(u);for(var n=0;n<6;++n)for(var i=0;u.mipmask>>i;++i)r.texImage2D(Rr+n,i,u.format,t>>i,t>>i,0,u.format,u.type,null);return Q(),l.profile&&(u.stats.size=hi(u.internalformat,u.type,d.width,d.height,!1,!0)),d}}return d(e,t,n,a,s,c),d.subimage=f,d.resize=g,d._reglType="textureCube",d._texture=u,l.profile&&(d.stats=u.stats),d.destroy=function(){u.decRef()},d}function re(){for(var e=0;e<X;++e)r.activeTexture(Fn+e),r.bindTexture($r,null),Y[e]=null;_t(U).forEach(J),o.cubeCount=0,o.textureCount=0}function ie(){for(var e=0;e<X;++e){var t=Y[e];t&&(t.bindCount=0,t.unit=-1,Y[e]=null)}_t(U).forEach((function(e){e.texture=r.createTexture(),r.bindTexture(e.target,e.texture);for(var t=0;t<32;++t)if(0!==(e.mipmask&1<<t))if(e.target===$r)r.texImage2D($r,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);else for(var n=0;n<6;++n)r.texImage2D(Rr+n,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);W(e.texInfo,e.target)}))}function ae(){for(var e=0;e<X;++e){var t=Y[e];t&&(t.bindCount=0,t.unit=-1,Y[e]=null),r.activeTexture(Fn+e),r.bindTexture($r,null),r.bindTexture(Ir,null)}}return t(Z.prototype,{bind:function(){var e=this;e.bindCount+=1;var t=e.unit;if(t<0){for(var n=0;n<X;++n){var i=Y[n];if(i){if(i.bindCount>0)continue;i.unit=-1}Y[n]=e,t=n;break}t>=X&&ne.raise("insufficient number of texture units"),l.profile&&o.maxTextureUnits<t+1&&(o.maxTextureUnits=t+1),e.unit=t,r.activeTexture(Fn+t),r.bindTexture(e.target,e.texture)}return t},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&J(this)}}),l.profile&&(o.getTotalTextureSize=function(){var e=0;return Object.keys(U).forEach((function(t){e+=U[t].stats.size})),e}),{create2D:ee,createCube:te,clear:re,getTexture:function(e){return null},restore:ie,refresh:ae}}Yn[Vr]=2,Yn[Br]=2,Yn[Hr]=2,Yn[qr]=4,Yn[Zr]=.5,Yn[Kr]=.5,Yn[Qr]=1,Yn[Jr]=1,Yn[en]=.5,Yn[tn]=1,Yn[rn]=1,Yn[nn]=.5,Yn[an]=.25,Yn[sn]=.5,Yn[on]=.25,Yn[ln]=.5;var fi=36161,gi=32854,pi=32855,mi=36194,vi=33189,yi=36168,bi=34041,xi=35907,wi=34836,Si=34842,Ci=34843,Ai=[];function _i(e,t,r){return Ai[e]*t*r}Ai[gi]=2,Ai[pi]=2,Ai[mi]=2,Ai[vi]=2,Ai[yi]=1,Ai[bi]=4,Ai[xi]=4,Ai[wi]=16,Ai[Si]=8,Ai[Ci]=6;var ki=function(e,t,r,n,i){var a={rgba4:gi,rgb565:mi,"rgb5 a1":pi,depth:vi,stencil:yi,"depth stencil":bi};t.ext_srgb&&(a["srgba"]=xi),t.ext_color_buffer_half_float&&(a["rgba16f"]=Si,a["rgb16f"]=Ci),t.webgl_color_buffer_float&&(a["rgba32f"]=wi);var s=[];Object.keys(a).forEach((function(e){var t=a[e];s[t]=e}));var o=0,l={};function c(e){this.id=o++,this.refCount=1,this.renderbuffer=e,this.format=gi,this.width=0,this.height=0,i.profile&&(this.stats={size:0})}function u(t){var r=t.renderbuffer;ne(r,"must not double destroy renderbuffer"),e.bindRenderbuffer(fi,null),e.deleteRenderbuffer(r),t.renderbuffer=null,t.refCount=0,delete l[t.id],n.renderbufferCount--}function h(t,o){var u=new c(e.createRenderbuffer());function h(t,n){var o=0,l=0,c=gi;if("object"===typeof t&&t){var d=t;if("shape"in d){var f=d.shape;ne(Array.isArray(f)&&f.length>=2,"invalid renderbuffer shape"),o=0|f[0],l=0|f[1]}else"radius"in d&&(o=l=0|d.radius),"width"in d&&(o=0|d.width),"height"in d&&(l=0|d.height);"format"in d&&(ne.parameter(d.format,a,"invalid renderbuffer format"),c=a[d.format])}else"number"===typeof t?(o=0|t,l="number"===typeof n?0|n:o):t?ne.raise("invalid arguments to renderbuffer constructor"):o=l=1;if(ne(o>0&&l>0&&o<=r.maxRenderbufferSize&&l<=r.maxRenderbufferSize,"invalid renderbuffer size"),o!==u.width||l!==u.height||c!==u.format)return h.width=u.width=o,h.height=u.height=l,u.format=c,e.bindRenderbuffer(fi,u.renderbuffer),e.renderbufferStorage(fi,c,o,l),ne(0===e.getError(),"invalid render buffer format"),i.profile&&(u.stats.size=_i(u.format,u.width,u.height)),h.format=s[u.format],h}function d(t,n){var a=0|t,s=0|n||a;return a===u.width&&s===u.height||(ne(a>0&&s>0&&a<=r.maxRenderbufferSize&&s<=r.maxRenderbufferSize,"invalid renderbuffer size"),h.width=u.width=a,h.height=u.height=s,e.bindRenderbuffer(fi,u.renderbuffer),e.renderbufferStorage(fi,u.format,a,s),ne(0===e.getError(),"invalid render buffer format"),i.profile&&(u.stats.size=_i(u.format,u.width,u.height))),h}return l[u.id]=u,n.renderbufferCount++,h(t,o),h.resize=d,h._reglType="renderbuffer",h._renderbuffer=u,i.profile&&(h.stats=u.stats),h.destroy=function(){u.decRef()},h}function d(){_t(l).forEach((function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(fi,t.renderbuffer),e.renderbufferStorage(fi,t.format,t.width,t.height)})),e.bindRenderbuffer(fi,null)}return c.prototype.decRef=function(){--this.refCount<=0&&u(this)},i.profile&&(n.getTotalRenderbufferSize=function(){var e=0;return Object.keys(l).forEach((function(t){e+=l[t].stats.size})),e}),{create:h,clear:function(){_t(l).forEach(u)},restore:d}},Ei=36160,Di=36161,Ti=3553,$i=34069,Ii=36064,Ri=36096,Li=36128,Oi=33306,zi=36053,Fi=36054,Mi=36055,Vi=36057,Bi=36061,Hi=36193,Ni=5121,Pi=5126,Gi=6407,ji=6408,Wi=6402,qi=[Gi,ji],Ui=[];Ui[ji]=4,Ui[Gi]=3;var Xi=[];Xi[Ni]=1,Xi[Pi]=4,Xi[Hi]=2;var Yi=32854,Zi=32855,Ki=36194,Qi=33189,Ji=36168,ea=34041,ta=35907,ra=34836,na=34842,ia=34843,aa=[Yi,Zi,Ki,ta,na,ia,ra],sa={};function oa(e,r,n,i,a,s){var o={cur:null,next:null,dirty:!1,setFBO:null},l=["rgba"],c=["rgba4","rgb565","rgb5 a1"];r.ext_srgb&&c.push("srgba"),r.ext_color_buffer_half_float&&c.push("rgba16f","rgb16f"),r.webgl_color_buffer_float&&c.push("rgba32f");var u=["uint8"];function h(e,t,r){this.target=e,this.texture=t,this.renderbuffer=r;var n=0,i=0;t?(n=t.width,i=t.height):r&&(n=r.width,i=r.height),this.width=n,this.height=i}function d(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function f(e,t,r){if(e)if(e.texture){var n=e.texture._texture,i=Math.max(1,n.width),a=Math.max(1,n.height);ne(i===t&&a===r,"inconsistent width/height for supplied texture"),n.refCount+=1}else{var s=e.renderbuffer._renderbuffer;ne(s.width===t&&s.height===r,"inconsistent width/height for renderbuffer"),s.refCount+=1}}function g(t,r){r&&(r.texture?e.framebufferTexture2D(Ei,t,r.target,r.texture._texture.texture,0):e.framebufferRenderbuffer(Ei,t,Di,r.renderbuffer._renderbuffer.renderbuffer))}function p(e){var t=Ti,r=null,n=null,i=e;"object"===typeof e&&(i=e.data,"target"in e&&(t=0|e.target)),ne.type(i,"function","invalid attachment data");var a=i._reglType;return"texture2d"===a?(r=i,ne(t===Ti)):"textureCube"===a?(r=i,ne(t>=$i&&t<$i+6,"invalid cube map target")):"renderbuffer"===a?(n=i,t=Di):ne.raise("invalid regl object for attachment"),new h(t,r,n)}function m(e,t,r,n,s){if(r){var o=i.create2D({width:e,height:t,format:n,type:s});return o._texture.refCount=0,new h(Ti,o,null)}var l=a.create({width:e,height:t,format:n});return l._renderbuffer.refCount=0,new h(Di,null,l)}function v(e){return e&&(e.texture||e.renderbuffer)}function y(e,t,r){e&&(e.texture?e.texture.resize(t,r):e.renderbuffer&&e.renderbuffer.resize(t,r),e.width=t,e.height=r)}r.oes_texture_half_float&&u.push("half float","float16"),r.oes_texture_float&&u.push("float","float32");var b=0,x={};function w(){this.id=b++,x[this.id]=this,this.framebuffer=e.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function S(e){e.colorAttachments.forEach(d),d(e.depthAttachment),d(e.stencilAttachment),d(e.depthStencilAttachment)}function C(t){var r=t.framebuffer;ne(r,"must not double destroy framebuffer"),e.deleteFramebuffer(r),t.framebuffer=null,s.framebufferCount--,delete x[t.id]}function A(t){var r;e.bindFramebuffer(Ei,t.framebuffer);var i=t.colorAttachments;for(r=0;r<i.length;++r)g(Ii+r,i[r]);for(r=i.length;r<n.maxColorAttachments;++r)e.framebufferTexture2D(Ei,Ii+r,Ti,null,0);e.framebufferTexture2D(Ei,Oi,Ti,null,0),e.framebufferTexture2D(Ei,Ri,Ti,null,0),e.framebufferTexture2D(Ei,Li,Ti,null,0),g(Ri,t.depthAttachment),g(Li,t.stencilAttachment),g(Oi,t.depthStencilAttachment);var a=e.checkFramebufferStatus(Ei);e.isContextLost()||a===zi||ne.raise("framebuffer configuration not supported, status = "+sa[a]),e.bindFramebuffer(Ei,o.next?o.next.framebuffer:null),o.cur=o.next,e.getError()}function _(e,i){var a=new w;function h(e,t){var i;ne(o.next!==a,"can not update framebuffer which is currently in use");var s=0,d=0,g=!0,y=!0,b=null,x=!0,w="rgba",C="uint8",_=1,k=null,E=null,D=null,T=!1;if("number"===typeof e)s=0|e,d=0|t||s;else if(e){ne.type(e,"object","invalid arguments for framebuffer");var $=e;if("shape"in $){var I=$.shape;ne(Array.isArray(I)&&I.length>=2,"invalid shape for framebuffer"),s=I[0],d=I[1]}else"radius"in $&&(s=d=$.radius),"width"in $&&(s=$.width),"height"in $&&(d=$.height);("color"in $||"colors"in $)&&(b=$.color||$.colors,Array.isArray(b)&&ne(1===b.length||r.webgl_draw_buffers,"multiple render targets not supported")),b||("colorCount"in $&&(_=0|$.colorCount,ne(_>0,"invalid color buffer count")),"colorTexture"in $&&(x=!!$.colorTexture,w="rgba4"),"colorType"in $&&(C=$.colorType,x?(ne(r.oes_texture_float||!("float"===C||"float32"===C),"you must enable OES_texture_float in order to use floating point framebuffer objects"),ne(r.oes_texture_half_float||!("half float"===C||"float16"===C),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):"half float"===C||"float16"===C?(ne(r.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),w="rgba16f"):"float"!==C&&"float32"!==C||(ne(r.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),w="rgba32f"),ne.oneOf(C,u,"invalid color type")),"colorFormat"in $&&(w=$.colorFormat,l.indexOf(w)>=0?x=!0:c.indexOf(w)>=0?x=!1:ne.optional((function(){x?ne.oneOf($.colorFormat,l,"invalid color format for texture"):ne.oneOf($.colorFormat,c,"invalid color format for renderbuffer")})))),("depthTexture"in $||"depthStencilTexture"in $)&&(T=!(!$.depthTexture&&!$.depthStencilTexture),ne(!T||r.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in $&&("boolean"===typeof $.depth?g=$.depth:(k=$.depth,y=!1)),"stencil"in $&&("boolean"===typeof $.stencil?y=$.stencil:(E=$.stencil,g=!1)),"depthStencil"in $&&("boolean"===typeof $.depthStencil?g=y=$.depthStencil:(D=$.depthStencil,g=!1,y=!1))}else s=d=1;var R=null,L=null,O=null,z=null;if(Array.isArray(b))R=b.map(p);else if(b)R=[p(b)];else for(R=new Array(_),i=0;i<_;++i)R[i]=m(s,d,x,w,C);ne(r.webgl_draw_buffers||R.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),ne(R.length<=n.maxColorAttachments,"too many color attachments, not supported"),s=s||R[0].width,d=d||R[0].height,k?L=p(k):g&&!y&&(L=m(s,d,T,"depth","uint32")),E?O=p(E):y&&!g&&(O=m(s,d,!1,"stencil","uint8")),D?z=p(D):!k&&!E&&y&&g&&(z=m(s,d,T,"depth stencil","depth stencil")),ne(!!k+!!E+!!D<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var F=null;for(i=0;i<R.length;++i)if(f(R[i],s,d),ne(!R[i]||R[i].texture&&qi.indexOf(R[i].texture._texture.format)>=0||R[i].renderbuffer&&aa.indexOf(R[i].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+i+" is invalid"),R[i]&&R[i].texture){var M=Ui[R[i].texture._texture.format]*Xi[R[i].texture._texture.type];null===F?F=M:ne(F===M,"all color attachments much have the same number of bits per pixel.")}return f(L,s,d),ne(!L||L.texture&&L.texture._texture.format===Wi||L.renderbuffer&&L.renderbuffer._renderbuffer.format===Qi,"invalid depth attachment for framebuffer object"),f(O,s,d),ne(!O||O.renderbuffer&&O.renderbuffer._renderbuffer.format===Ji,"invalid stencil attachment for framebuffer object"),f(z,s,d),ne(!z||z.texture&&z.texture._texture.format===ea||z.renderbuffer&&z.renderbuffer._renderbuffer.format===ea,"invalid depth-stencil attachment for framebuffer object"),S(a),a.width=s,a.height=d,a.colorAttachments=R,a.depthAttachment=L,a.stencilAttachment=O,a.depthStencilAttachment=z,h.color=R.map(v),h.depth=v(L),h.stencil=v(O),h.depthStencil=v(z),h.width=a.width,h.height=a.height,A(a),h}function d(e,t){ne(o.next!==a,"can not resize a framebuffer which is currently in use");var r=Math.max(0|e,1),n=Math.max(0|t||r,1);if(r===a.width&&n===a.height)return h;for(var i=a.colorAttachments,s=0;s<i.length;++s)y(i[s],r,n);return y(a.depthAttachment,r,n),y(a.stencilAttachment,r,n),y(a.depthStencilAttachment,r,n),a.width=h.width=r,a.height=h.height=n,A(a),h}return s.framebufferCount++,h(e,i),t(h,{resize:d,_reglType:"framebuffer",_framebuffer:a,destroy:function(){C(a),S(a)},use:function(e){o.setFBO({framebuffer:h},e)}})}function k(e){var a=Array(6);function s(e){var n;ne(a.indexOf(o.next)<0,"can not update framebuffer which is currently in use");var c,h={color:null},d=0,f=null,g="rgba",p="uint8",m=1;if("number"===typeof e)d=0|e;else if(e){ne.type(e,"object","invalid arguments for framebuffer");var v=e;if("shape"in v){var y=v.shape;ne(Array.isArray(y)&&y.length>=2,"invalid shape for framebuffer"),ne(y[0]===y[1],"cube framebuffer must be square"),d=y[0]}else"radius"in v&&(d=0|v.radius),"width"in v?(d=0|v.width,"height"in v&&ne(v.height===d,"must be square")):"height"in v&&(d=0|v.height);("color"in v||"colors"in v)&&(f=v.color||v.colors,Array.isArray(f)&&ne(1===f.length||r.webgl_draw_buffers,"multiple render targets not supported")),f||("colorCount"in v&&(m=0|v.colorCount,ne(m>0,"invalid color buffer count")),"colorType"in v&&(ne.oneOf(v.colorType,u,"invalid color type"),p=v.colorType),"colorFormat"in v&&(g=v.colorFormat,ne.oneOf(v.colorFormat,l,"invalid color format for texture"))),"depth"in v&&(h.depth=v.depth),"stencil"in v&&(h.stencil=v.stencil),"depthStencil"in v&&(h.depthStencil=v.depthStencil)}else d=1;if(f)if(Array.isArray(f))for(c=[],n=0;n<f.length;++n)c[n]=f[n];else c=[f];else{c=Array(m);var b={radius:d,format:g,type:p};for(n=0;n<m;++n)c[n]=i.createCube(b)}for(h.color=Array(c.length),n=0;n<c.length;++n){var x=c[n];ne("function"===typeof x&&"textureCube"===x._reglType,"invalid cube map"),d=d||x.width,ne(x.width===d&&x.height===d,"invalid cube map shape"),h.color[n]={target:$i,data:c[n]}}for(n=0;n<6;++n){for(var w=0;w<c.length;++w)h.color[w].target=$i+n;n>0&&(h.depth=a[0].depth,h.stencil=a[0].stencil,h.depthStencil=a[0].depthStencil),a[n]?a[n](h):a[n]=_(h)}return t(s,{width:d,height:d,color:c})}function c(e){var t,r=0|e;if(ne(r>0&&r<=n.maxCubeMapSize,"invalid radius for cube fbo"),r===s.width)return s;var i=s.color;for(t=0;t<i.length;++t)i[t].resize(r);for(t=0;t<6;++t)a[t].resize(r);return s.width=s.height=r,s}return s(e),t(s,{faces:a,resize:c,_reglType:"framebufferCube",destroy:function(){a.forEach((function(e){e.destroy()}))}})}function E(){o.cur=null,o.next=null,o.dirty=!0,_t(x).forEach((function(t){t.framebuffer=e.createFramebuffer(),A(t)}))}return t(o,{getFramebuffer:function(e){if("function"===typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof w)return t}return null},create:_,createCube:k,clear:function(){_t(x).forEach(C)},restore:E})}sa[zi]="complete",sa[Fi]="incomplete attachment",sa[Vi]="incomplete dimensions",sa[Mi]="incomplete, missing attachment",sa[Bi]="unsupported";var la=5126,ca=34962,ua=34963,ha=["attributes","elements","offset","count","primitive","instances"];function da(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=la,this.offset=0,this.stride=0,this.divisor=0}function fa(t,r,n,i,a,s,o){for(var l=n.maxAttributes,c=new Array(l),u=0;u<l;++u)c[u]=new da;var h=0,d={},f={Record:da,scope:{},state:c,currentVAO:null,targetVAO:null,restore:p()?S:function(){},createVAO:C,getVAO:v,destroyBuffer:g,setVAO:p()?y:b,clear:p()?x:function(){}};function g(e){for(var r=0;r<c.length;++r){var n=c[r];n.buffer===e&&(t.disableVertexAttribArray(r),n.buffer=null)}}function p(){return r.oes_vertex_array_object}function m(){return r.angle_instanced_arrays}function v(e){return"function"===typeof e&&e._vao?e._vao:null}function y(e){if(e!==f.currentVAO){var t=p();e?t.bindVertexArrayOES(e.vao):t.bindVertexArrayOES(null),f.currentVAO=e}}function b(e){if(e!==f.currentVAO){if(e)e.bindAttrs();else{for(var r=m(),n=0;n<c.length;++n){var i=c[n];i.buffer?(t.enableVertexAttribArray(n),i.buffer.bind(),t.vertexAttribPointer(n,i.size,i.type,i.normalized,i.stride,i.offfset),r&&i.divisor&&r.vertexAttribDivisorANGLE(n,i.divisor)):(t.disableVertexAttribArray(n),t.vertexAttrib4f(n,i.x,i.y,i.z,i.w))}o.elements?t.bindBuffer(ua,o.elements.buffer.buffer):t.bindBuffer(ua,null)}f.currentVAO=e}}function x(){_t(d).forEach((function(e){e.destroy()}))}function w(){this.id=++h,this.attributes=[],this.elements=null,this.ownsElements=!1,this.count=0,this.offset=0,this.instances=-1,this.primitive=4;var e=p();this.vao=e?e.createVertexArrayOES():null,d[this.id]=this,this.buffers=[]}function S(){var e=p();e&&_t(d).forEach((function(e){e.refresh()}))}function C(t){var n=new w;function o(t){var i;if(Array.isArray(t))i=t,n.elements&&n.ownsElements&&n.elements.destroy(),n.elements=null,n.ownsElements=!1,n.offset=0,n.count=0,n.instances=-1,n.primitive=4;else{if(ne("object"===typeof t,"invalid arguments for create vao"),ne("attributes"in t,"must specify attributes for vao"),t.elements){var c=t.elements;n.ownsElements?"function"===typeof c&&"elements"===c._reglType?(n.elements.destroy(),n.ownsElements=!1):(n.elements(c),n.ownsElements=!1):s.getElements(t.elements)?(n.elements=t.elements,n.ownsElements=!1):(n.elements=s.create(t.elements),n.ownsElements=!0)}else n.elements=null,n.ownsElements=!1;i=t.attributes,n.offset=0,n.count=-1,n.instances=-1,n.primitive=4,n.elements&&(n.count=n.elements._elements.vertCount,n.primitive=n.elements._elements.primType),"offset"in t&&(n.offset=0|t.offset),"count"in t&&(n.count=0|t.count),"instances"in t&&(n.instances=0|t.instances),"primitive"in t&&(ne(t.primitive in cr,"bad primitive type: "+t.primitive),n.primitive=cr[t.primitive]),ne.optional((()=>{for(var e=Object.keys(t),r=0;r<e.length;++r)ne(ha.indexOf(e[r])>=0,'invalid option for vao: "'+e[r]+'" valid options are '+ha)})),ne(Array.isArray(i),"attributes must be an array")}ne(i.length<l,"too many attributes"),ne(i.length>0,"must specify at least one attribute");var u={},h=n.attributes;h.length=i.length;for(var d=0;d<i.length;++d){var f,g=i[d],p=h[d]=new da,m=g.data||g;if(Array.isArray(m)||e(m)||At(m))n.buffers[d]&&(f=n.buffers[d],e(m)&&f._buffer.byteLength>=m.byteLength?f.subdata(m):(f.destroy(),n.buffers[d]=null)),n.buffers[d]||(f=n.buffers[d]=a.create(g,ca,!1,!0)),p.buffer=a.getBuffer(f),p.size=0|p.buffer.dimension,p.normalized=!1,p.type=p.buffer.dtype,p.offset=0,p.stride=0,p.divisor=0,p.state=1,u[d]=1;else a.getBuffer(g)?(p.buffer=a.getBuffer(g),p.size=0|p.buffer.dimension,p.normalized=!1,p.type=p.buffer.dtype,p.offset=0,p.stride=0,p.divisor=0,p.state=1):a.getBuffer(g.buffer)?(p.buffer=a.getBuffer(g.buffer),p.size=0|(+g.size||p.buffer.dimension),p.normalized=!!g.normalized||!1,"type"in g?(ne.parameter(g.type,Pt,"invalid buffer type"),p.type=Pt[g.type]):p.type=p.buffer.dtype,p.offset=0|(g.offset||0),p.stride=0|(g.stride||0),p.divisor=0|(g.divisor||0),p.state=1,ne(p.size>=1&&p.size<=4,"size must be between 1 and 4"),ne(p.offset>=0,"invalid offset"),ne(p.stride>=0&&p.stride<=255,"stride must be between 0 and 255"),ne(p.divisor>=0,"divisor must be positive"),ne(!p.divisor||!!r.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in g?(ne(d>0,"first attribute must not be a constant"),p.x=+g.x||0,p.y=+g.y||0,p.z=+g.z||0,p.w=+g.w||0,p.state=2):ne(!1,"invalid attribute spec for location "+d)}for(var v=0;v<n.buffers.length;++v)!u[v]&&n.buffers[v]&&(n.buffers[v].destroy(),n.buffers[v]=null);return n.refresh(),o}return i.vaoCount+=1,o.destroy=function(){for(var e=0;e<n.buffers.length;++e)n.buffers[e]&&n.buffers[e].destroy();n.buffers.length=0,n.ownsElements&&(n.elements.destroy(),n.elements=null,n.ownsElements=!1),n.destroy()},o._vao=n,o._reglType="vao",o(t)}return w.prototype.bindAttrs=function(){for(var e=m(),r=this.attributes,n=0;n<r.length;++n){var i=r[n];i.buffer?(t.enableVertexAttribArray(n),t.bindBuffer(ca,i.buffer.buffer),t.vertexAttribPointer(n,i.size,i.type,i.normalized,i.stride,i.offset),e&&i.divisor&&e.vertexAttribDivisorANGLE(n,i.divisor)):(t.disableVertexAttribArray(n),t.vertexAttrib4f(n,i.x,i.y,i.z,i.w))}for(var a=r.length;a<l;++a)t.disableVertexAttribArray(a);var o=s.getElements(this.elements);o?t.bindBuffer(ua,o.buffer.buffer):t.bindBuffer(ua,null)},w.prototype.refresh=function(){var e=p();e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),f.currentVAO=null,e.bindVertexArrayOES(null))},w.prototype.destroy=function(){if(this.vao){var e=p();this===f.currentVAO&&(f.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),d[this.id]&&(delete d[this.id],i.vaoCount-=1)},f}var ga=35632,pa=35633,ma=35718,va=35721;function ya(e,r,n,i){var a={},s={};function o(e,t,r,n){this.name=e,this.id=t,this.location=r,this.info=n}function l(e,t){for(var r=0;r<e.length;++r)if(e[r].id===t.id)return void(e[r].location=t.location);e.push(t)}function c(t,n,i){var o=t===ga?a:s,l=o[n];if(!l){var c=r.str(n);l=e.createShader(t),e.shaderSource(l,c),e.compileShader(l),ne.shaderError(e,l,c,t,i),o[n]=l}return l}var u={},h=[],d=0;function f(e,t){this.id=d++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,i.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function g(t,n,a){var s,u,h=c(ga,t.fragId),d=c(pa,t.vertId),f=t.program=e.createProgram();if(e.attachShader(f,h),e.attachShader(f,d),a)for(s=0;s<a.length;++s){var g=a[s];e.bindAttribLocation(f,g[0],g[1])}e.linkProgram(f),ne.linkError(e,f,r.str(t.fragId),r.str(t.vertId),n);var p=e.getProgramParameter(f,ma);i.profile&&(t.stats.uniformsCount=p);var m=t.uniforms;for(s=0;s<p;++s)if(u=e.getActiveUniform(f,s),u)if(u.size>1)for(var v=0;v<u.size;++v){var y=u.name.replace("[0]","["+v+"]");l(m,new o(y,r.id(y),e.getUniformLocation(f,y),u))}else l(m,new o(u.name,r.id(u.name),e.getUniformLocation(f,u.name),u));var b=e.getProgramParameter(f,va);i.profile&&(t.stats.attributesCount=b);var x=t.attributes;for(s=0;s<b;++s)u=e.getActiveAttrib(f,s),u&&l(x,new o(u.name,r.id(u.name),e.getAttribLocation(f,u.name),u))}function p(){a={},s={};for(var e=0;e<h.length;++e)g(h[e],null,h[e].attributes.map((function(e){return[e.location,e.name]})))}return i.profile&&(n.getMaxUniformsCount=function(){var e=0;return h.forEach((function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)})),e},n.getMaxAttributesCount=function(){var e=0;return h.forEach((function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)})),e}),{clear:function(){var t=e.deleteShader.bind(e);_t(a).forEach(t),a={},_t(s).forEach(t),s={},h.forEach((function(t){e.deleteProgram(t.program)})),h.length=0,u={},n.shaderCount=0},program:function(r,i,o,l){ne.command(r>=0,"missing vertex shader",o),ne.command(i>=0,"missing fragment shader",o);var c=u[i];c||(c=u[i]={});var d=c[r];if(d&&(d.refCount++,!l))return d;var p=new f(i,r);return n.shaderCount++,g(p,o,l),d||(c[r]=p),h.push(p),t(p,{destroy:function(){if(p.refCount--,p.refCount<=0){e.deleteProgram(p.program);var t=h.indexOf(p);h.splice(t,1),n.shaderCount--}c[p.vertId].refCount<=0&&(e.deleteShader(s[p.vertId]),delete s[p.vertId],delete u[p.fragId][p.vertId]),Object.keys(u[p.fragId]).length||(e.deleteShader(a[p.fragId]),delete a[p.fragId],delete u[p.fragId])}})},restore:p,shader:c,frag:-1,vert:-1}}var ba=6408,xa=5121,wa=3333,Sa=5126;function Ca(t,r,n,i,a,s,o){function l(l){var c;null===r.next?(ne(a.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),c=xa):(ne(null!==r.next.colorAttachments[0].texture,"You cannot read from a renderbuffer"),c=r.next.colorAttachments[0].texture._texture.type,ne.optional((function(){s.oes_texture_float?(ne(c===xa||c===Sa,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),c===Sa&&ne(o.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):ne(c===xa,"Reading from a framebuffer is only allowed for the type 'uint8'")})));var u=0,h=0,d=i.framebufferWidth,f=i.framebufferHeight,g=null;e(l)?g=l:l&&(ne.type(l,"object","invalid arguments to regl.read()"),u=0|l.x,h=0|l.y,ne(u>=0&&u<i.framebufferWidth,"invalid x offset for regl.read"),ne(h>=0&&h<i.framebufferHeight,"invalid y offset for regl.read"),d=0|(l.width||i.framebufferWidth-u),f=0|(l.height||i.framebufferHeight-h),g=l.data||null),g&&(c===xa?ne(g instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):c===Sa&&ne(g instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),ne(d>0&&d+u<=i.framebufferWidth,"invalid width for read pixels"),ne(f>0&&f+h<=i.framebufferHeight,"invalid height for read pixels"),n();var p=d*f*4;return g||(c===xa?g=new Uint8Array(p):c===Sa&&(g=g||new Float32Array(p))),ne.isTypedArray(g,"data buffer for regl.read() must be a typedarray"),ne(g.byteLength>=p,"data buffer for regl.read() too small"),t.pixelStorei(wa,4),t.readPixels(u,h,d,f,ba,c,g),g}function c(e){var t;return r.setFBO({framebuffer:e.framebuffer},(function(){t=l(e)})),t}function u(e){return e&&"framebuffer"in e?c(e):l(e)}return u}function Aa(e){return Array.prototype.slice.call(e)}function _a(e){return Aa(e).join("")}function ka(){var e=0,r=[],n=[];function i(t){for(var i=0;i<n.length;++i)if(n[i]===t)return r[i];var a="g"+e++;return r.push(a),n.push(t),a}function a(){var r=[];function n(){r.push.apply(r,Aa(arguments))}var i=[];function a(){var t="v"+e++;return i.push(t),arguments.length>0&&(r.push(t,"="),r.push.apply(r,Aa(arguments)),r.push(";")),t}return t(n,{def:a,toString:function(){return _a([i.length>0?"var "+i.join(",")+";":"",_a(r)])}})}function s(){var e=a(),r=a(),n=e.toString,i=r.toString;function s(t,n){r(t,n,"=",e.def(t,n),";")}return t((function(){e.apply(e,Aa(arguments))}),{def:e.def,entry:e,exit:r,save:s,set:function(t,r,n){s(t,r),e(t,r,"=",n,";")},toString:function(){return n()+i()}})}function o(){var e=_a(arguments),r=s(),n=s(),i=r.toString,a=n.toString;return t(r,{then:function(){return r.apply(r,Aa(arguments)),this},else:function(){return n.apply(n,Aa(arguments)),this},toString:function(){var t=a();return t&&(t="else{"+t+"}"),_a(["if(",e,"){",i(),"}",t])}})}var l=a(),c={};function u(e,r){var n=[];function i(){var e="a"+n.length;return n.push(e),e}r=r||0;for(var a=0;a<r;++a)i();var o=s(),l=o.toString,u=c[e]=t(o,{arg:i,toString:function(){return _a(["function(",n.join(),"){",l(),"}"])}});return u}function h(){var e=['"use strict";',l,"return {"];Object.keys(c).forEach((function(t){e.push('"',t,'":',c[t].toString(),",")})),e.push("}");var t=_a(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n"),i=Function.apply(null,r.concat(t));return i.apply(null,n)}return{global:l,link:i,block:a,proc:u,scope:s,cond:o,compile:h}}var Ea="xyzw".split(""),Da=5121,Ta=1,$a=2,Ia=0,Ra=1,La=2,Oa=3,za=4,Fa=5,Ma=6,Va="dither",Ba="blend.enable",Ha="blend.color",Na="blend.equation",Pa="blend.func",Ga="depth.enable",ja="depth.func",Wa="depth.range",qa="depth.mask",Ua="colorMask",Xa="cull.enable",Ya="cull.face",Za="frontFace",Ka="lineWidth",Qa="polygonOffset.enable",Ja="polygonOffset.offset",es="sample.alpha",ts="sample.enable",rs="sample.coverage",ns="stencil.enable",is="stencil.mask",as="stencil.func",ss="stencil.opFront",os="stencil.opBack",ls="scissor.enable",cs="scissor.box",us="viewport",hs="profile",ds="framebuffer",fs="vert",gs="frag",ps="elements",ms="primitive",vs="count",ys="offset",bs="instances",xs="vao",ws="Width",Ss="Height",Cs=ds+ws,As=ds+Ss,_s=us+ws,ks=us+Ss,Es="drawingBuffer",Ds=Es+ws,Ts=Es+Ss,$s=[Pa,Na,as,ss,os,rs,us,cs,Ja],Is=34962,Rs=34963,Ls=35632,Os=35633,zs=3553,Fs=34067,Ms=2884,Vs=3042,Bs=3024,Hs=2960,Ns=2929,Ps=3089,Gs=32823,js=32926,Ws=32928,qs=5126,Us=35664,Xs=35665,Ys=35666,Zs=5124,Ks=35667,Qs=35668,Js=35669,eo=35670,to=35671,ro=35672,no=35673,io=35674,ao=35675,so=35676,oo=35678,lo=35680,co=4,uo=1028,ho=1029,fo=2304,go=2305,po=32775,mo=32776,vo=519,yo=7680,bo=0,xo=1,wo=32774,So=513,Co=36160,Ao=36064,_o={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},ko=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],Eo={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},Do={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},To={frag:Ls,vert:Os},$o={cw:fo,ccw:go};function Io(t){return Array.isArray(t)||e(t)||At(t)}function Ro(e){return e.sort((function(e,t){return e===us?-1:t===us?1:e<t?-1:1}))}function Lo(e,t,r,n){this.thisDep=e,this.contextDep=t,this.propDep=r,this.append=n}function Oo(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function zo(e){return new Lo(!1,!1,!1,e)}function Fo(e,t){var r=e.type;if(r===Ia){var n=e.data.length;return new Lo(!0,n>=1,n>=2,t)}if(r===za){var i=e.data;return new Lo(i.thisDep,i.contextDep,i.propDep,t)}if(r===Fa)return new Lo(!1,!1,!1,t);if(r===Ma){for(var a=!1,s=!1,o=!1,l=0;l<e.data.length;++l){var c=e.data[l];if(c.type===Ra)o=!0;else if(c.type===La)s=!0;else if(c.type===Oa)a=!0;else if(c.type===Ia){a=!0;var u=c.data;u>=1&&(s=!0),u>=2&&(o=!0)}else c.type===za&&(a=a||c.data.thisDep,s=s||c.data.contextDep,o=o||c.data.propDep)}return new Lo(a,s,o,t)}return new Lo(r===Oa,r===La,r===Ra,t)}var Mo=new Lo(!1,!1,!1,(function(){}));function Vo(e,r,n,i,a,s,o,l,c,u,h,d,f,g,p){var m=u.Record,v={add:32774,subtract:32778,"reverse subtract":32779};n.ext_blend_minmax&&(v.min=po,v.max=mo);var y=n.angle_instanced_arrays,b=n.webgl_draw_buffers,x=n.oes_vertex_array_object,w={dirty:!0,profile:p.profile},S={},C=[],A={},_={};function k(e){return e.replace(".","_")}function E(e,t,r){var n=k(e);C.push(e),S[n]=w[n]=!!r,A[n]=t}function D(e,t,r){var n=k(e);C.push(e),Array.isArray(r)?(w[n]=r.slice(),S[n]=r.slice()):w[n]=S[n]=r,_[n]=t}E(Va,Bs),E(Ba,Vs),D(Ha,"blendColor",[0,0,0,0]),D(Na,"blendEquationSeparate",[wo,wo]),D(Pa,"blendFuncSeparate",[xo,bo,xo,bo]),E(Ga,Ns,!0),D(ja,"depthFunc",So),D(Wa,"depthRange",[0,1]),D(qa,"depthMask",!0),D(Ua,Ua,[!0,!0,!0,!0]),E(Xa,Ms),D(Ya,"cullFace",ho),D(Za,Za,go),D(Ka,Ka,1),E(Qa,Gs),D(Ja,"polygonOffset",[0,0]),E(es,js),E(ts,Ws),D(rs,"sampleCoverage",[1,!1]),E(ns,Hs),D(is,"stencilMask",-1),D(as,"stencilFunc",[vo,0,-1]),D(ss,"stencilOpSeparate",[uo,yo,yo,yo]),D(os,"stencilOpSeparate",[ho,yo,yo,yo]),E(ls,Ps),D(cs,"scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),D(us,us,[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var T={gl:e,context:f,strings:r,next:S,current:w,draw:d,elements:s,buffer:a,shader:h,attributes:u.state,vao:u,uniforms:c,framebuffer:l,extensions:n,timer:g,isBufferArgs:Io},$={primTypes:cr,compareFuncs:Eo,blendFuncs:_o,blendEquations:v,stencilOps:Do,glTypes:Pt,orientationType:$o};ne.optional((function(){T.isArrayLike=Er})),b&&($.backBuffer=[ho],$.drawBuffer=Ee(i.maxDrawbuffers,(function(e){return 0===e?[0]:Ee(e,(function(e){return Ao+e}))})));var I=0;function R(){var e=ka(),t=e.link,n=e.global;e.id=I++,e.batchId="0";var i=t(T),a=e.shared={props:"a0"};Object.keys(T).forEach((function(e){a[e]=n.def(i,".",e)})),ne.optional((function(){e.CHECK=t(ne),e.commandStr=ne.guessCommand(),e.command=t(e.commandStr),e.assert=function(e,r,n){e("if(!(",r,"))",this.CHECK,".commandRaise(",t(n),",",this.command,");")},$.invalidBlendCombinations=ko}));var s=e.next={},o=e.current={};Object.keys(_).forEach((function(e){Array.isArray(w[e])&&(s[e]=n.def(a.next,".",e),o[e]=n.def(a.current,".",e))}));var l=e.constants={};Object.keys($).forEach((function(e){l[e]=n.def(JSON.stringify($[e]))})),e.invoke=function(r,n){switch(n.type){case Ia:var i=["this",a.context,a.props,e.batchId];return r.def(t(n.data),".call(",i.slice(0,Math.max(n.data.length+1,4)),")");case Ra:return r.def(a.props,n.data);case La:return r.def(a.context,n.data);case Oa:return r.def("this",n.data);case za:return n.data.append(e,r),n.data.ref;case Fa:return n.data.toString();case Ma:return n.data.map((function(t){return e.invoke(r,t)}))}},e.attribCache={};var c={};return e.scopeAttrib=function(e){var n=r.id(e);if(n in c)return c[n];var i=u.scope[n];i||(i=u.scope[n]=new m);var a=c[n]=t(i);return a},e}function L(e){var t,r=e.static,n=e.dynamic;if(hs in r){var i=!!r[hs];t=zo((function(e,t){return i})),t.enable=i}else if(hs in n){var a=n[hs];t=Fo(a,(function(e,t){return e.invoke(t,a)}))}return t}function O(e,t){var r=e.static,n=e.dynamic;if(ds in r){var i=r[ds];return i?(i=l.getFramebuffer(i),ne.command(i,"invalid framebuffer object"),zo((function(e,t){var r=e.link(i),n=e.shared;t.set(n.framebuffer,".next",r);var a=n.context;return t.set(a,"."+Cs,r+".width"),t.set(a,"."+As,r+".height"),r}))):zo((function(e,t){var r=e.shared;t.set(r.framebuffer,".next","null");var n=r.context;return t.set(n,"."+Cs,n+"."+Ds),t.set(n,"."+As,n+"."+Ts),"null"}))}if(ds in n){var a=n[ds];return Fo(a,(function(e,t){var r=e.invoke(t,a),n=e.shared,i=n.framebuffer,s=t.def(i,".getFramebuffer(",r,")");ne.optional((function(){e.assert(t,"!"+r+"||"+s,"invalid framebuffer object")})),t.set(i,".next",s);var o=n.context;return t.set(o,"."+Cs,s+"?"+s+".width:"+o+"."+Ds),t.set(o,"."+As,s+"?"+s+".height:"+o+"."+Ts),s}))}return null}function z(e,t,r){var n=e.static,i=e.dynamic;function a(e){if(e in n){var a=n[e];ne.commandType(a,"object","invalid "+e,r.commandStr);var s,o,l=!0,c=0|a.x,u=0|a.y;return"width"in a?(s=0|a.width,ne.command(s>=0,"invalid "+e,r.commandStr)):l=!1,"height"in a?(o=0|a.height,ne.command(o>=0,"invalid "+e,r.commandStr)):l=!1,new Lo(!l&&t&&t.thisDep,!l&&t&&t.contextDep,!l&&t&&t.propDep,(function(e,t){var r=e.shared.context,n=s;"width"in a||(n=t.def(r,".",Cs,"-",c));var i=o;return"height"in a||(i=t.def(r,".",As,"-",u)),[c,u,n,i]}))}if(e in i){var h=i[e],d=Fo(h,(function(t,r){var n=t.invoke(r,h);ne.optional((function(){t.assert(r,n+"&&typeof "+n+'==="object"',"invalid "+e)}));var i=t.shared.context,a=r.def(n,".x|0"),s=r.def(n,".y|0"),o=r.def('"width" in ',n,"?",n,".width|0:","(",i,".",Cs,"-",a,")"),l=r.def('"height" in ',n,"?",n,".height|0:","(",i,".",As,"-",s,")");return ne.optional((function(){t.assert(r,o+">=0&&"+l+">=0","invalid "+e)})),[a,s,o,l]}));return t&&(d.thisDep=d.thisDep||t.thisDep,d.contextDep=d.contextDep||t.contextDep,d.propDep=d.propDep||t.propDep),d}return t?new Lo(t.thisDep,t.contextDep,t.propDep,(function(e,t){var r=e.shared.context;return[0,0,t.def(r,".",Cs),t.def(r,".",As)]})):null}var s=a(us);if(s){var o=s;s=new Lo(s.thisDep,s.contextDep,s.propDep,(function(e,t){var r=o.append(e,t),n=e.shared.context;return t.set(n,"."+_s,r[2]),t.set(n,"."+ks,r[3]),r}))}return{viewport:s,scissor_box:a(cs)}}function F(e,t){var r=e.static,n="string"===typeof r[gs]&&"string"===typeof r[fs];if(n){if(Object.keys(t.dynamic).length>0)return null;var i=t.static,a=Object.keys(i);if(a.length>0&&"number"===typeof i[a[0]]){for(var s=[],o=0;o<a.length;++o)ne("number"===typeof i[a[o]],"must specify all vertex attribute locations when using vaos"),s.push([0|i[a[o]],a[o]]);return s}}return null}function M(e,t,n){var i=e.static,a=e.dynamic;function s(e){if(e in i){var t=r.id(i[e]);ne.optional((function(){h.shader(To[e],t,ne.guessCommand())}));var n=zo((function(){return t}));return n.id=t,n}if(e in a){var s=a[e];return Fo(s,(function(t,r){var n=t.invoke(r,s),i=r.def(t.shared.strings,".id(",n,")");return ne.optional((function(){r(t.shared.shader,".shader(",To[e],",",i,",",t.command,");")})),i}))}return null}var o,l=s(gs),c=s(fs),u=null;return Oo(l)&&Oo(c)?(u=h.program(c.id,l.id,null,n),o=zo((function(e,t){return e.link(u)}))):o=new Lo(l&&l.thisDep||c&&c.thisDep,l&&l.contextDep||c&&c.contextDep,l&&l.propDep||c&&c.propDep,(function(e,t){var r,n,i=e.shared.shader;r=l?l.append(e,t):t.def(i,".",gs),n=c?c.append(e,t):t.def(i,".",fs);var a=i+".program("+n+","+r;return ne.optional((function(){a+=","+e.command})),t.def(a+")")})),{frag:l,vert:c,progVar:o,program:u}}function V(e,t){var r=e.static,n=e.dynamic,i={},a=!1;function o(){if(xs in r){var e=r[xs];return null!==e&&null===u.getVAO(e)&&(e=u.createVAO(e)),a=!0,i.vao=e,zo((function(t){var r=u.getVAO(e);return r?t.link(r):"null"}))}if(xs in n){a=!0;var t=n[xs];return Fo(t,(function(e,r){var n=e.invoke(r,t);return r.def(e.shared.vao+".getVAO("+n+")")}))}return null}var l=o(),c=!1;function h(){if(ps in r){var e=r[ps];if(i.elements=e,Io(e)){var o=i.elements=s.create(e,!0);e=s.getElements(o),c=!0}else e&&(e=s.getElements(e),c=!0,ne.command(e,"invalid elements",t.commandStr));var u=zo((function(t,r){if(e){var n=t.link(e);return t.ELEMENTS=n,n}return t.ELEMENTS=null,null}));return u.value=e,u}if(ps in n){c=!0;var h=n[ps];return Fo(h,(function(e,t){var r=e.shared,n=r.isBufferArgs,i=r.elements,a=e.invoke(t,h),s=t.def("null"),o=t.def(n,"(",a,")"),l=e.cond(o).then(s,"=",i,".createStream(",a,");").else(s,"=",i,".getElements(",a,");");return ne.optional((function(){e.assert(l.else,"!"+a+"||"+s,"invalid elements")})),t.entry(l),t.exit(e.cond(o).then(i,".destroyStream(",s,");")),e.ELEMENTS=s,s}))}return a?new Lo(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.elements+".getElements("+e.shared.vao+".currentVAO.elements):null")})):null}var d=h();function f(){if(ms in r){var e=r[ms];return i.primitive=e,ne.commandParameter(e,cr,"invalid primitve",t.commandStr),zo((function(t,r){return cr[e]}))}if(ms in n){var s=n[ms];return Fo(s,(function(e,t){var r=e.constants.primTypes,n=e.invoke(t,s);return ne.optional((function(){e.assert(t,n+" in "+r,"invalid primitive, must be one of "+Object.keys(cr))})),t.def(r,"[",n,"]")}))}return c?Oo(d)?d.value?zo((function(e,t){return t.def(e.ELEMENTS,".primType")})):zo((function(){return co})):new Lo(d.thisDep,d.contextDep,d.propDep,(function(e,t){var r=e.ELEMENTS;return t.def(r,"?",r,".primType:",co)})):a?new Lo(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.primitive:"+co)})):null}function g(e,s){if(e in r){var o=0|r[e];return s?i.offset=o:i.instances=o,ne.command(!s||o>=0,"invalid "+e,t.commandStr),zo((function(e,t){return s&&(e.OFFSET=o),o}))}if(e in n){var u=n[e];return Fo(u,(function(t,r){var n=t.invoke(r,u);return s&&(t.OFFSET=n,ne.optional((function(){t.assert(r,n+">=0","invalid "+e)}))),n}))}if(s){if(c)return zo((function(e,t){return e.OFFSET=0,0}));if(a)return new Lo(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.offset:0")}))}else if(a)return new Lo(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.instances:-1")}));return null}var p=g(ys,!0);function m(){if(vs in r){var e=0|r[vs];return i.count=e,ne.command("number"===typeof e&&e>=0,"invalid vertex count",t.commandStr),zo((function(){return e}))}if(vs in n){var s=n[vs];return Fo(s,(function(e,t){var r=e.invoke(t,s);return ne.optional((function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">=0&&"+r+"===("+r+"|0)","invalid vertex count")})),r}))}if(c){if(Oo(d)){if(d)return p?new Lo(p.thisDep,p.contextDep,p.propDep,(function(e,t){var r=t.def(e.ELEMENTS,".vertCount-",e.OFFSET);return ne.optional((function(){e.assert(t,r+">=0","invalid vertex offset/element buffer too small")})),r})):zo((function(e,t){return t.def(e.ELEMENTS,".vertCount")}));var o=zo((function(){return-1}));return ne.optional((function(){o.MISSING=!0})),o}var u=new Lo(d.thisDep||p.thisDep,d.contextDep||p.contextDep,d.propDep||p.propDep,(function(e,t){var r=e.ELEMENTS;return e.OFFSET?t.def(r,"?",r,".vertCount-",e.OFFSET,":-1"):t.def(r,"?",r,".vertCount:-1")}));return ne.optional((function(){u.DYNAMIC=!0})),u}if(a){var h=new Lo(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao,".currentVAO?",e.shared.vao,".currentVAO.count:-1")}));return h}return null}var v=f(),y=m(),b=g(bs,!1);return{elements:d,primitive:v,count:y,instances:b,offset:p,vao:l,vaoActive:a,elementsActive:c,static:i}}function B(e,t){var r=e.static,n=e.dynamic,a={};return C.forEach((function(e){var s=k(e);function o(t,i){if(e in r){var o=t(r[e]);a[s]=zo((function(){return o}))}else if(e in n){var l=n[e];a[s]=Fo(l,(function(e,t){return i(e,t,e.invoke(t,l))}))}}switch(e){case Xa:case Ba:case Va:case ns:case Ga:case ls:case Qa:case es:case ts:case qa:return o((function(r){return ne.commandType(r,"boolean",e,t.commandStr),r}),(function(t,r,n){return ne.optional((function(){t.assert(r,"typeof "+n+'==="boolean"',"invalid flag "+e,t.commandStr)})),n}));case ja:return o((function(r){return ne.commandParameter(r,Eo,"invalid "+e,t.commandStr),Eo[r]}),(function(t,r,n){var i=t.constants.compareFuncs;return ne.optional((function(){t.assert(r,n+" in "+i,"invalid "+e+", must be one of "+Object.keys(Eo))})),r.def(i,"[",n,"]")}));case Wa:return o((function(e){return ne.command(Er(e)&&2===e.length&&"number"===typeof e[0]&&"number"===typeof e[1]&&e[0]<=e[1],"depth range is 2d array",t.commandStr),e}),(function(e,t,r){ne.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===2&&typeof "+r+'[0]==="number"&&typeof '+r+'[1]==="number"&&'+r+"[0]<="+r+"[1]","depth range must be a 2d array")}));var n=t.def("+",r,"[0]"),i=t.def("+",r,"[1]");return[n,i]}));case Pa:return o((function(e){ne.commandType(e,"object","blend.func",t.commandStr);var r="srcRGB"in e?e.srcRGB:e.src,n="srcAlpha"in e?e.srcAlpha:e.src,i="dstRGB"in e?e.dstRGB:e.dst,a="dstAlpha"in e?e.dstAlpha:e.dst;return ne.commandParameter(r,_o,s+".srcRGB",t.commandStr),ne.commandParameter(n,_o,s+".srcAlpha",t.commandStr),ne.commandParameter(i,_o,s+".dstRGB",t.commandStr),ne.commandParameter(a,_o,s+".dstAlpha",t.commandStr),ne.command(-1===ko.indexOf(r+", "+i),"unallowed blending combination (srcRGB, dstRGB) = ("+r+", "+i+")",t.commandStr),[_o[r],_o[i],_o[n],_o[a]]}),(function(t,r,n){var i=t.constants.blendFuncs;function a(a,s){var o=r.def('"',a,s,'" in ',n,"?",n,".",a,s,":",n,".",a);return ne.optional((function(){t.assert(r,o+" in "+i,"invalid "+e+"."+a+s+", must be one of "+Object.keys(_o))})),o}ne.optional((function(){t.assert(r,n+"&&typeof "+n+'==="object"',"invalid blend func, must be an object")}));var s=a("src","RGB"),o=a("dst","RGB");ne.optional((function(){var e=t.constants.invalidBlendCombinations;t.assert(r,e+".indexOf("+s+'+", "+'+o+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")}));var l=r.def(i,"[",s,"]"),c=r.def(i,"[",a("src","Alpha"),"]"),u=r.def(i,"[",o,"]"),h=r.def(i,"[",a("dst","Alpha"),"]");return[l,u,c,h]}));case Na:return o((function(r){return"string"===typeof r?(ne.commandParameter(r,v,"invalid "+e,t.commandStr),[v[r],v[r]]):"object"===typeof r?(ne.commandParameter(r.rgb,v,e+".rgb",t.commandStr),ne.commandParameter(r.alpha,v,e+".alpha",t.commandStr),[v[r.rgb],v[r.alpha]]):void ne.commandRaise("invalid blend.equation",t.commandStr)}),(function(t,r,n){var i=t.constants.blendEquations,a=r.def(),s=r.def(),o=t.cond("typeof ",n,'==="string"');return ne.optional((function(){function r(e,r,n){t.assert(e,n+" in "+i,"invalid "+r+", must be one of "+Object.keys(v))}r(o.then,e,n),t.assert(o.else,n+"&&typeof "+n+'==="object"',"invalid "+e),r(o.else,e+".rgb",n+".rgb"),r(o.else,e+".alpha",n+".alpha")})),o.then(a,"=",s,"=",i,"[",n,"];"),o.else(a,"=",i,"[",n,".rgb];",s,"=",i,"[",n,".alpha];"),r(o),[a,s]}));case Ha:return o((function(e){return ne.command(Er(e)&&4===e.length,"blend.color must be a 4d array",t.commandStr),Ee(4,(function(t){return+e[t]}))}),(function(e,t,r){return ne.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===4","blend.color must be a 4d array")})),Ee(4,(function(e){return t.def("+",r,"[",e,"]")}))}));case is:return o((function(e){return ne.commandType(e,"number",s,t.commandStr),0|e}),(function(e,t,r){return ne.optional((function(){e.assert(t,"typeof "+r+'==="number"',"invalid stencil.mask")})),t.def(r,"|0")}));case as:return o((function(r){ne.commandType(r,"object",s,t.commandStr);var n=r.cmp||"keep",i=r.ref||0,a="mask"in r?r.mask:-1;return ne.commandParameter(n,Eo,e+".cmp",t.commandStr),ne.commandType(i,"number",e+".ref",t.commandStr),ne.commandType(a,"number",e+".mask",t.commandStr),[Eo[n],i,a]}),(function(e,t,r){var n=e.constants.compareFuncs;ne.optional((function(){function i(){e.assert(t,Array.prototype.join.call(arguments,""),"invalid stencil.func")}i(r+"&&typeof ",r,'==="object"'),i('!("cmp" in ',r,")||(",r,".cmp in ",n,")")}));var i=t.def('"cmp" in ',r,"?",n,"[",r,".cmp]",":",yo),a=t.def(r,".ref|0"),s=t.def('"mask" in ',r,"?",r,".mask|0:-1");return[i,a,s]}));case ss:case os:return o((function(r){ne.commandType(r,"object",s,t.commandStr);var n=r.fail||"keep",i=r.zfail||"keep",a=r.zpass||"keep";return ne.commandParameter(n,Do,e+".fail",t.commandStr),ne.commandParameter(i,Do,e+".zfail",t.commandStr),ne.commandParameter(a,Do,e+".zpass",t.commandStr),[e===os?ho:uo,Do[n],Do[i],Do[a]]}),(function(t,r,n){var i=t.constants.stencilOps;function a(a){return ne.optional((function(){t.assert(r,'!("'+a+'" in '+n+")||("+n+"."+a+" in "+i+")","invalid "+e+"."+a+", must be one of "+Object.keys(Do))})),r.def('"',a,'" in ',n,"?",i,"[",n,".",a,"]:",yo)}return ne.optional((function(){t.assert(r,n+"&&typeof "+n+'==="object"',"invalid "+e)})),[e===os?ho:uo,a("fail"),a("zfail"),a("zpass")]}));case Ja:return o((function(e){ne.commandType(e,"object",s,t.commandStr);var r=0|e.factor,n=0|e.units;return ne.commandType(r,"number",s+".factor",t.commandStr),ne.commandType(n,"number",s+".units",t.commandStr),[r,n]}),(function(t,r,n){ne.optional((function(){t.assert(r,n+"&&typeof "+n+'==="object"',"invalid "+e)}));var i=r.def(n,".factor|0"),a=r.def(n,".units|0");return[i,a]}));case Ya:return o((function(e){var r=0;return"front"===e?r=uo:"back"===e&&(r=ho),ne.command(!!r,s,t.commandStr),r}),(function(e,t,r){return ne.optional((function(){e.assert(t,r+'==="front"||'+r+'==="back"',"invalid cull.face")})),t.def(r,'==="front"?',uo,":",ho)}));case Ka:return o((function(e){return ne.command("number"===typeof e&&e>=i.lineWidthDims[0]&&e<=i.lineWidthDims[1],"invalid line width, must be a positive number between "+i.lineWidthDims[0]+" and "+i.lineWidthDims[1],t.commandStr),e}),(function(e,t,r){return ne.optional((function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">="+i.lineWidthDims[0]+"&&"+r+"<="+i.lineWidthDims[1],"invalid line width")})),r}));case Za:return o((function(e){return ne.commandParameter(e,$o,s,t.commandStr),$o[e]}),(function(e,t,r){return ne.optional((function(){e.assert(t,r+'==="cw"||'+r+'==="ccw"',"invalid frontFace, must be one of cw,ccw")})),t.def(r+'==="cw"?'+fo+":"+go)}));case Ua:return o((function(e){return ne.command(Er(e)&&4===e.length,"color.mask must be length 4 array",t.commandStr),e.map((function(e){return!!e}))}),(function(e,t,r){return ne.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===4","invalid color.mask")})),Ee(4,(function(e){return"!!"+r+"["+e+"]"}))}));case rs:return o((function(e){ne.command("object"===typeof e&&e,s,t.commandStr);var r="value"in e?e.value:1,n=!!e.invert;return ne.command("number"===typeof r&&r>=0&&r<=1,"sample.coverage.value must be a number between 0 and 1",t.commandStr),[r,n]}),(function(e,t,r){ne.optional((function(){e.assert(t,r+"&&typeof "+r+'==="object"',"invalid sample.coverage")}));var n=t.def('"value" in ',r,"?+",r,".value:1"),i=t.def("!!",r,".invert");return[n,i]}))}})),a}function H(e,t){var r=e.static,n=e.dynamic,i={};return Object.keys(r).forEach((function(e){var n,a=r[e];if("number"===typeof a||"boolean"===typeof a)n=zo((function(){return a}));else if("function"===typeof a){var s=a._reglType;"texture2d"===s||"textureCube"===s?n=zo((function(e){return e.link(a)})):"framebuffer"===s||"framebufferCube"===s?(ne.command(a.color.length>0,'missing color attachment for framebuffer sent to uniform "'+e+'"',t.commandStr),n=zo((function(e){return e.link(a.color[0])}))):ne.commandRaise('invalid data for uniform "'+e+'"',t.commandStr)}else Er(a)?n=zo((function(t){var r=t.global.def("[",Ee(a.length,(function(r){return ne.command("number"===typeof a[r]||"boolean"===typeof a[r],"invalid uniform "+e,t.commandStr),a[r]})),"]");return r})):ne.commandRaise('invalid or missing data for uniform "'+e+'"',t.commandStr);n.value=a,i[e]=n})),Object.keys(n).forEach((function(e){var t=n[e];i[e]=Fo(t,(function(e,r){return e.invoke(r,t)}))})),i}function N(e,t){var n=e.static,i=e.dynamic,s={};return Object.keys(n).forEach((function(e){var i=n[e],o=r.id(e),l=new m;if(Io(i))l.state=Ta,l.buffer=a.getBuffer(a.create(i,Is,!1,!0)),l.type=0;else{var c=a.getBuffer(i);if(c)l.state=Ta,l.buffer=c,l.type=0;else if(ne.command("object"===typeof i&&i,"invalid data for attribute "+e,t.commandStr),"constant"in i){var u=i.constant;l.buffer="null",l.state=$a,"number"===typeof u?l.x=u:(ne.command(Er(u)&&u.length>0&&u.length<=4,"invalid constant for attribute "+e,t.commandStr),Ea.forEach((function(e,t){t<u.length&&(l[e]=u[t])})))}else{c=Io(i.buffer)?a.getBuffer(a.create(i.buffer,Is,!1,!0)):a.getBuffer(i.buffer),ne.command(!!c,'missing buffer for attribute "'+e+'"',t.commandStr);var h=0|i.offset;ne.command(h>=0,'invalid offset for attribute "'+e+'"',t.commandStr);var d=0|i.stride;ne.command(d>=0&&d<256,'invalid stride for attribute "'+e+'", must be integer betweeen [0, 255]',t.commandStr);var f=0|i.size;ne.command(!("size"in i)||f>0&&f<=4,'invalid size for attribute "'+e+'", must be 1,2,3,4',t.commandStr);var g=!!i.normalized,p=0;"type"in i&&(ne.commandParameter(i.type,Pt,"invalid type for attribute "+e,t.commandStr),p=Pt[i.type]);var v=0|i.divisor;ne.optional((function(){"divisor"in i&&(ne.command(0===v||y,'cannot specify divisor for attribute "'+e+'", instancing not supported',t.commandStr),ne.command(v>=0,'invalid divisor for attribute "'+e+'"',t.commandStr));var r=t.commandStr,n=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(i).forEach((function(t){ne.command(n.indexOf(t)>=0,'unknown parameter "'+t+'" for attribute pointer "'+e+'" (valid parameters are '+n+")",r)}))})),l.buffer=c,l.state=Ta,l.size=f,l.normalized=g,l.type=p||c.dtype,l.offset=h,l.stride=d,l.divisor=v}}s[e]=zo((function(e,t){var r=e.attribCache;if(o in r)return r[o];var n={isStream:!1};return Object.keys(l).forEach((function(e){n[e]=l[e]})),l.buffer&&(n.buffer=e.link(l.buffer),n.type=n.type||n.buffer+".dtype"),r[o]=n,n}))})),Object.keys(i).forEach((function(e){var t=i[e];function r(r,n){var i=r.invoke(n,t),a=r.shared,s=r.constants,o=a.isBufferArgs,l=a.buffer;ne.optional((function(){r.assert(n,i+"&&(typeof "+i+'==="object"||typeof '+i+'==="function")&&('+o+"("+i+")||"+l+".getBuffer("+i+")||"+l+".getBuffer("+i+".buffer)||"+o+"("+i+'.buffer)||("constant" in '+i+"&&(typeof "+i+'.constant==="number"||'+a.isArrayLike+"("+i+".constant))))",'invalid dynamic attribute "'+e+'"')}));var c={isStream:n.def(!1)},u=new m;u.state=Ta,Object.keys(u).forEach((function(e){c[e]=n.def(""+u[e])}));var h=c.buffer,d=c.type;function f(e){n(c[e],"=",i,".",e,"|0;")}return n("if(",o,"(",i,")){",c.isStream,"=true;",h,"=",l,".createStream(",Is,",",i,");",d,"=",h,".dtype;","}else{",h,"=",l,".getBuffer(",i,");","if(",h,"){",d,"=",h,".dtype;",'}else if("constant" in ',i,"){",c.state,"=",$a,";","if(typeof "+i+'.constant === "number"){',c[Ea[0]],"=",i,".constant;",Ea.slice(1).map((function(e){return c[e]})).join("="),"=0;","}else{",Ea.map((function(e,t){return c[e]+"="+i+".constant.length>"+t+"?"+i+".constant["+t+"]:0;"})).join(""),"}}else{","if(",o,"(",i,".buffer)){",h,"=",l,".createStream(",Is,",",i,".buffer);","}else{",h,"=",l,".getBuffer(",i,".buffer);","}",d,'="type" in ',i,"?",s.glTypes,"[",i,".type]:",h,".dtype;",c.normalized,"=!!",i,".normalized;"),f("size"),f("offset"),f("stride"),f("divisor"),n("}}"),n.exit("if(",c.isStream,"){",l,".destroyStream(",h,");","}"),c}s[e]=Fo(t,r)})),s}function P(e){var t=e.static,r=e.dynamic,n={};return Object.keys(t).forEach((function(e){var r=t[e];n[e]=zo((function(e,t){return"number"===typeof r||"boolean"===typeof r?""+r:e.link(r)}))})),Object.keys(r).forEach((function(e){var t=r[e];n[e]=Fo(t,(function(e,r){return e.invoke(r,t)}))})),n}function G(e,t,r,i,a){var s=e.static,o=e.dynamic;ne.optional((function(){var e=[ds,fs,gs,ps,ms,ys,vs,bs,hs,xs].concat(C);function t(t){Object.keys(t).forEach((function(t){ne.command(e.indexOf(t)>=0,'unknown parameter "'+t+'"',a.commandStr)}))}t(s),t(o)}));var l=F(e,t),c=O(e,a),h=z(e,c,a),d=V(e,a),f=B(e,a),g=M(e,a,l);function p(e){var t=h[e];t&&(f[e]=t)}p(us),p(k(cs));var m=Object.keys(f).length>0,v={framebuffer:c,draw:d,shader:g,state:f,dirty:m,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(v.profile=L(e,a),v.uniforms=H(r,a),v.drawVAO=v.scopeVAO=d.vao,!v.drawVAO&&g.program&&!l&&n.angle_instanced_arrays&&d.static.elements){var y=!0,b=g.program.attributes.map((function(e){var r=t.static[e];return y=y&&!!r,r}));if(y&&b.length>0){var x=u.getVAO(u.createVAO({attributes:b,elements:d.static.elements}));v.drawVAO=new Lo(null,null,null,(function(e,t){return e.link(x)})),v.useVAO=!0}}return l?v.useVAO=!0:v.attributes=N(t,a),v.context=P(i,a),v}function j(e,t,r){var n=e.shared,i=n.context,a=e.scope();Object.keys(r).forEach((function(n){t.save(i,"."+n);var s=r[n],o=s.append(e,t);Array.isArray(o)?a(i,".",n,"=[",o.join(),"];"):a(i,".",n,"=",o,";")})),t(a)}function W(e,t,r,n){var i,a=e.shared,s=a.gl,o=a.framebuffer;b&&(i=t.def(a.extensions,".webgl_draw_buffers"));var l,c=e.constants,u=c.drawBuffer,h=c.backBuffer;l=r?r.append(e,t):t.def(o,".next"),n||t("if(",l,"!==",o,".cur){"),t("if(",l,"){",s,".bindFramebuffer(",Co,",",l,".framebuffer);"),b&&t(i,".drawBuffersWEBGL(",u,"[",l,".colorAttachments.length]);"),t("}else{",s,".bindFramebuffer(",Co,",null);"),b&&t(i,".drawBuffersWEBGL(",h,");"),t("}",o,".cur=",l,";"),n||t("}")}function q(e,t,r){var n=e.shared,i=n.gl,a=e.current,s=e.next,o=n.current,l=n.next,c=e.cond(o,".dirty");C.forEach((function(t){var n,u,h=k(t);if(!(h in r.state))if(h in s){n=s[h],u=a[h];var d=Ee(w[h].length,(function(e){return c.def(n,"[",e,"]")}));c(e.cond(d.map((function(e,t){return e+"!=="+u+"["+t+"]"})).join("||")).then(i,".",_[h],"(",d,");",d.map((function(e,t){return u+"["+t+"]="+e})).join(";"),";"))}else{n=c.def(l,".",h);var f=e.cond(n,"!==",o,".",h);c(f),h in A?f(e.cond(n).then(i,".enable(",A[h],");").else(i,".disable(",A[h],");"),o,".",h,"=",n,";"):f(i,".",_[h],"(",n,");",o,".",h,"=",n,";")}})),0===Object.keys(r.state).length&&c(o,".dirty=false;"),t(c)}function U(e,t,r,n){var i=e.shared,a=e.current,s=i.current,o=i.gl;Ro(Object.keys(r)).forEach((function(i){var l=r[i];if(!n||n(l)){var c=l.append(e,t);if(A[i]){var u=A[i];Oo(l)?t(o,c?".enable(":".disable(",u,");"):t(e.cond(c).then(o,".enable(",u,");").else(o,".disable(",u,");")),t(s,".",i,"=",c,";")}else if(Er(c)){var h=a[i];t(o,".",_[i],"(",c,");",c.map((function(e,t){return h+"["+t+"]="+e})).join(";"),";")}else t(o,".",_[i],"(",c,");",s,".",i,"=",c,";")}}))}function X(e,t){y&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function Y(e,t,r,n,i){var a,s,o,l=e.shared,c=e.stats,u=l.current,h=l.timer,d=r.profile;function f(){return"undefined"===typeof performance?"Date.now()":"performance.now()"}function p(e){a=t.def(),e(a,"=",f(),";"),"string"===typeof i?e(c,".count+=",i,";"):e(c,".count++;"),g&&(n?(s=t.def(),e(s,"=",h,".getNumPendingQueries();")):e(h,".beginQuery(",c,");"))}function m(e){e(c,".cpuTime+=",f(),"-",a,";"),g&&(n?e(h,".pushScopeStats(",s,",",h,".getNumPendingQueries(),",c,");"):e(h,".endQuery();"))}function v(e){var r=t.def(u,".profile");t(u,".profile=",e,";"),t.exit(u,".profile=",r,";")}if(d){if(Oo(d))return void(d.enable?(p(t),m(t.exit),v("true")):v("false"));o=d.append(e,t),v(o)}else o=t.def(u,".profile");var y=e.block();p(y),t("if(",o,"){",y,"}");var b=e.block();m(b),t.exit("if(",o,"){",b,"}")}function Z(e,t,r,n,i){var a=e.shared;function s(e){switch(e){case Us:case Ks:case to:return 2;case Xs:case Qs:case ro:return 3;case Ys:case Js:case no:return 4;default:return 1}}function o(r,n,i){var s=a.gl,o=t.def(r,".location"),l=t.def(a.attributes,"[",o,"]"),c=i.state,u=i.buffer,h=[i.x,i.y,i.z,i.w],d=["buffer","normalized","offset","stride"];function f(){t("if(!",l,".buffer){",s,".enableVertexAttribArray(",o,");}");var r,a=i.type;if(r=i.size?t.def(i.size,"||",n):n,t("if(",l,".type!==",a,"||",l,".size!==",r,"||",d.map((function(e){return l+"."+e+"!=="+i[e]})).join("||"),"){",s,".bindBuffer(",Is,",",u,".buffer);",s,".vertexAttribPointer(",[o,r,a,i.normalized,i.stride,i.offset],");",l,".type=",a,";",l,".size=",r,";",d.map((function(e){return l+"."+e+"="+i[e]+";"})).join(""),"}"),y){var c=i.divisor;t("if(",l,".divisor!==",c,"){",e.instancing,".vertexAttribDivisorANGLE(",[o,c],");",l,".divisor=",c,";}")}}function g(){t("if(",l,".buffer){",s,".disableVertexAttribArray(",o,");",l,".buffer=null;","}if(",Ea.map((function(e,t){return l+"."+e+"!=="+h[t]})).join("||"),"){",s,".vertexAttrib4f(",o,",",h,");",Ea.map((function(e,t){return l+"."+e+"="+h[t]+";"})).join(""),"}")}c===Ta?f():c===$a?g():(t("if(",c,"===",Ta,"){"),f(),t("}else{"),g(),t("}"))}n.forEach((function(n){var a,l=n.name,c=r.attributes[l];if(c){if(!i(c))return;a=c.append(e,t)}else{if(!i(Mo))return;var u=e.scopeAttrib(l);ne.optional((function(){e.assert(t,u+".state","missing attribute "+l)})),a={},Object.keys(new m).forEach((function(e){a[e]=t.def(u,".",e)}))}o(e.link(n),s(n.info.type),a)}))}function K(e,t,n,i,a,s){for(var o,l=e.shared,c=l.gl,u=0;u<i.length;++u){var h,d=i[u],f=d.name,g=d.info.type,p=n.uniforms[f],m=e.link(d),v=m+".location";if(p){if(!a(p))continue;if(Oo(p)){var y=p.value;if(ne.command(null!==y&&"undefined"!==typeof y,'missing uniform "'+f+'"',e.commandStr),g===oo||g===lo){ne.command("function"===typeof y&&(g===oo&&("texture2d"===y._reglType||"framebuffer"===y._reglType)||g===lo&&("textureCube"===y._reglType||"framebufferCube"===y._reglType)),"invalid texture for uniform "+f,e.commandStr);var b=e.link(y._texture||y.color[0]._texture);t(c,".uniform1i(",v,",",b+".bind());"),t.exit(b,".unbind();")}else if(g===io||g===ao||g===so){ne.optional((function(){ne.command(Er(y),"invalid matrix for uniform "+f,e.commandStr),ne.command(g===io&&4===y.length||g===ao&&9===y.length||g===so&&16===y.length,"invalid length for matrix uniform "+f,e.commandStr)}));var x=e.global.def("new Float32Array(["+Array.prototype.slice.call(y)+"])"),w=2;g===ao?w=3:g===so&&(w=4),t(c,".uniformMatrix",w,"fv(",v,",false,",x,");")}else{switch(g){case qs:ne.commandType(y,"number","uniform "+f,e.commandStr),o="1f";break;case Us:ne.command(Er(y)&&2===y.length,"uniform "+f,e.commandStr),o="2f";break;case Xs:ne.command(Er(y)&&3===y.length,"uniform "+f,e.commandStr),o="3f";break;case Ys:ne.command(Er(y)&&4===y.length,"uniform "+f,e.commandStr),o="4f";break;case eo:ne.commandType(y,"boolean","uniform "+f,e.commandStr),o="1i";break;case Zs:ne.commandType(y,"number","uniform "+f,e.commandStr),o="1i";break;case to:ne.command(Er(y)&&2===y.length,"uniform "+f,e.commandStr),o="2i";break;case Ks:ne.command(Er(y)&&2===y.length,"uniform "+f,e.commandStr),o="2i";break;case ro:ne.command(Er(y)&&3===y.length,"uniform "+f,e.commandStr),o="3i";break;case Qs:ne.command(Er(y)&&3===y.length,"uniform "+f,e.commandStr),o="3i";break;case no:ne.command(Er(y)&&4===y.length,"uniform "+f,e.commandStr),o="4i";break;case Js:ne.command(Er(y)&&4===y.length,"uniform "+f,e.commandStr),o="4i";break}t(c,".uniform",o,"(",v,",",Er(y)?Array.prototype.slice.call(y):y,");")}continue}h=p.append(e,t)}else{if(!a(Mo))continue;h=t.def(l.uniforms,"[",r.id(f),"]")}g===oo?(ne(!Array.isArray(h),"must specify a scalar prop for textures"),t("if(",h,"&&",h,'._reglType==="framebuffer"){',h,"=",h,".color[0];","}")):g===lo&&(ne(!Array.isArray(h),"must specify a scalar prop for cube maps"),t("if(",h,"&&",h,'._reglType==="framebufferCube"){',h,"=",h,".color[0];","}")),ne.optional((function(){function r(r,n){e.assert(t,r,'bad data or missing for uniform "'+f+'".  '+n)}function n(e){ne(!Array.isArray(h),"must not specify an array type for uniform"),r("typeof "+h+'==="'+e+'"',"invalid type, expected "+e)}function i(t,n){Array.isArray(h)?ne(h.length===t,"must have length "+t):r(l.isArrayLike+"("+h+")&&"+h+".length==="+t,"invalid vector, should have length "+t,e.commandStr)}function a(t){ne(!Array.isArray(h),"must not specify a value type"),r("typeof "+h+'==="function"&&'+h+'._reglType==="texture'+(t===zs?"2d":"Cube")+'"',"invalid texture type",e.commandStr)}switch(g){case Zs:n("number");break;case Ks:i(2,"number");break;case Qs:i(3,"number");break;case Js:i(4,"number");break;case qs:n("number");break;case Us:i(2,"number");break;case Xs:i(3,"number");break;case Ys:i(4,"number");break;case eo:n("boolean");break;case to:i(2,"boolean");break;case ro:i(3,"boolean");break;case no:i(4,"boolean");break;case io:i(4,"number");break;case ao:i(9,"number");break;case so:i(16,"number");break;case oo:a(zs);break;case lo:a(Fs);break}}));var S=1;switch(g){case oo:case lo:var C=t.def(h,"._texture");t(c,".uniform1i(",v,",",C,".bind());"),t.exit(C,".unbind();");continue;case Zs:case eo:o="1i";break;case Ks:case to:o="2i",S=2;break;case Qs:case ro:o="3i",S=3;break;case Js:case no:o="4i",S=4;break;case qs:o="1f";break;case Us:o="2f",S=2;break;case Xs:o="3f",S=3;break;case Ys:o="4f",S=4;break;case io:o="Matrix2fv";break;case ao:o="Matrix3fv";break;case so:o="Matrix4fv";break}if("M"===o.charAt(0)){t(c,".uniform",o,"(",v,",");var A=Math.pow(g-io+2,2),_=e.global.def("new Float32Array(",A,")");Array.isArray(h)?t("false,(",Ee(A,(function(e){return _+"["+e+"]="+h[e]})),",",_,")"):t("false,(Array.isArray(",h,")||",h," instanceof Float32Array)?",h,":(",Ee(A,(function(e){return _+"["+e+"]="+h+"["+e+"]"})),",",_,")"),t(");")}else if(S>1){for(var k=[],E=[],D=0;D<S;++D)Array.isArray(h)?E.push(h[D]):E.push(t.def(h+"["+D+"]")),s&&k.push(t.def());s&&t("if(!",e.batchId,"||",k.map((function(e,t){return e+"!=="+E[t]})).join("||"),"){",k.map((function(e,t){return e+"="+E[t]+";"})).join("")),t(c,".uniform",o,"(",v,",",E.join(","),");"),s&&t("}")}else{if(ne(!Array.isArray(h),"uniform value must not be an array"),s){var T=t.def();t("if(!",e.batchId,"||",T,"!==",h,"){",T,"=",h,";")}t(c,".uniform",o,"(",v,",",h,");"),s&&t("}")}}}function Q(e,t,r,n){var i=e.shared,a=i.gl,s=i.draw,o=n.draw;function l(){var l,c=o.elements,u=t;return c?((c.contextDep&&n.contextDynamic||c.propDep)&&(u=r),l=c.append(e,u),o.elementsActive&&u("if("+l+")"+a+".bindBuffer("+Rs+","+l+".buffer.buffer);")):(l=u.def(),u(l,"=",s,".",ps,";","if(",l,"){",a,".bindBuffer(",Rs,",",l,".buffer.buffer);}","else if(",i.vao,".currentVAO){",l,"=",e.shared.elements+".getElements("+i.vao,".currentVAO.elements);",x?"":"if("+l+")"+a+".bindBuffer("+Rs+","+l+".buffer.buffer);","}")),l}function c(){var i,a=o.count,l=t;return a?((a.contextDep&&n.contextDynamic||a.propDep)&&(l=r),i=a.append(e,l),ne.optional((function(){a.MISSING&&e.assert(t,"false","missing vertex count"),a.DYNAMIC&&e.assert(l,i+">=0","missing vertex count")}))):(i=l.def(s,".",vs),ne.optional((function(){e.assert(l,i+">=0","missing vertex count")}))),i}var u=l();function h(i){var a=o[i];return a?a.contextDep&&n.contextDynamic||a.propDep?a.append(e,r):a.append(e,t):t.def(s,".",i)}var d,f,g=h(ms),p=h(ys),m=c();if("number"===typeof m){if(0===m)return}else r("if(",m,"){"),r.exit("}");y&&(d=h(bs),f=e.instancing);var v=u+".type",b=o.elements&&Oo(o.elements)&&!o.vaoActive;function w(){function e(){r(f,".drawElementsInstancedANGLE(",[g,m,v,p+"<<(("+v+"-"+Da+")>>1)",d],");")}function t(){r(f,".drawArraysInstancedANGLE(",[g,p,m,d],");")}u&&"null"!==u?b?e():(r("if(",u,"){"),e(),r("}else{"),t(),r("}")):t()}function S(){function e(){r(a+".drawElements("+[g,m,v,p+"<<(("+v+"-"+Da+")>>1)"]+");")}function t(){r(a+".drawArrays("+[g,p,m]+");")}u&&"null"!==u?b?e():(r("if(",u,"){"),e(),r("}else{"),t(),r("}")):t()}y&&("number"!==typeof d||d>=0)?"string"===typeof d?(r("if(",d,">0){"),w(),r("}else if(",d,"<0){"),S(),r("}")):w():S()}function J(e,t,r,n,i){var a=R(),s=a.proc("body",i);return ne.optional((function(){a.commandStr=t.commandStr,a.command=a.link(t.commandStr)})),y&&(a.instancing=s.def(a.shared.extensions,".angle_instanced_arrays")),e(a,s,r,n),a.compile().body}function ee(e,t,r,n){X(e,t),r.useVAO?r.drawVAO?t(e.shared.vao,".setVAO(",r.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),Z(e,t,r,n.attributes,(function(){return!0}))),K(e,t,r,n.uniforms,(function(){return!0}),!1),Q(e,t,t,r)}function te(e,t){var r=e.proc("draw",1);X(e,r),j(e,r,t.context),W(e,r,t.framebuffer),q(e,r,t),U(e,r,t.state),Y(e,r,t,!1,!0);var n=t.shader.progVar.append(e,r);if(r(e.shared.gl,".useProgram(",n,".program);"),t.shader.program)ee(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var i=e.global.def("{}"),a=r.def(n,".id"),s=r.def(i,"[",a,"]");r(e.cond(s).then(s,".call(this,a0);").else(s,"=",i,"[",a,"]=",e.link((function(r){return J(ee,e,t,r,1)})),"(",n,");",s,".call(this,a0);"))}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;"),e.shared.vao&&r(e.shared.vao,".setVAO(null);")}function re(e,t,r,n){function i(){return!0}e.batchId="a1",X(e,t),Z(e,t,r,n.attributes,i),K(e,t,r,n.uniforms,i,!1),Q(e,t,t,r)}function ie(e,t,r,n){X(e,t);var i=r.contextDep,a=t.def(),s="a0",o="a1",l=t.def();e.shared.props=l,e.batchId=a;var c=e.scope(),u=e.scope();function h(e){return e.contextDep&&i||e.propDep}function d(e){return!h(e)}if(t(c.entry,"for(",a,"=0;",a,"<",o,";++",a,"){",l,"=",s,"[",a,"];",u,"}",c.exit),r.needsContext&&j(e,u,r.context),r.needsFramebuffer&&W(e,u,r.framebuffer),U(e,u,r.state,h),r.profile&&h(r.profile)&&Y(e,u,r,!1,!0),n)r.useVAO?r.drawVAO?h(r.drawVAO)?u(e.shared.vao,".setVAO(",r.drawVAO.append(e,u),");"):c(e.shared.vao,".setVAO(",r.drawVAO.append(e,c),");"):c(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(c(e.shared.vao,".setVAO(null);"),Z(e,c,r,n.attributes,d),Z(e,u,r,n.attributes,h)),K(e,c,r,n.uniforms,d,!1),K(e,u,r,n.uniforms,h,!0),Q(e,c,u,r);else{var f=e.global.def("{}"),g=r.shader.progVar.append(e,u),p=u.def(g,".id"),m=u.def(f,"[",p,"]");u(e.shared.gl,".useProgram(",g,".program);","if(!",m,"){",m,"=",f,"[",p,"]=",e.link((function(t){return J(re,e,r,t,2)})),"(",g,");}",m,".call(this,a0[",a,"],",a,");")}}function ae(e,t){var r=e.proc("batch",2);e.batchId="0",X(e,r);var n=!1,i=!0;Object.keys(t.context).forEach((function(e){n=n||t.context[e].propDep})),n||(j(e,r,t.context),i=!1);var a=t.framebuffer,s=!1;function o(e){return e.contextDep&&n||e.propDep}a?(a.propDep?n=s=!0:a.contextDep&&n&&(s=!0),s||W(e,r,a)):W(e,r,null),t.state.viewport&&t.state.viewport.propDep&&(n=!0),q(e,r,t),U(e,r,t.state,(function(e){return!o(e)})),t.profile&&o(t.profile)||Y(e,r,t,!1,"a1"),t.contextDep=n,t.needsContext=i,t.needsFramebuffer=s;var l=t.shader.progVar;if(l.contextDep&&n||l.propDep)ie(e,r,t,null);else{var c=l.append(e,r);if(r(e.shared.gl,".useProgram(",c,".program);"),t.shader.program)ie(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var u=e.global.def("{}"),h=r.def(c,".id"),d=r.def(u,"[",h,"]");r(e.cond(d).then(d,".call(this,a0,a1);").else(d,"=",u,"[",h,"]=",e.link((function(r){return J(ie,e,t,r,2)})),"(",c,");",d,".call(this,a0,a1);"))}}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;"),e.shared.vao&&r(e.shared.vao,".setVAO(null);")}function se(e,t){var n=e.proc("scope",3);e.batchId="a2";var i=e.shared,a=i.current;function s(r){var a=t.shader[r];a&&n.set(i.shader,"."+r,a.append(e,n))}j(e,n,t.context),t.framebuffer&&t.framebuffer.append(e,n),Ro(Object.keys(t.state)).forEach((function(r){var a=t.state[r],s=a.append(e,n);Er(s)?s.forEach((function(t,i){n.set(e.next[r],"["+i+"]",t)})):n.set(i.next,"."+r,s)})),Y(e,n,t,!0,!0),[ps,ys,vs,bs,ms].forEach((function(r){var a=t.draw[r];a&&n.set(i.draw,"."+r,""+a.append(e,n))})),Object.keys(t.uniforms).forEach((function(a){var s=t.uniforms[a].append(e,n);Array.isArray(s)&&(s="["+s.join()+"]"),n.set(i.uniforms,"["+r.id(a)+"]",s)})),Object.keys(t.attributes).forEach((function(r){var i=t.attributes[r].append(e,n),a=e.scopeAttrib(r);Object.keys(new m).forEach((function(e){n.set(a,"."+e,i[e])}))})),t.scopeVAO&&n.set(i.vao,".targetVAO",t.scopeVAO.append(e,n)),s(fs),s(gs),Object.keys(t.state).length>0&&(n(a,".dirty=true;"),n.exit(a,".dirty=true;")),n("a1(",e.shared.context,",a0,",e.batchId,");")}function oe(e){if("object"===typeof e&&!Er(e)){for(var t=Object.keys(e),r=0;r<t.length;++r)if(pe.isDynamic(e[t[r]]))return!0;return!1}}function le(e,t,r){var n=t.static[r];if(n&&oe(n)){var i=e.global,a=Object.keys(n),s=!1,o=!1,l=!1,c=e.global.def("{}");a.forEach((function(t){var r=n[t];if(pe.isDynamic(r)){"function"===typeof r&&(r=n[t]=pe.unbox(r));var a=Fo(r,null);s=s||a.thisDep,l=l||a.propDep,o=o||a.contextDep}else{switch(i(c,".",t,"="),typeof r){case"number":i(r);break;case"string":i('"',r,'"');break;case"object":Array.isArray(r)&&i("[",r.join(),"]");break;default:i(e.link(r));break}i(";")}})),t.dynamic[r]=new pe.DynamicVariable(za,{thisDep:s,contextDep:o,propDep:l,ref:c,append:u}),delete t.static[r]}function u(e,t){a.forEach((function(r){var i=n[r];if(pe.isDynamic(i)){var a=e.invoke(t,i);t(c,".",r,"=",a,";")}}))}}function ce(e,r,n,i,a){var s=R();s.stats=s.link(a),Object.keys(r.static).forEach((function(e){le(s,r,e)})),$s.forEach((function(t){le(s,e,t)}));var o=G(e,r,n,i,s);return te(s,o),se(s,o),ae(s,o),t(s.compile(),{destroy:function(){o.shader.program.destroy()}})}return{next:S,current:w,procs:function(){var e=R(),t=e.proc("poll"),r=e.proc("refresh"),a=e.block();t(a),r(a);var s,o=e.shared,l=o.gl,c=o.next,u=o.current;a(u,".dirty=false;"),W(e,t),W(e,r,null,!0),y&&(s=e.link(y)),n.oes_vertex_array_object&&r(e.link(n.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var h=0;h<i.maxAttributes;++h){var d=r.def(o.attributes,"[",h,"]"),f=e.cond(d,".buffer");f.then(l,".enableVertexAttribArray(",h,");",l,".bindBuffer(",Is,",",d,".buffer.buffer);",l,".vertexAttribPointer(",h,",",d,".size,",d,".type,",d,".normalized,",d,".stride,",d,".offset);").else(l,".disableVertexAttribArray(",h,");",l,".vertexAttrib4f(",h,",",d,".x,",d,".y,",d,".z,",d,".w);",d,".buffer=null;"),r(f),y&&r(s,".vertexAttribDivisorANGLE(",h,",",d,".divisor);")}return r(e.shared.vao,".currentVAO=null;",e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"),Object.keys(A).forEach((function(n){var i=A[n],s=a.def(c,".",n),o=e.block();o("if(",s,"){",l,".enable(",i,")}else{",l,".disable(",i,")}",u,".",n,"=",s,";"),r(o),t("if(",s,"!==",u,".",n,"){",o,"}")})),Object.keys(_).forEach((function(n){var i,s,o=_[n],h=w[n],d=e.block();if(d(l,".",o,"("),Er(h)){var f=h.length;i=e.global.def(c,".",n),s=e.global.def(u,".",n),d(Ee(f,(function(e){return i+"["+e+"]"})),");",Ee(f,(function(e){return s+"["+e+"]="+i+"["+e+"];"})).join("")),t("if(",Ee(f,(function(e){return i+"["+e+"]!=="+s+"["+e+"]"})).join("||"),"){",d,"}")}else i=a.def(c,".",n),s=a.def(u,".",n),d(i,");",u,".",n,"=",i,";"),t("if(",i,"!==",s,"){",d,"}");r(d)})),e.compile()}(),compile:ce}}function Bo(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var Ho=34918,No=34919,Po=35007,Go=function(e,t){if(!t.ext_disjoint_timer_query)return null;var r=[];function n(){return r.pop()||t.ext_disjoint_timer_query.createQueryEXT()}function i(e){r.push(e)}var a=[];function s(e){var r=n();t.ext_disjoint_timer_query.beginQueryEXT(Po,r),a.push(r),f(a.length-1,a.length,e)}function o(){t.ext_disjoint_timer_query.endQueryEXT(Po)}function l(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var c=[];function u(){return c.pop()||new l}function h(e){c.push(e)}var d=[];function f(e,t,r){var n=u();n.startQueryIndex=e,n.endQueryIndex=t,n.sum=0,n.stats=r,d.push(n)}var g=[],p=[];function m(){var e,r,n=a.length;if(0!==n){p.length=Math.max(p.length,n+1),g.length=Math.max(g.length,n+1),g[0]=0,p[0]=0;var s=0;for(e=0,r=0;r<a.length;++r){var o=a[r];t.ext_disjoint_timer_query.getQueryObjectEXT(o,No)?(s+=t.ext_disjoint_timer_query.getQueryObjectEXT(o,Ho),i(o)):a[e++]=o,g[r+1]=s,p[r+1]=e}for(a.length=e,e=0,r=0;r<d.length;++r){var l=d[r],c=l.startQueryIndex,u=l.endQueryIndex;l.sum+=g[u]-g[c];var f=p[c],m=p[u];m===f?(l.stats.gpuTime+=l.sum/1e6,h(l)):(l.startQueryIndex=f,l.endQueryIndex=m,d[e++]=l)}d.length=e}}return{beginQuery:s,endQuery:o,pushScopeStats:f,update:m,getNumPendingQueries:function(){return a.length},clear:function(){r.push.apply(r,a);for(var e=0;e<r.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(r[e]);a.length=0,r.length=0},restore:function(){a.length=0,r.length=0}}},jo=16384,Wo=256,qo=1024,Uo=34962,Xo="webglcontextlost",Yo="webglcontextrestored",Zo=1,Ko=2,Qo=3;function Jo(e,t){for(var r=0;r<e.length;++r)if(e[r]===t)return r;return-1}function el(e){var r=_e(e);if(!r)return null;var n=r.gl,i=n.getContextAttributes(),a=n.isContextLost(),s=ke(n,r);if(!s)return null;var o=ye(),l=Bo(),c=s.extensions,u=Go(n,c),h=ve(),d=n.drawingBufferWidth,f=n.drawingBufferHeight,g={tick:0,time:0,viewportWidth:d,viewportHeight:f,framebufferWidth:d,framebufferHeight:f,drawingBufferWidth:d,drawingBufferHeight:f,pixelRatio:r.pixelRatio},p={},m={elements:null,primitive:4,count:-1,offset:0,instances:-1},v=Ct(n,c),y=rr(n,l,r,w),b=Sr(n,c,y,l),x=fa(n,c,v,l,y,b,m);function w(e){return x.destroyBuffer(e)}var S=ya(n,o,l,r),C=di(n,c,v,(function(){k.procs.poll()}),g,l,r),A=ki(n,c,v,l,r),_=oa(n,c,v,C,A,l),k=Vo(n,o,c,v,y,b,C,_,p,x,S,m,g,u,r),E=Ca(n,_,k.procs.poll,g,i,c,v),D=k.next,T=n.canvas,$=[],I=[],R=[],L=[r.onDestroy],O=null;function z(){if(0===$.length)return u&&u.update(),void(O=null);O=me.next(z),U();for(var e=$.length-1;e>=0;--e){var t=$[e];t&&t(g,null,0)}n.flush(),u&&u.update()}function F(){!O&&$.length>0&&(O=me.next(z))}function M(){O&&(me.cancel(z),O=null)}function V(e){e.preventDefault(),a=!0,M(),I.forEach((function(e){e()}))}function B(e){n.getError(),a=!1,s.restore(),S.restore(),y.restore(),C.restore(),A.restore(),_.restore(),x.restore(),u&&u.restore(),k.procs.refresh(),F(),R.forEach((function(e){e()}))}function H(){$.length=0,M(),T&&(T.removeEventListener(Xo,V),T.removeEventListener(Yo,B)),S.clear(),_.clear(),A.clear(),x.clear(),C.clear(),b.clear(),y.clear(),u&&u.clear(),L.forEach((function(e){e()}))}function N(e){function r(e){var r=t({},e);function n(e){if(e in r){var t=r[e];delete r[e],Object.keys(t).forEach((function(n){r[e+"."+n]=t[n]}))}}return delete r.uniforms,delete r.attributes,delete r.context,delete r.vao,"stencil"in r&&r.stencil.op&&(r.stencil.opBack=r.stencil.opFront=r.stencil.op,delete r.stencil.op),n("blend"),n("depth"),n("cull"),n("stencil"),n("polygonOffset"),n("scissor"),n("sample"),"vao"in e&&(r.vao=e.vao),r}function n(e,t){var r={},n={};return Object.keys(e).forEach((function(i){var a=e[i];if(pe.isDynamic(a))n[i]=pe.unbox(a,i);else{if(t&&Array.isArray(a))for(var s=0;s<a.length;++s)if(pe.isDynamic(a[s]))return void(n[i]=pe.unbox(a,i));r[i]=a}})),{dynamic:n,static:r}}ne(!!e,"invalid args to regl({...})"),ne.type(e,"object","invalid args to regl({...})");var i=n(e.context||{},!0),s=n(e.uniforms||{},!0),o=n(e.attributes||{},!1),l=n(r(e),!1),c={gpuTime:0,cpuTime:0,count:0},u=k.compile(l,o,s,i,c),h=u.draw,d=u.batch,f=u.scope,g=[];function p(e){while(g.length<e)g.push(null);return g}function m(e,t){var r;if(a&&ne.raise("context lost"),"function"===typeof e)return f.call(this,null,e,0);if("function"===typeof t)if("number"===typeof e)for(r=0;r<e;++r)f.call(this,null,t,r);else{if(!Array.isArray(e))return f.call(this,e,t,0);for(r=0;r<e.length;++r)f.call(this,e[r],t,r)}else if("number"===typeof e){if(e>0)return d.call(this,p(0|e),0|e)}else{if(!Array.isArray(e))return h.call(this,e);if(e.length)return d.call(this,e,e.length)}}return t(m,{stats:c,destroy:function(){u.destroy()}})}T&&(T.addEventListener(Xo,V,!1),T.addEventListener(Yo,B,!1));var P=_.setFBO=N({framebuffer:pe.define.call(null,Zo,"framebuffer")});function G(e,t){var r=0;k.procs.poll();var i=t.color;i&&(n.clearColor(+i[0]||0,+i[1]||0,+i[2]||0,+i[3]||0),r|=jo),"depth"in t&&(n.clearDepth(+t.depth),r|=Wo),"stencil"in t&&(n.clearStencil(0|t.stencil),r|=qo),ne(!!r,"called regl.clear with no buffer specified"),n.clear(r)}function j(e){if(ne("object"===typeof e&&e,"regl.clear() takes an object as input"),"framebuffer"in e)if(e.framebuffer&&"framebufferCube"===e.framebuffer_reglType)for(var r=0;r<6;++r)P(t({framebuffer:e.framebuffer.faces[r]},e),G);else P(e,G);else G(null,e)}function W(e){function t(){var t=Jo($,e);function r(){var e=Jo($,r);$[e]=$[$.length-1],$.length-=1,$.length<=0&&M()}ne(t>=0,"cannot cancel a frame twice"),$[t]=r}return ne.type(e,"function","regl.frame() callback must be a function"),$.push(e),F(),{cancel:t}}function q(){var e=D.viewport,t=D.scissor_box;e[0]=e[1]=t[0]=t[1]=0,g.viewportWidth=g.framebufferWidth=g.drawingBufferWidth=e[2]=t[2]=n.drawingBufferWidth,g.viewportHeight=g.framebufferHeight=g.drawingBufferHeight=e[3]=t[3]=n.drawingBufferHeight}function U(){g.tick+=1,g.time=Y(),q(),k.procs.poll()}function X(){C.refresh(),q(),k.procs.refresh(),u&&u.update()}function Y(){return(ve()-h)/1e3}function Z(e,t){var r;switch(ne.type(t,"function","listener callback must be a function"),e){case"frame":return W(t);case"lost":r=I;break;case"restore":r=R;break;case"destroy":r=L;break;default:ne.raise("invalid event, must be one of frame,lost,restore,destroy")}return r.push(t),{cancel:function(){for(var e=0;e<r.length;++e)if(r[e]===t)return r[e]=r[r.length-1],void r.pop()}}}X();var K=t(N,{clear:j,prop:pe.define.bind(null,Zo),context:pe.define.bind(null,Ko),this:pe.define.bind(null,Qo),draw:N({}),buffer:function(e){return y.create(e,Uo,!1,!1)},elements:function(e){return b.create(e,!1)},texture:C.create2D,cube:C.createCube,renderbuffer:A.create,framebuffer:_.create,framebufferCube:_.createCube,vao:x.createVAO,attributes:i,frame:W,on:Z,limits:v,hasExtension:function(e){return v.extensions.indexOf(e.toLowerCase())>=0},read:E,destroy:H,_gl:n,_refresh:X,poll:function(){U(),u&&u.update()},now:Y,stats:l});return r.onDone(null,K),K}return el}))},1579:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return _e}});var n=function(){var e=this,t=e._self._c;return t("div",{staticClass:"home"},[t("div",{staticClass:"sidebar",style:{width:e.sidebarWidth+"px"}},[t("v-tabs",{staticClass:"sidebar-tabs",attrs:{vertical:""},model:{value:e.tab,callback:function(t){e.tab=t},expression:"tab"}},[t("div",{staticClass:"tab-buttons"},e._l(e.tabList,(function(r){return t("v-tab",{key:r.text,staticClass:"tab-button"},[t("v-icon",[e._v(e._s(r.icon))])],1)})),1),t("div",{staticClass:"sidebar-actions"},[t("span",{staticClass:"action-icon"},[t("v-icon",[e._v("mdi-redo")])],1),t("span",{staticClass:"action-icon"},[t("v-icon",[e._v("mdi-undo")])],1),t("hr",{staticClass:"action-divider"}),t("span",{staticClass:"action-icon"},[t("v-icon",[e._v("mdi-launch")])],1)])]),t("v-tabs-items",{staticClass:"sidebar-content",attrs:{reverse:""},model:{value:e.tab,callback:function(t){e.tab=t},expression:"tab"}},e._l(e.tabList,(function(r){return t("v-tab-item",{key:r.text},[t("v-card",{staticClass:"full-height",attrs:{color:"basil",flat:""}},[t(r.component,{tag:"component",on:{getType:e.getType,getHover:e.getHover,getGeneExp:e.getGeneExp,getColorBy:e.getColorBy,changeLayout:e.changeLayout,currentRangeSelected:e.getRangeSelected,panelStateChange:e.handlePanelStateChange,"dataset-changed":e.handleDatasetChanged}})],1)],1)})),1),e.isPanelOpen?e._e():t("div",{staticClass:"resize-handle",on:{mousedown:e.initResize}})],1),t("div",{key:e.flag,staticClass:"visualization-area",class:e.gridClass},e._l(e.datasetList,(function(r,n){return t("SingleCellGraphVue",{key:e.datasetList[n],staticClass:"grid-item",attrs:{summaryData:e.summaryData,isDelete:e.signDelete,currentIndex:n,classInfo:e.classInfo,datasetType:e.datasetList[n]},on:{deleteGrap:e.deleteGrap}})})),1)])},i=[],a=function(){var e=this,t=e._self._c;return t("div",{staticClass:"tab-panel",staticStyle:{position:"relative",overflow:"visible"}},[t("div",{staticClass:"vm-header br"},[t("p",{staticStyle:{"font-size":"14px",margin:"10px 0"}},[e._v("MANAGE LAYOUT")]),t("p",{staticStyle:{"font-weight":"700","font-size":"14px",color:"#646465"}},[e._v(" Current Views ")]),t("p",{staticStyle:{"font-size":"14px",margin:"5px 0"}},[e._v("1 out of 4")]),e.isConfigLoading?t("div",{staticStyle:{"font-size":"12px",color:"#999",margin:"5px 0"}},[e._v(" Loading datasets configuration... ")]):e._e()]),e._m(0),e._l(e.allVisualization,(function(r,n){return t("div",{key:"e"+n,staticClass:"br row4 hover-active",on:{click:e.openEdit}},[t("div",{staticClass:"color-info"},[t("span",{staticClass:"color-block"}),t("div",{staticClass:"vm-color-text",staticStyle:{"text-align":"left","margin-left":"20px"}},[t("p",[e._v(e._s(e.currentDatasetInfo.title))]),t("p",{staticStyle:{color:"#898989"}},[e._v(e._s(e.currentDatasetInfo.description))]),t("p",{staticStyle:{color:"#898989","font-size":"12px","letter-spacing":"1px"}},[e._v(" "+e._s(e.currentDatasetInfo.cellsDisplay)+" "),t("span",{staticStyle:{"font-weight":"700"}},[e._v("·")]),e._v(" "+e._s(e.currentDatasetInfo.colorField)+" ")])])]),t("span",[t("v-icon",{staticClass:"arrow-right"},[e._v("mdi-chevron-right")])],1)])})),e.allVisualization.length<4?t("div",{staticClass:"br row4 hover-active",on:{click:e.openAdd}},[t("p",{staticStyle:{width:"80%",margin:"0 auto","text-align":"left"}},[t("v-icon",{staticStyle:{"margin-right":"15px",color:"#141414"}},[e._v("mdi-plus")]),t("span",[e._v("Add Visualization")])],1),t("span",[t("v-icon",{staticClass:"arrow-right"},[e._v("mdi-chevron-right")])],1)]):e._e(),e._l(4-e.allVisualization.length-1>0?4-e.allVisualization.length-1:0,(function(r){return t("div",{key:"r"+r,staticClass:"br row4 row5"},[t("p",[e._v("None")])])})),t("div",{staticClass:"expand-panel"}),e.showEditClass?t("div",{staticClass:"vm-row2-click-panel"},[t("v-row",{attrs:{justify:"space-between"}},[t("v-col",{attrs:{cols:"3"}},[t("h3",{staticStyle:{"font-weight":"400","text-align":"left"}},[e._v("Edit")])]),t("v-col",{attrs:{cols:"3"}},[t("v-icon",{staticClass:"icon-set icon10",on:{click:function(t){e.showEditClass=!e.showEditClass}}},[e._v("mdi-close")])],1)],1),t("v-row",[t("v-col",{attrs:{cols:"12"}},[t("p",{staticClass:"edit-title"},[e._v("Dataset")]),t("v-autocomplete",{attrs:{items:e.datasetOptions,dense:"",clearable:"","item-text":"text","item-value":"value"},on:{change:e.handleDatasetChange},model:{value:e.selectedDataset,callback:function(t){e.selectedDataset=t},expression:"selectedDataset"}}),t("p",{staticClass:"edit-title"},[e._v("Visualization")]),t("v-autocomplete",{attrs:{items:e.visualList,dense:"",clearable:"","item-text":"label","item-value":"value"},model:{value:e.selectVisual,callback:function(t){e.selectVisual=t},expression:"selectVisual"}}),t("div",{staticStyle:{"text-align":"right"}},[t("v-btn",{staticStyle:{"margin-right":"10px"},attrs:{text:"",color:"#334c67"}},[e._v(" duplicate ")]),t("v-btn",{attrs:{depressed:"",disabled:""}},[e._v(" remove ")])],1)],1)],1),t("v-row",{staticStyle:{padding:"0 0 0 20px"}},[t("v-col",{attrs:{cols:"12"}},[t("v-subheader",{staticStyle:{color:"#000"}},[e._v("RESOLUTION / PERFORMANCE")]),t("v-slider",{attrs:{"tick-labels":e.ticksLabels,"thumb-color":"#334c67","track-color":"#b1bbc5","track-fill-color":"#334c67",max:3,step:"1",ticks:"always","tick-size":"2"},model:{value:e.resulution,callback:function(t){e.resulution=t},expression:"resulution"}})],1),t("v-col",{attrs:{cols:"12"}},[t("v-subheader",{staticStyle:{color:"#000"}},[e._v("POINT SIZE")]),t("v-slider",{attrs:{"tick-labels":["Small","","Medium","","Large"],"thumb-color":"#334c67","track-color":"#b1bbc5","track-fill-color":"#334c67",max:4,step:"1",ticks:"always","tick-size":"2"},model:{value:e.pointSize,callback:function(t){e.pointSize=t},expression:"pointSize"}})],1),t("v-col",{attrs:{cols:"12"}},[t("v-subheader",{staticStyle:{color:"#000"}},[e._v("FILTER")]),t("v-checkbox",{attrs:{label:"Transparent filtered cells"},model:{value:e.checkbox,callback:function(t){e.checkbox=t},expression:"checkbox"}}),e.checkbox?t("v-slider",{attrs:{"tick-labels":["0","","1"],"thumb-color":"#334c67","track-color":"#b1bbc5","track-fill-color":"#334c67",max:2,step:"1",ticks:"always","tick-size":"2"},model:{value:e.filteredCell,callback:function(t){e.filteredCell=t},expression:"filteredCell"}}):e._e()],1)],1)],1):e._e(),e.showAddVis?t("div",{staticClass:"vm-row2-click-panel"},[t("v-row",{attrs:{justify:"space-between"}},[t("v-col",{attrs:{cols:"3"}},[t("h3",{staticStyle:{"font-weight":"400","text-align":"left"}},[e._v("Add")])]),t("v-col",{attrs:{cols:"3"}},[t("v-icon",{staticClass:"icon-set icon10",on:{click:function(t){e.showAddVis=!e.showAddVis}}},[e._v("mdi-close")])],1)],1),t("v-row",[t("v-col",{attrs:{cols:"12"}},[t("v-autocomplete",{attrs:{items:e.datasetOptions,dense:"",placeholder:"Search",label:"Dataset",clearable:"","item-text":"text","item-value":"value"},on:{change:e.changeAddDataset},model:{value:e.newSelectDataset,callback:function(t){e.newSelectDataset=t},expression:"newSelectDataset"}})],1),t("v-col",{attrs:{cols:"12"}},[t("v-autocomplete",{attrs:{items:e.newVisualList,dense:"",placeholder:"Search",label:"Visualization",clearable:"","item-text":"label","item-value":"value"},model:{value:e.newSelectVisual,callback:function(t){e.newSelectVisual=t},expression:"newSelectVisual"}})],1),t("v-col",{attrs:{cols:"12"}},[t("div",{staticStyle:{"text-align":"right"}},[t("v-btn",{staticStyle:{"margin-right":"10px"},attrs:{text:"",color:"#334c67"}},[e._v(" duplicate ")]),t("v-btn",{attrs:{depressed:"",disabled:""}},[e._v(" remove ")])],1)])],1)],1):e._e()],2)},s=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"br row2"},[t("div",{staticClass:"color-main"},[t("span",{staticClass:"color-block"})])])}],o=r(3518),l=r(2004),c={name:"ViewManager",data:()=>({seasons:["Winter","Spring","Summer","Fall"],icons:["mdi-snowflake","mdi-leaf","mdi-fire","mdi-water"],ticksLabels:["Low / Fast","","","High / Show"],pointSize:1,resulution:0,filteredCell:1,checkbox:!1,showEditClass:!1,showAddVis:!1,selectDataset:"single",selectedDataset:null,isDatasetLoading:!1,isLoadingDatasetInfo:!1,datasetInfoCache:new Map,datasetOptions:[],isConfigLoading:!0,visualList:[],selectVisual:"umap",newSelectDataset:"",newSelectVisual:"",newVisualList:[],allVisualization:[{visual:"umap"}]}),computed:{...(0,o.aH)("cellData",["datasetList"]),currentDatasetInfo(){const e=this.datasetOptions.find((e=>e.value===this.selectedDataset));if(e&&e.info){const t=e.config,r=e.info;return{title:`${t.displayName||t.name}`,description:t.description||`${t.name}`,cellsDisplay:r?this.formatNumber(r.total_cells)+" cells":t.metadata?.estimatedCells?this.formatNumber(t.metadata.estimatedCells)+" cells":"Unknown cells",colorField:"Class"}}return{}}},async mounted(){"undefined"!==typeof window&&window.addEventListener("datasetChanged",this.handleDatasetChangedEvent),await this.initializeDynamicConfig(),await this.loadAllDatasetInfo()},beforeDestroy(){"undefined"!==typeof window&&window.removeEventListener("datasetChanged",this.handleDatasetChangedEvent)},methods:{...(0,o.i0)("cellData",["loadFieldsInfo","switchDataSource"]),async initializeDynamicConfig(){try{this.isConfigLoading=!0,await(0,l.jO)();const e=(0,l.GU)();if(!e)throw new Error("无法获取数据集配置");this.datasetOptions=e.datasets.map((e=>({text:e.displayName||e.name,value:e.id,config:e,info:null}))),this.buildVisualizationOptions(e);const t=(0,l.vh)();t&&this.datasetOptions.find((e=>e.value===t))?this.selectedDataset=t:this.selectedDataset=e.defaultDataset||(this.datasetOptions.length>0?this.datasetOptions[0].value:null),console.log("动态配置初始化完成:",{datasets:this.datasetOptions.length,currentDataset:this.selectedDataset,configDefault:e.defaultDataset,availableDatasets:this.datasetOptions.map((e=>e.value))})}catch(e){console.error("动态配置初始化失败:",e);try{console.warn("尝试直接加载datasets_config.json作为回退...");const e=await(0,l.CV)();if(!e||!e.datasets)throw new Error("配置文件格式无效");this.datasetOptions=e.datasets.map((e=>({text:e.displayName||e.name,value:e.id,config:e,info:null}))),this.buildVisualizationOptions(e),this.selectedDataset=e.defaultDataset||(e.datasets.length>0?e.datasets[0].id:null),console.log("使用配置文件回退方案成功:",{datasets:this.datasetOptions.length,defaultDataset:this.selectedDataset})}catch(t){console.error("回退方案也失败，使用硬编码配置:",t),this.datasetOptions=[{text:"Single Outputs scRNAseq",value:"Tumour",config:{id:"Tumour",name:"Tumour",displayName:"Single Outputs scRNAseq",description:"Main single cell RNA-seq dataset",supportedVisualizations:["tsne","umap","pca"]},info:null},{text:"Single Outputs1 scRNAseq",value:"mouse",config:{id:"mouse",name:"mouse",displayName:"Single Outputs1 scRNAseq",description:"Alternative single cell RNA-seq dataset",supportedVisualizations:["tsne","umap","pca"]},info:null}],this.selectedDataset="Tumour",this.buildVisualizationOptions({visualizations:{tsne:{label:"t-SNE"},umap:{label:"UMAP"},pca:{label:"PCA"}}})}}finally{this.isConfigLoading=!1}},buildVisualizationOptions(e){const t=e.visualizations||{tsne:{label:"t-SNE",description:"t-Distributed Stochastic Neighbor Embedding"},umap:{label:"UMAP",description:"Uniform Manifold Approximation and Projection"},pca:{label:"PCA",description:"Principal Component Analysis"}};this.visualList=Object.entries(t).map((([e,t])=>({label:t.label||e.toUpperCase(),value:e}))),this.newVisualList=[...this.visualList],!this.selectVisual&&this.visualList.length>0&&(this.selectVisual=this.visualList.find((e=>"umap"===e.value))?.value||this.visualList[0].value)},async handleDatasetChange(e){if(this.isDatasetLoading)return void console.log("数据集切换正在进行中，忽略重复请求");const t=(0,l.vh)();if(t!==e){this.showEditClass=!1,this.isDatasetLoading=!0;try{console.log(`ViewManager: 切换数据集从 ${t} 到 ${e}`),(0,l.vX)(e),this.$emit("dataset-changed",{dataset:e,oldDataset:t,info:this.getDatasetInfo(e)}),console.log(`已切换到数据集: ${this.getDatasetDisplayName(e)}`)}catch(r){console.error("ViewManager: 切换数据集失败:",r),this.selectedDataset=t}finally{setTimeout((()=>{this.isDatasetLoading=!1}),500)}}else console.log("数据集未发生变化，跳过切换")},handleDatasetChangedEvent(e){this.selectedDataset=e.detail.dataset},async loadAllDatasetInfo(){if(this.datasetOptions&&0!==this.datasetOptions.length)if(this.isLoadingDatasetInfo)console.log("数据集信息正在加载中，跳过重复请求");else{this.isLoadingDatasetInfo=!0,console.log("开始加载数据集信息...");try{const e=this.datasetOptions.map((async e=>{if(e.info)console.log(`数据集 ${e.value} 信息已存在，跳过加载`);else try{const t=await this.loadDatasetInfo(e.value);e.info=t,console.log(`数据集 ${e.value} 信息加载成功:`,t)}catch(t){console.warn(`加载数据集信息失败: ${e.value}`,t),e.config&&e.config.metadata&&e.config.metadata.estimatedCells&&(e.info={total_cells:e.config.metadata.estimatedCells,estimated:!0})}}));await Promise.all(e),console.log("所有数据集信息加载完成")}finally{this.isLoadingDatasetInfo=!1}}else console.warn("没有可用的数据集选项")},async loadDatasetInfo(e){if(this.datasetInfoCache.has(e))return this.datasetInfoCache.get(e);try{const t=(0,l.buildDatasetPath)("matrix_info.json",e),r=await fetch(t);if(r.ok){const t=await r.json();return this.datasetInfoCache.set(e,t),t}throw new Error(`HTTP ${r.status}`)}catch(t){return console.error(`加载数据集信息失败: ${e}`,t),null}},getDatasetInfo(e){const t=this.datasetOptions.find((t=>t.value===e));return t?t.info:null},getDatasetDisplayName(e){const t=this.datasetOptions.find((t=>t.value===e));return t?t.text:e},getDatasetVisualizationOptions(e){const t=this.datasetOptions.find((t=>t.value===e));return t&&t.config&&t.config.supportedVisualizations?this.visualList.filter((e=>t.config.supportedVisualizations.includes(e.value))):this.visualList},formatNumber(e){return e?e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString():"0"},season(e){return this.icons[e]},changeDataset(){const e=this.getDatasetVisualizationOptions(this.selectedDataset);if(this.visualList=e,e.length>0){const t=this.datasetOptions.find((e=>e.value===this.selectedDataset)),r=t?.config?.defaultVisualization||"umap";this.selectVisual=e.find((e=>e.value===r))?.value||e[0].value}console.log("数据集变更:",{dataset:this.selectedDataset,supportedVisualizations:e.map((e=>e.value)),selectedVisualization:this.selectVisual})},changeAddDataset(){const e=this.getDatasetVisualizationOptions(this.newSelectDataset);if(this.newVisualList=e,e.length>0){const t=this.datasetOptions.find((e=>e.value===this.newSelectDataset)),r=t?.config?.defaultVisualization||"umap";this.newSelectVisual=e.find((e=>e.value===r))?.value||e[0].value}this.allVisualization.unshift({dataset:this.newSelectDataset,visual:this.newSelectVisual}),this.showAddVis=!1,this.newSelectVisual="",this.newSelectDataset="",this.$emit("changeLayout",this.allVisualization)},openEdit(){this.showEditClass=!0,this.showAddVis=!1},openAdd(){this.showAddVis=!0,this.showEditClass=!1}}},u=c,h=r(1656),d=(0,h.A)(u,a,s,!1,null,"1fe99efc",null),f=d.exports,g=function(){var e=this,t=e._self._c;return t("div",{staticClass:"tab-panel"},[t("div",{staticClass:"vm-header br cell-row1"},[e._m(0),t("p",{staticClass:"dataset-title"},[e._v(" "+e._s(e.datasetName)+" "),t("v-icon",{staticClass:"icon-set small-icon",attrs:{dense:""}},[e._v("mdi-information-outline")])],1),t("p",[e._v(e._s(e.datasetName))])]),t("div",{staticClass:"vm-header br cell-row1 cell-row2"},[t("p",{staticClass:"properties-title"},[t("span",[e._v("Cell Properties")]),t("v-icon",{staticClass:"icon-set small-icon",attrs:{dense:""}},[e._v("mdi-cog")])],1),t("p",{staticClass:"cell-count"},[e._v(e._s(e.formatFileSize(e.total))+" cells")])]),t("div",{staticClass:"panel-container",staticStyle:{position:"relative"}},[t("v-overlay",{attrs:{value:!e.cellInfoList.length,absolute:"",opacity:"0.1"}},[t("v-progress-circular",{attrs:{indeterminate:"",size:"64"}})],1),t("v-expansion-panels",{staticClass:"expansion-panels",attrs:{accordion:""}},e._l(e.cellInfoList,(function(r,n){return t("v-expansion-panel",{key:n},[t("v-expansion-panel-header",{staticClass:"panel-header",attrs:{"expand-icon":""},scopedSlots:e._u([{key:"default",fn:function({open:n}){return[t("v-row",{staticClass:"panel-row",attrs:{"no-gutters":""}},[t("v-col",{staticClass:"panel-col-left",attrs:{cols:12,sm:6}},[t("v-icon",n?[e._v("mdi-chevron-down")]:[e._v("mdi-chevron-right")]),t("span",{staticClass:"item-name"},[e._v(e._s(r.name))]),e.getFilterNum(r.name)?t("span",{staticClass:"filter-style"},[e._v(e._s(e.getFilterNum(r.name))+" filters")]):e._e()],1),t("v-col",{staticClass:"panel-col-right",attrs:{cols:12,sm:6}},[t("v-fade-transition",{attrs:{"leave-absolute":""}},[t("span",{key:"0",staticClass:"action-icons"},[n?t("v-icon",{staticClass:"icon-set"},[e._v("mdi-plus")]):e._e(),n?t("v-icon",{staticClass:"icon-set"},[e._v("mdi-minus")]):e._e(),n?t("v-icon",{staticClass:"icon-set"},[e._v("mdi-magnify")]):e._e(),t("span",{staticClass:"icon-set icon10",on:{click:function(t){return t.stopPropagation(),e.changeByColor(r.name)}}},[t("svg",{staticClass:"v-icon__svg",style:{fill:e.currentColorBy===r.name?"#297aba":"#6c6c6c"},attrs:{xmlns:"http://www.w3.org/2000/svg","enable-background":"new 0 0 24 24",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#5f6368"}},[t("rect",{attrs:{fill:"none",height:"24",width:"24"}}),t("path",{attrs:{d:"M12,2c-5.33,4.55-8,8.48-8,11.8c0,4.98,3.8,8.2,8,8.2s8-3.22,8-8.2C20,10.48,17.33,6.55,12,2z M12,20c-3.35,0-6-2.57-6-6.2 c0-2.34,1.95-5.44,6-9.14c4.05,3.7,6,6.79,6,9.14C18,17.43,15.35,20,12,20z M7.83,14c0.37,0,0.67,0.26,0.74,0.62 c0.41,2.22,2.28,2.98,3.64,2.87c0.43-0.02,0.79,0.32,0.79,0.75c0,0.4-0.32,0.73-0.72,0.75c-2.13,0.13-4.62-1.09-5.19-4.12 C7.01,14.42,7.37,14,7.83,14z"}})])])],1)])],1)],1)]}}],null,!0)}),t("v-expansion-panel-content",["Class"!==r.name?t(e.currentComponent,{tag:"component",attrs:{typeName:r.name,typeList:r.children,field:e.field,fieldValue:e.fieldValue,currentColorBy:e.currentColorBy},on:{getCheckList:e.getCheckList,getHoverItem:e.getHoverItem},nativeOn:{mouseenter:function(t){return e.handleAttributeMouseEnter.apply(null,arguments)},mouseleave:function(t){return e.handleAttributeMouseLeave.apply(null,arguments)}}}):t("v-treeview",{staticClass:"tree-view",attrs:{items:r.children,"selected-color":"indigo",selectable:"",hoverable:"","expand-icon":"mdi-chevron-down"},on:{input:e.getTreeSelected},scopedSlots:e._u([{key:"label",fn:function({item:r}){return[t("div",{staticClass:"tree-item",on:{mouseover:function(t){return e.handleMouseOver(r)},mouseleave:function(t){return e.handleMouseOut(r)}}},[t("span",{staticClass:"tree-item-name"},[e._v(" "+e._s(r.name))]),t("div",{staticClass:"color-list"},["Class"===e.currentColorBy?t("span",{staticClass:"color-item",style:{backgroundColor:e.getColor(r.name)}}):t("div",{staticClass:"color-list-container"},e._l(e.getColorList(),(function(e,r){return t("span",{key:r,staticClass:"color-item",style:{backgroundColor:e}})})),0)])])]}}],null,!0),model:{value:e.treeSelection,callback:function(t){e.treeSelection=t},expression:"treeSelection"}})],1)],1)})),1)],1)])},p=[function(){var e=this,t=e._self._c;return t("p",[t("span",{staticClass:"color-block"}),t("span",{staticClass:"cell-row1-text"},[e._v("SELECTED VIEW")])])}];function m(e,t,r){let n=[0,0,0],i=Math.floor(6*e),a=6*e-i,s=r*(1-t),o=r*(1-a*t),l=r*(1-(1-a)*t);switch(i%6){case 0:n=[r,l,s];break;case 1:n=[o,r,s];break;case 2:n=[s,r,l];break;case 3:n=[s,o,r];break;case 4:n=[l,s,r];break;case 5:n=[r,s,o];break}return n}function v(e,t){if(e<0)return[.4,.4,.4,1];const r=.618033988749895*e%1,n=Math.floor(e%5),i=.2*n+.1*t%.2,a=(r+i)%1,s=.6+e%1*.3,o=.7+7*e%1*.2,l=m(a,s,o);return[...l,.8]}var y=function(){var e=this,t=e._self._c;return t("div",{on:{mouseenter:e.onComponentEnter,mouseleave:e.onComponentLeave}},[t("v-virtual-scroll",{attrs:{height:300,items:e.typeList,"item-height":"48"},scopedSlots:e._u([{key:"default",fn:function({item:r}){return[t("div",{staticClass:"type-item",staticStyle:{display:"flex","justify-content":"space-between",padding:"5px 0px 0px 10px"},attrs:{title:r.name},on:{mouseenter:function(t){return e.onMouseEnter(r)},mouseleave:function(t){return e.onMouseLeave(r)}}},[t("v-checkbox",{staticClass:"shrink mt-0 long-label-checkbox",attrs:{"hide-details":"",label:r.name,value:r.id},on:{change:e.getCheckList},model:{value:e.checkList,callback:function(t){e.checkList=t},expression:"checkList"}}),t("div",{staticClass:"check-info shrink"},[e.currentColorBy===e.typeName?t("div",{staticClass:"color-bar"},[t("div",{staticClass:"color-item",style:{backgroundColor:e.getColor(r.name),width:"100%"}})]):t("div",{staticClass:"color-bar"},e._l(e.colors,(function(e,r){return t("div",{key:r,staticClass:"color-item",style:{backgroundColor:e,width:"20%"}})})),0),t("span",{staticStyle:{"font-size":"14px"}},[e._v("2.05M")])])],1)]}}])})],1)},b=[],x=r(8626),w=r.n(x),S={data(){return{checkList:[],colors:[],classes:[],highlightTimeout:null,componentHovered:!1}},props:{typeList:{type:Array,default:()=>[]},typeName:{type:String,default:()=>""},currentColorBy:{type:String,default:"Class"}},computed:{...(0,o.aH)("cellData",["field"]),...(0,o.L8)("cellData",["getFieldValue"]),fieldValue(){const e=this.getFieldValue||{};return Object.keys(e).length>0&&console.log("📊 typeListItem fieldValue loaded:",{keys:Object.keys(e),typeName:this.typeName,hasCurrentType:!!e[this.typeName],currentTypeLength:e[this.typeName]?e[this.typeName].length:0}),e},safeFieldValue(){return this.fieldValue||{}},safeField(){return this.field||[]}},watch:{currentColorBy:{handler(e){if(console.log(e,83),this.colors=[],!this.safeField.length||!Object.keys(this.safeFieldValue).length)return void console.warn("Field 或 fieldValue 尚未加载，跳过颜色初始化");let t="Class"===this.currentColorBy?"Siletti_modf_SCANVI_L1":this.currentColorBy,r=this.safeField.indexOf(t),n=this.safeFieldValue[t];if(n&&Array.isArray(n))for(let i=0;i<10;i++){let e=v(i,r);this.colors.push(`rgba(${255*e[0]}, ${255*e[1]}, ${255*e[2]}, ${e[3]})`)}else console.warn(`字段 ${t} 的数据不存在或不是数组，跳过颜色初始化`)},immediate:!0}},mounted(){this.classes=this.typeList.map((e=>({label:e.id,value:e.id})))},methods:{getCheckList(){if(console.log("=== 勾选状态变更开始 ==="),console.log(`属性: ${this.typeName}`),console.log(`当前勾选数量: ${this.checkList.length}`),console.log(`勾选项: [${this.checkList.join(", ")}]`),this.$emit("getCheckList",{key:this.typeName,value:this.checkList,mode:"check"}),console.log(`勾选状态变更: ${this.typeName}, 当前勾选数量: ${this.checkList.length}, 勾选项: [${this.checkList.join(", ")}]`),this.checkList.length>0){const e=[];for(const t of this.checkList){const r=this.typeList.find((e=>e.id===t));if(r){let t=-1;this.safeFieldValue[this.typeName]&&Array.isArray(this.safeFieldValue[this.typeName])&&(t=this.safeFieldValue[this.typeName].indexOf(r.name),t>=0&&(e.push(t),console.log(`勾选项: ${r.name}, 索引: ${t}`)))}}if(console.log(`收集到的值索引: [${e.join(", ")}]`),e.length>0){const t=new CustomEvent("highlight-multi-attribute-intersection",{bubbles:!0,detail:{attributeName:this.typeName,attributeValueIndices:e}});this.$el.dispatchEvent(t),console.log(`已触发多属性交集高亮事件: ${this.typeName}, 索引: [${e.join(", ")}]`)}}else{console.log(`没有勾选项，清除${this.typeName}的高亮`);const e=new CustomEvent("highlight-multi-attribute-intersection",{bubbles:!0,detail:{attributeName:this.typeName,attributeValueIndices:[]}});this.$el.dispatchEvent(e)}console.log("=== 勾选状态变更结束 ===")},onComponentEnter(){console.log("进入列表区域"),this.componentHovered=!0;const e=new CustomEvent("mouse-enter-list-area",{bubbles:!0});this.$el.dispatchEvent(e),this.checkList.length>0&&(console.log(`重新进入组件，恢复${this.checkList.length}个勾选项的高亮`),this.getCheckList())},onComponentLeave(){console.log("离开列表区域"),this.componentHovered=!1,setTimeout((()=>{if(!this.componentHovered){const e=new CustomEvent("mouse-leave-list-area",{bubbles:!0});this.$el.dispatchEvent(e);const t=new CustomEvent("cell-property-item-mouseleave",{bubbles:!0});if(this.$el.dispatchEvent(t),0===this.checkList.length){console.log("没有勾选项，可以清除高亮");const e=new CustomEvent("clear-highlight",{bubbles:!0,detail:{attributeName:this.typeName,reason:"no-checked-items"}});this.$el.dispatchEvent(e)}else console.log(`有${this.checkList.length}个勾选项，保留勾选高亮`);console.log("确认离开组件区域，清除悬停高亮，保留勾选高亮")}}),100)},onMouseEnter(e){this.highlightTimeout&&clearTimeout(this.highlightTimeout);let t=-1;if(this.safeFieldValue[this.typeName]&&Array.isArray(this.safeFieldValue[this.typeName])&&(t=this.safeFieldValue[this.typeName].indexOf(e.name)),console.log(`鼠标进入: ${this.typeName} - ${e.name}, 索引: ${t}`),this.$emit("getHoverItem",{key:this.typeName,value:e.id,mode:"over",valueIndex:t}),t>=0){const r=new CustomEvent("cell-property-item-mouseenter",{bubbles:!0,detail:{attributeName:this.typeName,attributeValue:e.name,valueIndex:t}});this.$el.dispatchEvent(r)}else console.warn(`无法找到属性 ${this.typeName} 值 ${e.name} 的索引`)},onMouseLeave(e){this.highlightTimeout&&clearTimeout(this.highlightTimeout),this.$emit("getHoverItem",{key:this.typeName,value:e.id,mode:"leave"}),console.log("鼠标离开项目，但保留勾选高亮，当前勾选项数量：",this.checkList.length)},onOver:w().debounce((function(e){this.$emit("getHoverItem",{key:this.typeName,value:e.value,mode:"over"})})),onLeave:w().debounce((function(e){this.$emit("getHoverItem",{key:this.typeName,value:e.value,mode:"leave"})})),getColor(e){if(console.log(this.safeField,this.safeFieldValue,e,137),!this.safeField.length||!Object.keys(this.safeFieldValue).length)return console.warn("Field 或 fieldValue 尚未加载，返回默认颜色"),"rgba(128, 128, 128, 1)";let t=this.safeField.indexOf(this.typeName);if(!this.safeFieldValue[this.typeName]||!Array.isArray(this.safeFieldValue[this.typeName]))return console.warn(`字段 ${this.typeName} 的数据不存在或不是数组，返回默认颜色`),"rgba(128, 128, 128, 1)";let r=this.safeFieldValue[this.typeName].indexOf(e);if(-1===r)return console.warn(`在字段 ${this.typeName} 中未找到标签 ${e}，返回默认颜色`),"rgba(128, 128, 128, 1)";let n=v(r,t);return console.log(n,344,r,t),`rgba(${255*n[0]}, ${255*n[1]}, ${255*n[2]}, ${n[3]})`},clearAllHighlights(){console.log("清除所有高亮状态"),this.highlightTimeout&&(clearTimeout(this.highlightTimeout),this.highlightTimeout=null);const e=new CustomEvent("cell-property-item-mouseleave",{bubbles:!0});if(this.$el.dispatchEvent(e),0===this.checkList.length){console.log("没有勾选项，清除所有高亮");const e=new CustomEvent("clear-highlight",{bubbles:!0,detail:{attributeName:this.typeName,reason:"component-destroy"}});this.$el.dispatchEvent(e)}else console.log(`有${this.checkList.length}个勾选项，保留勾选高亮`)}},beforeDestroy(){this.clearAllHighlights(),this.highlightTimeout&&(clearTimeout(this.highlightTimeout),this.highlightTimeout=null)}},C=S,A=(0,h.A)(C,y,b,!1,null,"32ca75a4",null),k=A.exports,E=r(2548),D={name:"CellProperties",mixins:[E.o],components:{typeListItem:k},data(){return{expandPanelList:[],items:[],currentComponent:"typeListItem",treeSelection:[],currentColorBy:"Class",highlightedAttribute:null,highlightedValue:-1}},computed:{...(0,o.aH)("cellData",["typeInfo","total","field","datasetName"]),...(0,o.L8)("cellData",["getCellInfoList","getFieldValue"]),cellInfoList(){return this.getCellInfoList},fieldValue(){return this.getFieldValue}},watch:{field:{handler(e){this.currentColorBy=e[0]}}},mounted(){this.addGlobalEventListeners(),"undefined"!==typeof window&&window.addEventListener("datasetChanged",this.handleDatasetChange)},beforeDestroy(){this.removeGlobalEventListeners(),"undefined"!==typeof window&&window.removeEventListener("datasetChanged",this.handleDatasetChange)},methods:{...(0,o.i0)("cellData",["loadFieldsInfo","loadCellTypeValues"]),async handleDatasetChange(e){console.log("CellProperties组件: 数据集切换到",e.detail.dataset);try{this.currentColorBy="Class",this.highlightedAttribute=null,this.highlightedValue=-1,this.treeSelection=[],await new Promise((e=>setTimeout(e,100))),console.log("CellProperties: 重新加载字段信息..."),await this.loadDataWithRetry("loadFieldsInfo",3),console.log("CellProperties: 重新加载细胞类型值..."),await this.loadDataWithRetry("loadCellTypeValues",3),console.log("CellProperties: 数据重新加载完成"),this.$emit("dataset-changed",{dataset:e.detail.dataset})}catch(t){console.error("CellProperties: 数据集切换时重新加载数据失败:",t)}},async loadDataWithRetry(e,t=3,r=200){let n=null;for(let a=1;a<=t;a++)try{return void await this[e]()}catch(i){if(n=i,console.warn(`CellProperties: ${e} 第${a}次尝试失败:`,i.message),a<t){const e=r*Math.pow(2,a-1);console.log(`CellProperties: ${e}ms后进行第${a+1}次重试...`),await new Promise((t=>setTimeout(t,e)))}}throw console.error(`CellProperties: ${e} 经过${t}次重试后仍然失败:`,n),n},getFilterNum(e){return this.typeInfo.hasOwnProperty(e)?"Class"===e?Object.keys(this.typeInfo[e]).length:this.typeInfo[e].length:0},getCheckList(e){this.$emit("getType",{type:"plain",data:e})},getTreeSelected(e){console.log(e,197);let t=this.categorizedData(e);if(this.$emit("getType",{type:"treeView",data:{key:"Class",value:t,mode:"selected"}}),e&&e.length>0){const t=[],r="Siletti_modf_SCANVI_L2";for(const n of e)if(this.fieldValue&&this.fieldValue[r]&&Array.isArray(this.fieldValue[r])){const e=this.fieldValue[r].indexOf(n);e>=0?(t.push(e),console.log(`Class勾选项: ${n}, 索引: ${e}`)):console.warn(`无法找到Class项 ${n} 在属性 ${r} 中的索引`)}if(console.log(`Class收集到的值索引: [${t.join(", ")}]`),t.length>0){const e=new CustomEvent("highlight-multiple-attributes",{bubbles:!0,detail:{attributeName:r,attributeValueIndices:t,isCheckHighlight:!0}});this.$el.dispatchEvent(e),console.log(`已触发Class多值高亮事件: ${r}, 索引: [${t.join(", ")}]`)}}else{console.log("没有Class勾选项，清除高亮");const e=new CustomEvent("clear-highlight",{bubbles:!0,detail:{attributeName:"Siletti_modf_SCANVI_L2",force:!0,reason:"class-uncheck"}});this.$el.dispatchEvent(e)}},categorizedData(e=[]){const t={};return e.forEach((e=>{const r=e.match(/^([A-Za-z0-9\s-]+(?: and [A-Za-z0-9\s-]+)?)-\d+$/)[1].trim();t[r]||(t[r]=[]),t[r].push(e)})),t},handleMouseOver(e){console.log(e,209),this.$emit("getHover",{type:"treeView",data:e,mode:"over"}),!e.children&&e.parent?this.highlightTreeItem("Siletti_modf_SCANVI_L2",e.name):this.highlightTreeItem("Siletti_modf_SCANVI_L1",e.name)},handleMouseOut(e){console.log(e,215),this.$emit("getHover",{type:"treeView",data:e,mode:"leave"}),this.clearHighlight()},getHoverItem(e){console.log("🖱️ CellProperties getHoverItem:",e),this.$emit("getHover",{type:"plain",data:e}),console.log("✅ 悬浮事件已发送到 HomeView")},changeByColor(e){this.currentColorBy=e;let t="Class"===e?"Siletti_modf_SCANVI_L1":e;this.$emit("getColorBy",t)},formatFileSize(e){return e>=1073741824?(e/1073741824).toFixed(2)+" GB":e>=1048576?(e/1048576).toFixed(2)+" MB":e},getColor(e){console.log(this.field,this.fieldValue,e,339);let t="Class"===this.currentColorBy?"Siletti_modf_SCANVI_L1":this.currentColorBy,r=this.field.indexOf(t),n=this.fieldValue[t].indexOf(e),i=v(n,r);return console.log(i,344,n,r),`rgba(${255*i[0]}, ${255*i[1]}, ${255*i[2]}, ${i[3]})`},getColorList(){let e="Class"===this.currentColorBy?"Siletti_modf_SCANVI_L1":this.currentColorBy,t=this.field.indexOf(e),r=(this.fieldValue[e],[]);for(let n=0;n<10;n++){let e=v(n,t);r.push(`rgba(${255*e[0]}, ${255*e[1]}, ${255*e[2]}, ${e[3]})`)}return r},async loadCellAttribute(e){try{console.log(`CellProperties: 开始加载属性数据: ${e}`);const t=e.split("/").pop().replace(".bin",""),{dataLoader:n}=await Promise.resolve().then(r.bind(r,6445)),i=await n.loadCellAttribute(t);return console.log(`CellProperties: 成功加载Float32Array，长度: ${i.length}`),i}catch(t){return console.error("CellProperties: 加载属性数据失败:",t),new Float32Array(0)}},addGlobalEventListeners(){document.addEventListener("cell-property-item-mouseenter",this.handlePropertyItemMouseEnter),document.addEventListener("cell-property-item-mouseleave",this.handlePropertyItemMouseLeave)},removeGlobalEventListeners(){document.removeEventListener("cell-property-item-mouseenter",this.handlePropertyItemMouseEnter),document.removeEventListener("cell-property-item-mouseleave",this.handlePropertyItemMouseLeave)},handlePropertyItemMouseEnter(e){if(e.detail){const{attributeName:t,attributeValue:r,valueIndex:n}=e.detail;if(!t||void 0===n||n<0)return void console.warn(`无效的悬停属性信息: ${t}:${n}`);console.log(`🖱️ 属性项悬停: ${t}, 值索引: ${n}`),this.$emit("getHover",{type:"plain",data:{key:t,value:r,valueIndex:n,mode:"over"}}),console.log("✅ 直接悬浮事件已发送到 HomeView")}},handlePropertyItemMouseLeave(){this.clearHoverCategory()},setHoverCategory(e,t){this.$store.dispatch("cellData/setHoverInfo",{key:e,value:t,type:"hover"})},clearHoverCategory(){this.$store.dispatch("cellData/clearHoverInfo")},highlightAttribute(e,t){if(t<0)return void console.warn(`属性值索引无效: ${t}`);const r="Class"===e?"Siletti_modf_SCANVI_L1":e;if(!this.field.includes(r))return void console.warn(`属性名无效: ${r}`);this.highlightedAttribute=r,this.highlightedValue=t;const n=new CustomEvent("highlight-attribute",{detail:{attributeName:r,attributeValue:t},bubbles:!0});this.$el.dispatchEvent(n)},highlightTreeItem(e,t){if(!this.fieldValue||!this.fieldValue[e])return void console.warn(`无效的属性名: ${e}`);const r=this.fieldValue[e];if(!r||!Array.isArray(r))return void console.warn(`属性值数组无效: ${e}`);const n=r.indexOf(t);n>=0?this.highlightAttribute(e,n):console.warn(`无法找到项 ${t} 在属性 ${e} 中的索引`)},clearHighlight(e=!1){if(!this.highlightedAttribute&&!e)return;if(!e){console.log("尝试清除高亮，但需要检查是否有勾选项");const e=new CustomEvent("clear-highlight",{bubbles:!0,detail:{attributeName:this.highlightedAttribute,checkForCheckedItems:!0,reason:"parent-clear-request"}});return void this.$el.dispatchEvent(e)}this.highlightedAttribute=null,this.highlightedValue=-1;const t=new CustomEvent("clear-highlight",{bubbles:!0,detail:{force:!0,reason:"force-clear"}});this.$el.dispatchEvent(t)},handleAttributeMouseEnter(e){},handleAttributeMouseLeave(){this.clearHoverCategory();const e=new CustomEvent("cell-property-item-mouseleave",{bubbles:!0});this.$el.dispatchEvent(e)}}},T=D,$=(0,h.A)(T,g,p,!1,null,"5998154a",null),I=$.exports,R=function(){var e=this,t=e._self._c;return t("div",{staticClass:"tab-panel"},[t("div",{staticClass:"vm-header br cell-row1"},[e._m(0),t("p",{staticStyle:{"font-size":"20px",margin:"10px 0"}},[e._v(" "+e._s(e.datasetName)+" "),t("v-icon",{staticClass:"icon-set small-icon",attrs:{dense:""}},[e._v("mdi-information-outline")])],1),t("p",[e._v(e._s(e.datasetName))])]),t("div",{staticClass:"vm-header br cell-row1 cell-row2",staticStyle:{"background-color":"#fff"}},[e._m(1),t("p",{staticStyle:{color:"#666","margin-bottom":"15px !important"}},[e._v(e._s(e.geneList.length)+" in dataset")]),t("div",[e.showBatchInput?t("v-textarea",{attrs:{outlined:"",dense:"","auto-grow":"",rows:"3",label:"Enter gene symbols separated by commas",placeholder:"e.g. Gad1, Slc17a7, Aqp4"},on:{keydown:function(t){if(!t.type.indexOf("key")&&e._k(t.keyCode,"esc",27,t.key,["Esc","Escape"]))return null;e.showBatchInput=!1}},model:{value:e.batchInput,callback:function(t){e.batchInput=t},expression:"batchInput"}}):t("v-autocomplete",{attrs:{items:e.geneList,outlined:"",chips:"",clearable:"",label:"Search by gene symbol","item-text":"label","item-value":"value",multiple:"",dense:""},on:{change:e.selectGene},scopedSlots:e._u([{key:"selection",fn:function(r){return[t("v-chip",e._b({attrs:{"input-value":r.selected,close:"",label:"",outlined:"",small:""},on:{click:r.select,"click:close":function(t){return e.remove(r.item)}}},"v-chip",r.attrs,!1),[e._v(" "+e._s(r.item.label)+" ")])]}},{key:"item",fn:function(r){return[[t("v-list-item-content",[e._v(e._s(r.item.label))])]]}}],null,!1,1221483296),model:{value:e.geneSelected,callback:function(t){e.geneSelected=t},expression:"geneSelected"}}),t("div",{staticClass:"gene-symbol-btn"},[t("v-btn",{staticClass:"ma-2",attrs:{outlined:"",color:"indigo"},on:{click:e.clearGenes}},[e._v(" CLEAR")]),e.showBatchInput?t("v-btn",{staticClass:"ma-2",attrs:{outlined:"",color:"indigo"},on:{click:e.addBatchGenes}},[e._v(" SUBMIT ")]):t("v-btn",{staticClass:"ma-2",attrs:{outlined:"",color:"indigo"},on:{click:function(t){e.showBatchInput=!0}}},[e._v(" ADD BATCH ")]),e.showBatchInput?t("v-btn",{staticClass:"ma-2",attrs:{outlined:"",color:"error"},on:{click:function(t){e.showBatchInput=!1}}},[e._v(" CANCEL ")]):e._e()],1)],1)]),t("div",{staticStyle:{display:"flex"}},[t("v-expansion-panels",{staticClass:"mb-6",attrs:{accordion:""}},e._l(e.geneSelected,(function(r,n){return t("v-expansion-panel",{key:n},[t("v-expansion-panel-header",{staticStyle:{display:"flex","justify-content":"space-between"},attrs:{"hide-actions":""},on:{click:function(t){return e.handlePanelClick(r)}},scopedSlots:e._u([{key:"default",fn:function({open:n}){return[t("v-row",{attrs:{"no-gutters":"",justify:"space-between"}},[t("v-col",{staticStyle:{"text-align":"left",display:"flex","align-items":"center"},attrs:{cols:"4"}},[t("v-icon",n?[e._v("mdi-chevron-down")]:[e._v("mdi-chevron-right")]),e._v(" "+e._s(r)+" ")],1),t("v-col",{staticClass:"gene-symbol-icon",attrs:{cols:"4"}},[t("v-icon",{staticClass:"icon-set icon10",staticStyle:{"font-size":"20px"}},[e._v("mdi-cog")]),t("span",{staticClass:"icon-set icon10 color-icon",class:{"active-gene":e.activeGeneForRendering===r},attrs:{title:e.activeGeneForRendering===r?"当前用于渲染的基因":"点击使用此基因进行渲染"},on:{click:function(t){return t.stopPropagation(),e.handleColorIconClick(r)}}},[t("svg",{staticClass:"v-icon__svg",attrs:{viewBox:"0 0 24 24",role:"img","aria-hidden":"true"}},[t("path",{attrs:{d:"M12,19.58V19.58C10.4,19.58 8.89,18.96 7.76,17.83C6.62,16.69 6,15.19 6,13.58C6,12 6.62,10.47 7.76,9.34L12,5.1M17.66,7.93L12,2.27V2.27L6.34,7.93C3.22,11.05 3.22,16.12 6.34,19.24C7.9,20.8 9.95,21.58 12,21.58C14.05,21.58 16.1,20.8 17.66,19.24C20.78,16.12 20.78,11.05 17.66,7.93Z"}})])]),t("v-icon",{staticClass:"icon-set icon10",staticStyle:{"font-size":"20px"},on:{click:function(t){return t.stopPropagation(),e.removeItem(r)}}},[e._v("mdi-window-close")])],1)],1)]}}],null,!0)}),t("v-expansion-panel-content",[t("div",{staticClass:"gene-expression-panel"},[t("div",{staticClass:"gene-expression-stats"},[t("div",{staticClass:"expression-histogram"},[t("div",{staticClass:"histogram-header"},[e.selectedRange[r]?t("span",{staticClass:"selection-range"},[e._v(" Selection Range: "+e._s(e.formatExpression(e.selectedRange[r].start))+" - "+e._s(e.formatExpression(e.selectedRange[r].end))+" "),e.getSelectionStats(r)?t("span",{staticClass:"selection-stats"},[e._v(" ("+e._s(e.getSelectionStats(r).count)+" cells, "+e._s(e.getSelectionStats(r).percentage)+"%) ")]):e._e()]):e._e(),t("span",{staticClass:"expression-percentage"},[e._v(e._s(e.getExpressionPercentage(r))+"%")])]),t("div",{ref:"histogramContainer",refInFor:!0,staticClass:"histogram-container"},[t("svg",{ref:"histogramSvg",refInFor:!0,staticClass:"histogram-svg",attrs:{id:`histogram-${r}`,preserveAspectRatio:"none"},on:{mousedown:function(t){return e.startSelection(t,r)},mousemove:function(t){return e.updateSelection(t,r)},mouseup:function(t){return e.endSelection(r)},mouseleave:e.cancelSelection}},[t("g",{staticClass:"axis x-axis"},[t("text",{attrs:{x:"2%",y:"120"}},[e._v(e._s(e.getExpressionRange(r).min.toFixed(1)))]),t("text",{attrs:{x:"25%",y:"120"}},[e._v(e._s(e.getAxisTickValue(r,.25).toFixed(1)))]),t("text",{attrs:{x:"50%",y:"120"}},[e._v(e._s(e.getAxisTickValue(r,.5).toFixed(1)))]),t("text",{attrs:{x:"75%",y:"120"}},[e._v(e._s(e.getAxisTickValue(r,.75).toFixed(1)))]),t("text",{attrs:{x:"98%",y:"120","text-anchor":"end"}},[e._v(e._s(e.getExpressionRange(r).max.toFixed(1)))])]),e.currentSelectedGeneInfo[r]?t("g",{key:`bars-${r}-${Object.keys(e.currentSelectedGeneInfo).length}`,staticClass:"bars"},e._l(e.generateHistogramData(r),(function(n,i){return t("rect",{key:`${r}-bar-${i}-${n.count}`,attrs:{x:4+92*i/50+"%",y:100-n.height,width:"1.84%",height:n.height,fill:e.getBarColor(n,r,i),stroke:e.isInSelectionRange(n,r)?"#0D47A1":"none","stroke-width":e.isInSelectionRange(n,r)?.5:0}})})),0):e._e(),e.selectionActive&&e.currentSelectionGene===r?t("rect",{attrs:{x:e.selectionStart.x,y:0,width:e.getSelectionWidth(r),height:100,fill:"rgba(66, 133, 244, 0.2)",stroke:"#4285F4","stroke-width":"1"}}):e._e(),e.selectionActive||!e.selectedRange[r]||isNaN(e.getSelectionRangePosition(r).start)||isNaN(e.getSelectionRangePosition(r).width)?e._e():t("rect",{attrs:{x:e.getSelectionRangePosition(r).start,y:0,width:e.getSelectionRangePosition(r).width,height:100,fill:"rgba(66, 133, 244, 0.2)",stroke:"#4285F4","stroke-width":"1"}})])])]),t("div",{staticClass:"gene-info"},[t("div",{staticClass:"gene-avg-expression"},[e._v(e._s(e.getAverageExpression(r)))]),e.selectedRange[r]?t("v-btn",{staticClass:"ml-2",attrs:{"x-small":"",text:"",color:"error"},on:{click:function(t){return e.clearSelection(r)}}},[t("v-icon",{attrs:{"x-small":"",left:""}},[e._v("mdi-close")]),e._v("Clear Selection ")],1):e._e()],1)]),t("div",{staticClass:"expression-controls"},[t("v-btn",{staticClass:"download-btn",attrs:{small:"",icon:"",color:"primary"}},[t("v-icon",{attrs:{small:""}},[e._v("mdi-download")])],1)],1)])])],1)})),1)],1)])},L=[function(){var e=this,t=e._self._c;return t("p",[t("span",{staticClass:"color-block"}),t("span",{staticClass:"cell-row1-text"},[e._v("SELECTED VIEW")])])},function(){var e=this,t=e._self._c;return t("p",{staticStyle:{"font-size":"20px"}},[t("span",{staticStyle:{"margin-right":"5px"}},[e._v("Genes")])])}],O={name:"Genes",mixins:[E.o],data(){return{showBatchInput:!1,batchInput:"",geneSelected:[],histogramData:{},selectionActive:!1,selectionStart:{x:0,y:0},selectionEnd:{x:0,y:0},currentSelectionGene:null,selectedRange:{},currentSelectedGeneInfo:{},isUpdating:!1,name:"Midnight Crew",title:"The summer breeze",geneTotal:0,geneData:null,chunkCache:{},selectionStats:{},currentOpenPanel:null,geneColor:"",activeGeneForRendering:null}},computed:{...(0,o.aH)("cellData",["geneList","datasetName","geneExpRange"]),geneExp(){return this.getNonReactiveData("geneExp")||{}}},async mounted(){"undefined"!==typeof window&&window.addEventListener("datasetChanged",this.handleDatasetChange),await this.loadGeneList(),await this.loadMatrixInfo(),await this.autoSelectFirstGene(),this.loadSavedRanges()},beforeDestroy(){"undefined"!==typeof window&&window.removeEventListener("datasetChanged",this.handleDatasetChange)},methods:{...(0,o.i0)("cellData",["loadGeneExpression","loadGeneList"]),async handleDatasetChange(e){console.log("Genes组件: 数据集切换到",e.detail.dataset);try{this.chunkCache={},this.currentSelectedGeneInfo={},this.selectedRange={},this.selectionStats={},this.activeGeneForRendering=null,this.geneSelected=[],this.geneData=null,this.geneTotal=0,console.log("Genes: 已清除所有缓存和状态"),console.log("Genes: 重新加载基因列表..."),await this.loadGeneList(),console.log("Genes: 重新加载矩阵信息..."),await this.loadMatrixInfo(),this.$emit("getGeneExp",{}),this.$emit("currentRangeSelected",{gene:null,range:null,stats:null,geneData:null}),console.log("Genes: 数据集切换完成")}catch(t){console.error("Genes: 数据集切换失败:",t)}},async autoSelectFirstGene(){try{if(console.log("开始自动选择第一个基因..."),!this.geneList||0===this.geneList.length)return void console.warn("基因列表未加载，无法自动选择基因");const e=this.geneList.find((e=>"0610007P14Rik"===e.value));e?(this.geneSelected=[e.value],console.log(`成功自动选择基因: ${e.value}`)):(console.warn("未找到基因 0610007P14Rik，尝试使用列表中的第一个基因"),this.geneList.length>0&&(this.geneSelected=[this.geneList[0].value],console.log(`自动选择了第一个可用基因: ${this.geneList[0].value}`))),this.geneSelected.length>0&&await this.selectGene()}catch(e){console.error("自动选择第一个基因失败:",e)}},async loadMatrixInfo(){try{console.log("Genes: 开始加载矩阵信息...");const e=(0,l.buildDatasetPath)("matrix_info.json");console.log("Genes: 矩阵信息路径:",e);let t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);this.geneData=await t.json(),this.geneTotal=this.geneData.total_genes||(this.geneList?this.geneList.length:0),console.log("Genes: 矩阵信息加载成功"),console.log("Genes: 总基因数:",this.geneTotal),console.log("Genes: 总细胞数:",this.geneData.total_cells),console.log("Genes: 每个chunk的基因数:",this.geneData.genes_per_chunk)}catch(e){console.error("Genes: 加载基因矩阵信息失败:",e),this.geneTotal=this.geneList?this.geneList.length:0,this.geneData={total_genes:this.geneTotal,total_cells:0,genes_per_chunk:100}}},clearGenes(){console.log("清除所有基因"),this.geneSelected=[],this.currentSelectedGeneInfo={},this.selectedRange={},this.selectionStats={},this.activeGeneForRendering=null,this.$emit("getGeneExp",{}),this.$emit("currentRangeSelected",{gene:null,range:null,stats:null,geneData:null})},addBatchGenes(){if(!this.batchInput.trim())return void(this.showBatchInput=!1);const e=this.batchInput.split(",").map((e=>e.trim())).filter((e=>e)),t=[];for(const r of e){const e=this.geneList.find((e=>e.value.toLowerCase()===r.toLowerCase()));e&&!this.geneSelected.includes(e.value)&&t.push(e.value)}t.length>0&&(this.geneSelected=[...this.geneSelected,...t]),this.batchInput="",this.showBatchInput=!1},remove(e){const t=this.geneSelected.indexOf(e.value);if(t>=0){const e=this.geneSelected[t];if(delete this.currentSelectedGeneInfo[e],delete this.selectedRange[e],delete this.selectionStats[e],this.activeGeneForRendering===e){const t=this.geneSelected.filter((t=>t!==e));this.activeGeneForRendering=t.length>0?t[0]:null,console.log(`删除了活跃基因 ${e}，新的活跃基因: ${this.activeGeneForRendering}`)}if(this.geneSelected.splice(t,1),0===this.geneSelected.length)console.log("删除了最后一个基因，清除所有基因状态"),this.activeGeneForRendering=null,this.currentSelectedGeneInfo={},this.selectedRange={},this.selectionStats={},this.$emit("getGeneExp",{}),this.$emit("currentRangeSelected",{gene:null,range:null,stats:null,geneData:null});else if(this.activeGeneForRendering&&this.currentSelectedGeneInfo[this.activeGeneForRendering]){const e={[this.activeGeneForRendering]:this.currentSelectedGeneInfo[this.activeGeneForRendering]};this.$emit("getGeneExp",e),this.selectedRange[this.activeGeneForRendering]&&this.selectionStats[this.activeGeneForRendering]&&this.$emit("currentRangeSelected",{gene:this.activeGeneForRendering,range:this.selectedRange[this.activeGeneForRendering],stats:this.selectionStats[this.activeGeneForRendering],geneData:this.currentSelectedGeneInfo[this.activeGeneForRendering],color:!0})}else this.$emit("getGeneExp",{})}},removeItem(e){const t=this.geneSelected.indexOf(e);if(t>=0){if(delete this.currentSelectedGeneInfo[e],delete this.selectedRange[e],delete this.selectionStats[e],this.activeGeneForRendering===e){const t=this.geneSelected.filter((t=>t!==e));this.activeGeneForRendering=t.length>0?t[0]:null,console.log(`删除了活跃基因 ${e}，新的活跃基因: ${this.activeGeneForRendering}`)}if(this.geneSelected.splice(t,1),0===this.geneSelected.length)console.log("删除了最后一个基因，清除所有基因状态"),this.activeGeneForRendering=null,this.currentSelectedGeneInfo={},this.selectedRange={},this.selectionStats={},this.$emit("getGeneExp",{}),this.$emit("currentRangeSelected",{gene:null,range:null,stats:null,geneData:null});else if(this.activeGeneForRendering&&this.currentSelectedGeneInfo[this.activeGeneForRendering]){const e={[this.activeGeneForRendering]:this.currentSelectedGeneInfo[this.activeGeneForRendering]};this.$emit("getGeneExp",e),this.selectedRange[this.activeGeneForRendering]&&this.selectionStats[this.activeGeneForRendering]&&this.$emit("currentRangeSelected",{gene:this.activeGeneForRendering,range:this.selectedRange[this.activeGeneForRendering],stats:this.selectionStats[this.activeGeneForRendering],geneData:this.currentSelectedGeneInfo[this.activeGeneForRendering],color:!0})}else this.$emit("getGeneExp",{})}},async selectGene(e){if(this.isUpdating)console.log("selectGene: 正在更新中，跳过递归调用");else{if(!this.geneSelected||0===this.geneSelected.length)return console.log("selectGene: 没有选中的基因，清空状态"),this.currentSelectedGeneInfo={},this.selectedRange={},this.selectionStats={},this.activeGeneForRendering=null,this.$emit("getGeneExp",{}),void this.$emit("currentRangeSelected",{gene:null,range:null,stats:null,geneData:null});this.isUpdating=!0;try{console.log(`开始加载 ${this.geneSelected.length} 个基因的数据`);let e={};const t=new Set,r=new Map;for(let i=0;i<this.geneSelected.length;i++){const e=this.geneSelected[i],n=this.geneList.findIndex((t=>t.value===e));if(-1===n){console.warn(`基因 ${e} 在基因列表中未找到`);continue}if(!this.geneData||!this.geneData.genes_per_chunk){console.error("geneData 未正确初始化，无法计算chunk索引");continue}const a=Math.floor(n/this.geneData.genes_per_chunk),s=n%this.geneData.genes_per_chunk;console.log(`基因 ${e}: 索引=${n}, chunk=${a}, geneIndex=${s}`),t.add(a),r.set(e,{chunkIndex:a,geneIndex:s})}const n=[];for(const i of t)this.chunkCache[i]?console.log(`chunk ${i} 已在缓存中`):(console.log(`需要加载chunk ${i}`),n.push(this.loadChunkData(i)));n.length>0&&(console.log(`等待加载 ${n.length} 个chunk`),await Promise.all(n));for(let i=0;i<this.geneSelected.length;i++){const t=this.geneSelected[i],n=r.get(t);if(!n){console.warn(`基因 ${t} 的索引信息未找到`);continue}const{chunkIndex:a,geneIndex:s}=n;if(!this.chunkCache[a]||!this.chunkCache[a][s]){console.warn(`基因 ${t} 的数据未找到 (chunk: ${a}, index: ${s})`);continue}const o=this.chunkCache[a][s];e[t]=o,console.log(`基因 ${t} 数据加载完成: 长度=${o.length}, 前5个值=[${o.slice(0,5).join(", ")}]`);const l=o.filter((e=>e>0)).length,c=Math.max(...o),u=Math.min(...o.filter((e=>e>0)));console.log(`基因 ${t} 统计: 非零值=${l}, 最大值=${c.toFixed(3)}, 最小非零值=${u.toFixed(3)}`)}if(this.currentSelectedGeneInfo=e,console.log("所有基因数据加载完成:",Object.keys(this.currentSelectedGeneInfo)),this.validateGeneDataDifferences(),!this.activeGeneForRendering&&this.geneSelected.length>0&&(this.activeGeneForRendering=this.geneSelected[0],console.log(`自动设置第一个基因 ${this.activeGeneForRendering} 为活跃基因`)),this.activeGeneForRendering&&e[this.activeGeneForRendering]){const t={[this.activeGeneForRendering]:e[this.activeGeneForRendering]};this.$emit("getGeneExp",t)}else this.$emit("getGeneExp",this.currentSelectedGeneInfo);for(const i of this.geneSelected)if(!this.selectedRange[i]){const e=this.getExpressionRange(i);this.selectedRange[i]={start:e.min,end:e.max},this.calculateSelectionStats(i)}this.saveSelectedRanges(),this.activeGeneForRendering&&this.selectedRange[this.activeGeneForRendering]&&(console.log(`自动发送活跃基因 ${this.activeGeneForRendering} 的默认选择范围`),this.$emit("currentRangeSelected",{gene:this.activeGeneForRendering,range:this.selectedRange[this.activeGeneForRendering],stats:this.selectionStats[this.activeGeneForRendering],geneData:e[this.activeGeneForRendering],color:!0})),this.$nextTick((()=>{this.$forceUpdate(),console.log("强制更新组件完成，直方图应该已重新渲染")}))}catch(t){console.error("selectGene 执行出错:",t)}finally{this.isUpdating=!1}}},async loadChunkData(e){console.log(`Loading chunk ${e}`);const t=(0,l.buildDatasetPath)(`genes/chunk_${e}.bin`);console.log(`Genes: 加载chunk路径: ${t}`);let r=await fetch(t);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);let n=await r.arrayBuffer();console.log(n,38666);let i=new DataView(n),a=[];const s=this.geneData.total_cells;let o=i.byteLength/(4*s);for(let l=0;l<o;l++){let e=[];for(let t=0;t<s;t++){let r=4*(l*s+t);e.push(i.getFloat32(r,!0))}a.push(e)}return this.chunkCache[e]=a,a},async getGeneData(e){let t=this.geneList.findIndex((t=>t.value===e)),r=Math.floor(t/this.geneData.genes_per_chunk),n=t%this.geneData.genes_per_chunk;return this.chunkCache[r]||await this.loadChunkData(r),{exps:this.chunkCache[r][n]}},generateHistogramData(e){if(console.log(`生成基因 ${e} 的直方图数据`),!this.currentSelectedGeneInfo[e])return console.warn(`基因 ${e} 的表达数据不存在`),[];const t=this.currentSelectedGeneInfo[e];console.log(`基因 ${e} 的表达数据长度: ${t.length}`),console.log(`基因 ${e} 的前10个表达值:`,t.slice(0,10));const r=t.filter((e=>e>0));if(console.log(`基因 ${e} 的非零值数量: ${r.length}`),0===r.length)return console.warn(`基因 ${e} 没有非零表达值`),[];const n=this.getExpressionRange(e),i=n.min,a=n.max;console.log(`基因 ${e} 的表达范围: min=${i.toFixed(3)}, max=${a.toFixed(3)}`);const s=50,o=(a-i)/s,l=Array(s).fill(0).map(((e,t)=>{const r=i+t*o,n=i+(t+1)*o;return{value:r,binStart:r,binEnd:n,count:0,height:0}}));r.forEach((e=>{const t=Math.min(Math.floor((e-i)/o),s-1);t>=0&&l[t].count++}));const c=Math.max(...l.map((e=>e.count)));l.forEach((e=>{e.height=e.count>0?e.count/c*90:0}));const u=l.reduce(((e,t)=>e+t.count),0),h=l.filter((e=>e.count>0)).length;return console.log(`基因 ${e} 直方图统计: 总计数=${u}, 非空柱子=${h}, 最大计数=${c}`),l},getExpressionPercentage(e){if(!this.currentSelectedGeneInfo[e])return"0.0";const t=this.currentSelectedGeneInfo[e],r=t.filter((e=>e>0)).length,n=r/t.length*100;return n.toFixed(1)},getAverageExpression(e){if(!this.currentSelectedGeneInfo[e])return"";const t=this.currentSelectedGeneInfo[e],r=t.reduce(((e,t)=>e+t),0),n=r/t.length;return n.toExponential(5)},getExpressionRange(e){if(!this.currentSelectedGeneInfo[e])return{min:0,max:0};const t=this.currentSelectedGeneInfo[e],r=t.filter((e=>e>0));if(0===r.length)return{min:0,max:1};const n=Math.min(...r),i=Math.max(...r);return{min:n,max:i}},calculateExpressionValue(e,t,r){const n=this.getExpressionRange(r),i=n.min,a=n.max,s=.04*t,o=.04*t,l=t-s-o,c=Math.max(0,Math.min(e-s,l)),u=l>0?c/l:0;return i+u*(a-i)},startSelection(e,t){if(e.preventDefault(),!this.currentSelectedGeneInfo[t])return;this.selectionActive=!0,this.currentSelectionGene=t;const r=e.currentTarget,n=r.getBoundingClientRect(),i=e.clientX-n.left;this.selectionStart={x:i},this.selectionEnd={x:i},this.selectedRange[t]={start:this.calculateExpressionValue(i,n.width,t),end:this.calculateExpressionValue(i,n.width,t)},this.saveSelectedRanges()},updateSelection(e,t){if(e.preventDefault(),!this.selectionActive||this.currentSelectionGene!==t)return;const r=e.currentTarget,n=r.getBoundingClientRect(),i=Math.max(0,Math.min(e.clientX-n.left,n.width));this.selectionEnd={x:i};const a=this.calculateExpressionValue(this.selectionStart.x,n.width,t),s=this.calculateExpressionValue(i,n.width,t);this.selectedRange[t]={start:Math.min(a,s),end:Math.max(a,s)}},endSelection(e){if(!this.selectionActive||this.currentSelectionGene!==e)return;if(this.selectionActive=!1,Math.abs(this.selectionEnd.x-this.selectionStart.x)<5)return delete this.selectedRange[e],delete this.selectionStats[e],this.saveSelectedRanges(),void this.$emit("currentRangeSelected",{gene:e,range:null,stats:null,geneData:null});this.calculateSelectionStats(e),this.improveSelectionAccuracy(e);const t=this.currentSelectedGeneInfo[e];this.$emit("currentRangeSelected",{gene:e,range:this.selectedRange[e],stats:this.selectionStats[e],geneData:t,color:this.geneColor}),this.saveSelectedRanges(),this.$forceUpdate()},cancelSelection(e){e&&e.preventDefault(),this.selectionActive=!1},isInSelectionRange(e,t){const r=this.selectedRange[t];if(!r)return!1;if(r.start===r.end)return!1;const n=Math.min(r.start,r.end),i=Math.max(r.start,r.end);return e.binStart<=i&&e.binEnd>=n},getSelectionWidth(e){return this.selectionActive&&this.currentSelectionGene===e?Math.abs(this.selectionEnd.x-this.selectionStart.x):0},scaledX(e){return 4+92*e/50+"%"},saveSelectedRanges(){try{localStorage.setItem("geneSelectionRanges",JSON.stringify(this.selectedRange)),localStorage.setItem("geneSelectionStats",JSON.stringify(this.selectionStats))}catch(e){console.error("Failed to save selection ranges:",e)}},loadSavedRanges(){try{const e=localStorage.getItem("geneSelectionRanges"),t=localStorage.getItem("geneSelectionStats");e&&(this.selectedRange=JSON.parse(e)),t&&(this.selectionStats=JSON.parse(t))}catch(e){console.error("Failed to load selection ranges:",e)}},calculateSelectionStats(e){if(!this.selectedRange[e]||!this.currentSelectedGeneInfo[e])return;const t=this.selectedRange[e],r=this.currentSelectedGeneInfo[e],n=Math.min(t.start,t.end),i=Math.max(t.start,t.end),a=r.filter((e=>e>=n-1e-4&&e<=i+1e-4)).length,s=r.length,o=(a/s*100).toFixed(1);this.selectionStats[e]={count:a,percentage:o}},getSelectionStats(e){return this.selectionStats[e]},clearSelection(e){delete this.selectedRange[e],delete this.selectionStats[e],this.saveSelectedRanges(),this.$emit("currentRangeSelected",{gene:e,range:null,stats:null,geneData:null}),this.$forceUpdate()},formatExpression(e){return e.toFixed(2)},getSelectionRangePosition(e){if(!this.selectedRange[e])return{start:0,width:0};const t=this.selectedRange[e],r=document.getElementById(`histogram-${e}`);if(!r)return{start:0,width:0};const n=r.getBoundingClientRect().width,i=this.getExpressionRange(e),a=i.min,s=i.max,o=s-a;if(o<=0)return{start:0,width:0};const l=.04*n,c=.92*n,u=(t.start-a)/o,h=(t.end-a)/o,d=l+u*c,f=l+h*c;return{start:Math.min(d,f),width:Math.max(1,Math.abs(f-d))}},getAxisTickValue(e,t){const r=this.getExpressionRange(e),n=r.min,i=r.max;return n+t*(i-n)},emitAllSelectionRanges(){const e={};for(const t in this.selectedRange)this.selectedRange[t]&&this.selectionStats[t]&&(e[t]={gene:t,range:this.selectedRange[t],stats:this.selectionStats[t]});this.$emit("currentRangeSelected",e[this.currentSelectionGene]||[])},handlePanelClick(e,t=!1){this.currentOpenPanel=e,this.geneColor=t||this.geneColor,this.selectedRange[e]&&this.selectionStats[e]&&this.$emit("currentRangeSelected",{gene:e,range:this.selectedRange[e],stats:this.selectionStats[e],geneData:this.currentSelectedGeneInfo[e],color:this.geneColor})},emitCurrentSelectionRange(){if(!this.currentOpenPanel)return;const e=this.currentOpenPanel;this.selectedRange[e]&&this.selectionStats[e]&&this.$emit("currentRangeSelected",{gene:e,range:this.selectedRange[e],stats:this.selectionStats[e],geneData:this.currentSelectedGeneInfo[e]})},handleColorClicked(e){this.geneColor=e,this.$emit("getGeneColor",this.geneColor)},getBarColor(e,t,r){if(this.isInSelectionRange(e,t))return"#1976D2";if(this.geneColor){const r=this.getExpressionRange(t),{min:n,max:i}=r,a=i-n,s=(e.value-n)/a,o=Math.round(160+90*s);return`rgb(25, ${o}, 210)`}return"#E0E0E0"},handleColorIconClick(e){if(console.log(`切换活跃基因为: ${e}`),this.activeGeneForRendering=e,this.currentSelectedGeneInfo[e]){const t={[e]:this.currentSelectedGeneInfo[e]};console.log(`发送基因 ${e} 的表达数据用于渲染`),this.$emit("getGeneExp",t),this.selectedRange[e]&&this.selectionStats[e]&&this.$emit("currentRangeSelected",{gene:e,range:this.selectedRange[e],stats:this.selectionStats[e],geneData:this.currentSelectedGeneInfo[e],color:!0})}},validateGeneDataDifferences(){console.log("=== 验证基因数据差异 ===");const e=Object.keys(this.currentSelectedGeneInfo);if(e.length<2)console.log("基因数量少于2个，无法比较差异");else{for(let t=0;t<e.length;t++)for(let r=t+1;r<e.length;r++){const n=e[t],i=e[r],a=this.currentSelectedGeneInfo[n],s=this.currentSelectedGeneInfo[i],o=a.slice(0,10),l=s.slice(0,10),c=JSON.stringify(o)===JSON.stringify(l);console.log(`比较 ${n} vs ${i}:`),console.log(`  ${n} 前10个值: [${o.join(", ")}]`),console.log(`  ${i} 前10个值: [${l.join(", ")}]`),console.log(`  前10个值是否相同: ${c}`);const u=this.getGeneStats(n),h=this.getGeneStats(i);console.log(`  ${n} 统计: ${JSON.stringify(u)}`),console.log(`  ${i} 统计: ${JSON.stringify(h)}`)}console.log("=== 验证完成 ===")}},getGeneStats(e){const t=this.currentSelectedGeneInfo[e];if(!t)return null;const r=t.filter((e=>e>0));return{total:t.length,nonZero:r.length,min:r.length>0?Math.min(...r).toFixed(3):0,max:r.length>0?Math.max(...r).toFixed(3):0,avg:r.length>0?(r.reduce(((e,t)=>e+t),0)/r.length).toFixed(3):0}},improveSelectionAccuracy(e){if(!this.selectedRange[e])return;const t=this.selectedRange[e],r=this.generateHistogramData(e);if(!r||0===r.length)return;let n=t.start,i=t.end,a=1/0,s=1/0;r.forEach((e=>{const r=Math.abs(e.binStart-t.start),o=Math.abs(e.binEnd-t.end);r<a&&(a=r,n=e.binStart),o<s&&(s=o,i=e.binEnd)}));const o=Math.abs(n-t.start)/(t.end-t.start),l=Math.abs(i-t.end)/(t.end-t.start);console.log(`基因 ${e} 选择精度调整:`),console.log(`  原始范围: ${t.start.toFixed(3)} - ${t.end.toFixed(3)}`),console.log(`  调整后范围: ${n.toFixed(3)} - ${i.toFixed(3)}`),console.log(`  调整比例: 起点=${(100*o).toFixed(1)}%, 终点=${(100*l).toFixed(1)}%`),o<.1&&l<.1?(this.selectedRange[e]={start:Math.min(n,i),end:Math.max(n,i)},console.log("  应用了精度调整"),this.calculateSelectionStats(e)):console.log("  调整幅度过大，保持原始选择")}}},z=O,F=(0,h.A)(z,R,L,!1,null,"569a8cbd",null),M=F.exports,V=function(){var e=this,t=e._self._c;return t("v-row",{staticClass:"single-cell-graph",staticStyle:{height:"100%"}},[e._l(e.graphNum,(function(r){return t("v-col",{key:r,staticStyle:{height:"100%"},attrs:{cols:e.drawer?9:12/e.graphNum}},[t("v-progress-linear",{directives:[{name:"show",rawName:"v-show",value:e.loading,expression:"loading"}],attrs:{indeterminate:"",color:"yellow darken-2"}}),t("div",{staticClass:"graph-brain"},[t("GraphControls",{attrs:{datasetName:e.datasetName,colorBy:e.colorBy,filterNum:e.filterNum,operateActive:e.operateActive,graphNum:e.graphNum},on:{changeOperator:e.changeOperator,openSelectDrawer:e.openSelectDrawer,separateGraph:e.separateGraph,deleteSeparateGraph:e.deleteSeparateGraph,downloadImage:e.downloadImage}}),t("v-row",{staticStyle:{"flex-shrink":"0",flex:"1"}},[t("v-col",{attrs:{cols:"12"}},["single"===e.datasetType?t("ScatterBrainSingle",{key:e.refKey,ref:"singleChart",refInFor:!0,attrs:{operate:e.operateActive,typeInfo:e.typeInfo,colorData:e.colorData,umapData:e.partialData,dataRange:e.dataRange,colorRange:e.colorRange,total:e.total,quadTree:e.quadTree,hoverVal:e.hoverCategory,nodeMap:e.nodeMap,sizeData:e.sizeData,colorBy:e.colorBy,selectedTypes:e.selectedTypes,typeClass:e.typeClass,typeItem:e.typeItem,typeValue:e.typeValue,operatorType:e.operatorType,filterNum:e.filterNum,field:e.field,fieldValue:e.fieldValue,geneData:e.geneData,geneExpRange:e.geneExpRange},on:{selectArea:e.selectArea}}):t("ScatterBrainMultiple",{key:e.refKey,ref:"multipleChart",refInFor:!0,attrs:{operate:e.operateActive,typeInfo:e.typeInfo,colorData:e.colorData,umapData:e.partialData,dataRange:e.dataRange,colorRange:e.colorRange,total:e.total,quadTree:e.quadTree,hoverVal:e.hoverCategory,nodeMap:e.nodeMap,sizeData:e.sizeData,colorBy:e.colorBy,selectedTypes:e.selectedTypes,typeClass:e.typeClass,typeItem:e.typeItem,typeValue:e.typeValue,operatorType:e.operatorType,filterNum:e.filterNum,field:e.field,fieldValue:e.fieldValue,summaryData:e.summaryData},on:{selectArea:e.selectArea}})],1)],1)],1)],1)})),e.drawer?t("v-col",{staticStyle:{height:"100vh","border-left":"1px solid #eee"},attrs:{cols:3}},[t("div",{staticClass:"drawer-title"},[t("h3",[e._v("Selected Cells")]),t("v-icon",{on:{click:e.handleCloseDrawer}},[e._v("mdi-close")])],1),t("v-list",{staticStyle:{"overflow-y":"auto"},attrs:{height:"30vh"}},[t("v-list-item-group",{attrs:{color:"primary"},model:{value:e.selectedItem,callback:function(t){e.selectedItem=t},expression:"selectedItem"}},e._l(e.selectNodes,(function(r,n){return t("v-list-item",{key:n,on:{click:function(t){return e.changeCellItem(n)}}},[t("v-list-item-avatar",[t("span",{staticClass:"color-circle",style:{backgroundColor:e._.get(r,"key","#fff")}})]),t("v-list-item-content",[t("v-list-item-title",[e._v(" "+e._s(e._.get(r,["value",0,"node",e.colorBy],""))+" ")])],1),t("v-list-item-action",[t("span",[e._v(e._s(e._.get(r,["value","length"],"")))])])],1)})),1)],1),t("div",{staticStyle:{"border-top":"2px solid #eee",height:"60vh","overflow-y":"auto"}},[t("div",{staticClass:"drawer-title ml-2"},[t("div",{staticStyle:{display:"flex","align-items":"center",width:"60%"}},[t("span",{staticClass:"color-circle",style:{backgroundColor:e._.get(e.selectInfo,"key","#fff")}}),t("span",{staticClass:"ml-3 text-hidden",staticStyle:{width:"50%"}},[e._v(e._s(e._.get(e.selectInfo,["value",0,"node","Siletti_modf_SCANVI_L1"],"")))])]),t("v-icon",{staticStyle:{flex:"1"}},[e._v("mdi-download")])],1),t("virtual-list",{attrs:{"data-key":"id","data-sources":e._.get(e.selectInfo,"value",[]),"data-component":e.itemComponent,keeps:e._.get(e.selectInfo,["value","length"],0)}})],1)],1):e._e()],2)},B=[],H=function(){var e=this,t=e._self._c;return t("div",{staticStyle:{height:"100%"}},[t("div",{ref:"scatterBrain",staticStyle:{height:"100%"},attrs:{id:"canvasContainer"}})])},N=[],P=r(867),G=r.n(P);class j{constructor(e){this.id=e.id,this.boundary=e.boundary,this.pointsCount=e.points_count||0,this.hasFile=e.has_file||!1,this.children=null,this.points=null,e.children&&(this.children={nw:e.children.nw?new j(e.children.nw):null,ne:e.children.ne?new j(e.children.ne):null,sw:e.children.sw?new j(e.children.sw):null,se:e.children.se?new j(e.children.se):null})}containsPoint(e,t){if(!this.boundary)return!1;const[r,n,i,a]=this.boundary;return e>=r&&e<=i&&t>=n&&t<=a}getArea(){if(!this.boundary)return 0;const[e,t,r,n]=this.boundary;return(r-e)*(n-t)}intersectsBounds(e){if(!this.boundary)return!1;const[t,r,n,i]=this.boundary;return!(n<e.minX||t>e.maxX||i<e.minY||r>e.maxY)}}class W{constructor(e){if(!e||!e.root)throw new Error("无效的四叉树数据");this.blocksCount=e.total_blocks||0,this.root=new j(e.root),this.nodeCache=new Map,this.cacheLimit=1e3,this.stats={cacheHits:0,cacheMisses:0,totalSearches:0}}getNodeArea(e){return e?e.getArea():0}findNodeByPoint(e,t){this.stats.totalSearches++;const r=`point_${e.toFixed(3)}_${t.toFixed(3)}`;if(this.nodeCache.has(r))return this.stats.cacheHits++,this.nodeCache.get(r);this.stats.cacheMisses++;const n=this._findNodeByPointInternal(this.root,e,t);if(this.nodeCache.size>=this.cacheLimit){const e=this.nodeCache.keys().next().value;this.nodeCache.delete(e)}return this.nodeCache.set(r,n),n}_findNodeByPointInternal(e,t,r,n=0){if(!e||!e.containsPoint(t,r))return null;if(!e.children)return e;let i=null,a=1/0;for(const s of Object.values(e.children)){if(!s||!s.containsPoint(t,r))continue;const e=this._findNodeByPointInternal(s,t,r,n+1);if(e){const t=this.getNodeArea(e);(!i||t<a)&&(i=e,a=t)}}return i&&i.pointsCount>0?i:e}findMultiplePoints(e){const t=new Map;for(const r of e)t.set(r,this.findNodeByPoint(r[0],r[1]));return t}findNodesInRange(e,t){if(!e)return[];if(!e.intersectsBounds(t))return[];let r=[];if(e.hasFile&&r.push(e),e.children)for(const n of Object.values(e.children))n&&r.push(...this.findNodesInRange(n,t));return r}getPerformanceStats(){const e=this.stats.totalSearches>0?(this.stats.cacheHits/this.stats.totalSearches*100).toFixed(2):0;return{...this.stats,cacheHitRate:`${e}%`,cacheSize:this.nodeCache.size}}clearCache(){this.nodeCache.clear(),this.stats={cacheHits:0,cacheMisses:0,totalSearches:0}}}var q=r(1614),U=r(374),X=r(4201),Y=r(7876),Z=r.n(Y),K=r(6445);class Q{constructor(e,t={}){this.container=e,this.options={pointSize:2,defaultZoom:1,defaultOffset:[0,0],antialiasing:!0,responderActive:!0,selectionEnabled:!0,hoverThrottleTime:50,highlightSize:1.3,...t},this.state={zoom:this.options.defaultZoom,offsetX:this.options.defaultOffset[0],offsetY:this.options.defaultOffset[1],isPanning:!1,isSelecting:!1,selectionMode:!1,selectionStart:null,selectionEnd:null,selectionVisible:!1,selectedIndices:[],hoverCategory:-1,isZooming:!1,targetZoom:this.options.defaultZoom,velocity:{x:0,y:0},inertiaEnabled:!0,lastMousePosition:null,lastTime:0,isChunkLoading:!1,renderPending:!1,lastRenderTime:0,renderInterval:16,animationFrameId:null,viewportRatio:1,isDirty:!0,selectionStartData:null,selectionEndData:null,lastHoverTime:0,highlightAttributeName:null,highlightAttributeValues:[],highlightFilter:null,isTransitioning:!1,transitionTimer:null,isMouseInListArea:!1,hoverAttributeName:null,hoverValueIndex:-1,highlightByAttribute:!1,isCheckHighlight:!1,multiAttributeHighlight:{enabled:!1,attributes:new Map,isCheckHighlight:!1}},this.resources={canvas:null,regl:null,drawScatter:null,positionBuffer:null,geneBuffer:null,vertexIdBuffer:null,filterTexture:null,textureSize:[0,0],colorTexture:null,highlightTexture:null,hoverTexture:null,geneColorTexture:null},this.data={dataRange:{},colorIndex:0,textureIndex:0,treeMap:new Map,total:0,count:0,quadTree:null,field:[],filterNum:0,nodeIndices:new Map,geneData:null,geneExpressionRange:null},this.callbacks={onDataLoaded:null,onPointSelected:null,onPointHovered:null},this.renderFrame=this.renderFrame.bind(this),this.throttledHoverPoint=this.throttle(this.hoverPoint.bind(this),this.options.hoverThrottleTime)}throttle(e,t){return async(...r)=>{const n=Date.now();if(n-this.state.lastHoverTime>=t)return this.state.lastHoverTime=n,await e(...r)}}async initialize(){try{U.Sr.startMark("initializeRenderer");const e=document.createElement("canvas");this.resources.canvas=e,this.container.appendChild(e);const t=window.devicePixelRatio||1;this.state.viewportRatio=t,e.width=this.container.offsetWidth*t,e.height=this.container.offsetHeight*t,e.style.width="100%",e.style.height="100%";const r=["OES_texture_float","EXT_color_buffer_float","OES_texture_float_linear","OES_standard_derivatives"];this.resources.regl=Z().overrideContextType((()=>G()({canvas:e,extensions:r,attributes:{alpha:!0,antialias:this.options.antialiasing,depth:!0,preserveDrawingBuffer:!0},onDone:e=>{e?console.error("REGL初始化失败:",e):console.log("REGL初始化成功")}}))),this.setupEventListeners(),this.resources.filterTexture=this.resources.regl.texture({width:1e3,height:1,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrapS:"clamp",wrapT:"clamp"}),this.startRenderLoop();const n=U.Sr.endMark("initializeRenderer");return console.log(`渲染器初始化完成，耗时: ${n.toFixed(2)}ms`),!0}catch(e){return console.error("初始化渲染器失败:",e),this.handleError("初始化渲染器时",e),!1}}setupEventListeners(){const e=this.resources.canvas;if(e.addEventListener("wheel",(e=>{e.preventDefault(),this.smoothZoom(e.deltaY)})),this.setPanningMode(),window.addEventListener("resize",this.handleResize.bind(this)),window.ResizeObserver){const e=this.createDebouncedResize();this.resizeObserver=new ResizeObserver((t=>{try{for(const r of t)if(r.target===this.container){console.log("ResizeObserver: 容器尺寸变化"),e();break}}catch(r){r.message&&r.message.includes("ResizeObserver loop")?console.warn("ResizeObserver循环检测，已忽略:",r.message):console.error("ResizeObserver错误:",r)}})),this.resizeObserver.observe(this.container),console.log("ResizeObserver已设置，监听容器尺寸变化")}else console.warn("ResizeObserver不可用，仅使用window resize事件")}createDebouncedResize(){let e=null,t=!1;return()=>{t||(e&&clearTimeout(e),e=setTimeout((()=>{if(this.container&&this.resources.canvas&&this.resources.regl){t=!0;try{this.handleResize()}catch(e){console.error("处理resize时出错:",e)}finally{t=!1}}else console.warn("组件已销毁，跳过resize处理")}),50))}}async loadData(e={}){try{U.Sr.startMark("loadData");const{quadTreePath:t=(0,l.buildDatasetPath)("quad_tree.json"),total:r=1e5,field:n=[],colorBy:i="",colorIndex:a=0}=e;if("number"!==typeof r||r<=0)throw console.error(`无效的total参数: ${r}，必须为正数`),new Error(`无效的total参数: ${r}，必须为正数`);Array.isArray(n)&&0!==n.length?this.data.field=n:(console.warn("字段列表为空或不是数组，将使用默认空数组"),this.data.field=[]),"number"!==typeof a||a<0||n.length>0&&a>=n.length?(console.warn(`无效的colorIndex: ${a}，将使用默认值0`),this.data.colorIndex=0):this.data.colorIndex=a,this.data.total=r,console.log(`开始加载数据: total=${r}, field.length=${n.length}, colorIndex=${this.data.colorIndex}`),console.log(`从 ${t} 加载四叉树`);const s=await K.dataLoader.loadQuadTree(t),o=new W(s);this.data.quadTree=o,this.data.dataRange={min_x:o.root.boundary[0],max_x:o.root.boundary[2],min_y:o.root.boundary[1],max_y:o.root.boundary[3]},this.data.treeMap.set("tree",o);const c=Math.max(1,4*r*2);this.resources.geneBuffer=this.resources.regl.buffer(new Float32Array(c).fill(-1)),this.resources.filterTexture=this.resources.regl.texture({width:100,height:1,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp"}),await this.loadTreeChunks(o,r),this.callbacks.onDataLoaded&&this.callbacks.onDataLoaded({total:this.data.count,dataRange:this.data.dataRange});const u=U.Sr.endMark("loadData");return console.log(`数据加载完成，耗时: ${u.toFixed(2)}ms，加载了${this.data.count}个点`),!0}catch(t){return console.error("加载数据失败:",t),this.handleError("加载数据时",t),!1}}async loadTreeChunks(e,t=1e5){U.Sr.startMark("loadTreeChunks");try{this.state.isChunkLoading=!0,console.log(`开始加载四叉树数据块，预估总点数: ${t}`);const n=Math.ceil(1.2*t),i=4*n*2;console.log(`创建位置缓冲区，容量: ${n} 个点 (${(i/1024/1024).toFixed(2)} MB)`),this.resources.positionBuffer=this.resources.regl.buffer({length:i,type:"float",usage:"dynamic"}),this.resources.positionBufferCapacity=n;const a=this.resources.regl._gl.getParameter(this.resources.regl._gl.MAX_TEXTURE_SIZE),s=n,o=Math.min(a,Math.ceil(Math.sqrt(s))),l=Math.ceil(s/o);this.resources.textureSize=[o,l],this.resources.textureCapacity=o*l,console.log(`纹理初始化: 容量=${this.resources.textureCapacity}, 尺寸=${o}x${l}`),this.resources.vertexIdBuffer=new Float32Array(Array.from({length:n},((e,t)=>t))),console.log("创建单一的颜色纹理，用于存储当前选择的属性"),this.resources.colorTexture=this.resources.regl.texture({shape:[o,l],format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp",data:new Float32Array(o*l*4).fill(0)});const c=[],u=e=>{e.hasFile&&c.push(e.id),e.children&&Object.values(e.children).filter((e=>null!==e)).forEach(u)};if(u(e.root),console.log(`需要加载${c.length}个数据块的坐标数据`),this.data.colorIndex>=0&&this.data.colorIndex<this.data.field.length){const e=this.data.field[this.data.colorIndex];console.log(`加载当前选中的属性数据: ${e}`),await this.loadCellAttribute(e)}const h=[e.root];let d=0,f=0;const g=3;this.data.nodeIndices=new Map;const p=e=>{console.log(`坐标数据加载进度: ${(100*e).toFixed(1)}%`)};while(h.length>0){const e=h.shift();try{if(e.hasFile){U.Sr.startMark(`processChunk:${e.id}`);const{points:r,count:n}=await K.dataLoader.loadCoordinateBlock(e.id);if(n>0){this.data.nodeIndices.set(e.id,{startIndex:d,count:n});let i=[];for(let e=0;e<r.length;e+=2)i.push([r[e],r[e+1]]);const a=d+n;a>this.resources.positionBufferCapacity&&(console.warn(`检测到数据量超出预期，当前: ${a}, 容量: ${this.resources.positionBufferCapacity}`),await this.expandBuffers(a)),this.resources.positionBuffer.subdata(i,2*d*4),this.data.colorIndex>=0&&await this.updateTextureForAttribute(this.data.colorIndex,d,n,e.id),d+=n,f++,f%g!==0&&0!==h.length||(p(d/t),this.resources.drawScatter?this.scheduleRender(!0):this.createDrawCommand())}U.Sr.endMark(`processChunk:${e.id}`)}e.children&&Object.values(e.children).filter((e=>null!==e)).forEach((e=>h.push(e)))}catch(r){console.error(`加载节点 ${e.id} 失败:`,r)}}this.data.count=d,this.state.isChunkLoading=!1,this.resources.drawScatter?this.scheduleRender(!0):this.createDrawCommand();const m=U.Sr.endMark("loadTreeChunks");return U.un.checkLoadTime(m),!0}catch(r){return console.error("加载四叉树数据块失败:",r),this.state.isChunkLoading=!1,!1}}async expandBuffers(e){try{const t=Math.ceil(1.3*e),r=4*t*2;console.log(`扩展缓冲区: 从 ${this.resources.positionBufferCapacity} 扩展到 ${t} 个点`);const n=this.resources.positionBuffer;this.resources.positionBufferCapacity;this.resources.positionBuffer=this.resources.regl.buffer({length:r,type:"float",usage:"dynamic"}),n&&this.data.count>0&&(console.log("需要重新加载已有数据到扩展后的缓冲区"),this.state.needsDataReload=!0),this.resources.positionBufferCapacity=t;const i=this.resources.regl._gl.getParameter(this.resources.regl._gl.MAX_TEXTURE_SIZE),a=Math.min(i,Math.ceil(Math.sqrt(t))),s=Math.ceil(t/a),o=(this.resources.textureSize,this.resources.colorTexture);this.resources.textureSize=[a,s],this.resources.textureCapacity=a*s,this.resources.colorTexture=this.resources.regl.texture({shape:[a,s],format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp",data:new Float32Array(a*s*4).fill(0)}),this.resources.vertexIdBuffer=new Float32Array(Array.from({length:t},((e,t)=>t))),n&&n.destroy(),o&&o.destroy(),console.log(`缓冲区扩展完成: 新容量=${t}, 新纹理尺寸=${a}x${s}`)}catch(t){throw console.error("扩展缓冲区失败:",t),t}}async resetForNewDataset(e=null){try{if(console.log("重置渲染器以准备加载新数据集..."),e)try{console.log(`清理旧数据集 ${e} 的缓存数据...`),await(0,q.SM)(e)}catch(t){console.warn("清理缓存时出错，但继续重置过程:",t)}this.resources.positionBuffer&&(this.resources.positionBuffer.destroy(),this.resources.positionBuffer=null),this.resources.colorTexture&&(this.resources.colorTexture.destroy(),this.resources.colorTexture=null),this.resources.highlightTexture&&(this.resources.highlightTexture.destroy(),this.resources.highlightTexture=null),this.resources.hoverTexture&&(this.resources.hoverTexture.destroy(),this.resources.hoverTexture=null),this.resources.geneColorTexture&&(this.resources.geneColorTexture.destroy(),this.resources.geneColorTexture=null),this.resources.positionBufferCapacity=0,this.resources.textureCapacity=0,this.resources.textureSize=[0,0],this.resources.vertexIdBuffer=null,this.data.count=0,this.data.total=0,this.data.nodeIndices.clear(),this.data.quadTree=null,this.data.treeMap.clear(),this.state.isChunkLoading=!1,this.state.needsDataReload=!1,this.state.hasValidData=!1,console.log("渲染器重置完成，准备接受新数据集")}catch(r){throw console.error("重置渲染器时发生错误:",r),r}}createDatasetCacheKey(e){const t=(0,l.vh)();return t?`${t}_${e}`:(console.warn("无法获取当前数据集，使用默认缓存键"),e)}async safeGetMapData(e){try{const t=this.createDatasetCacheKey(e);return await(0,q.Vv)(t)}catch(t){if("VersionError"===t.name){console.warn(`IndexedDB版本冲突，重置数据库后重试获取数据: ${e}`);try{return await(0,q.$7)(),null}catch(r){console.error("重置IndexedDB失败:",r)}}return console.error(`从IndexedDB获取数据失败 (${e}):`,t),null}}async loadCellAttribute(e){try{if(console.log(`ScatterRenderer: 开始加载属性: ${e}`),this.data.attributeCache||(this.data.attributeCache=new Map),this.data.attributeCache.has(e))return console.log(`ScatterRenderer: 属性 ${e} 已在缓存中，跳过加载`),!0;const t=this.data.field.findIndex((t=>t===e));if(t<0)return console.error(`属性 ${e} 不在字段列表中`),!1;const r=(0,l.buildDatasetPath)(`cell_types/${e}.bin`);console.log(`ScatterRenderer: 从路径加载: ${r}`);const n=await K.dataLoader.loadCellAttribute(e,(t=>{console.log(`ScatterRenderer: 属性 ${e} 加载进度: ${(100*t).toFixed(1)}%`)}));if(!n||0===n.length)return console.error(`属性 ${e} 数据加载失败`),!1;console.log(`ScatterRenderer: 属性 ${e} 加载完成，数据长度: ${n.length}`),this.data.attributeCache.set(e,n),this.resources.colorTexture&&(this.resources.colorTexture.destroy(),this.resources.colorTexture=null),this.resources.colorTexture=this.resources.regl.texture({shape:this.resources.textureSize,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp"}),console.log(`正在更新颜色纹理数据，总点数: ${this.data.total}`);const i=this.resources.textureSize[0],a=this.resources.textureSize[1];for(let e=0;e<a;e++){const t=e*i,r=Math.min(i,this.data.total-t);if(r<=0)break;e%10===0&&console.log(`更新第 ${e}/${a} 行，包含 ${r} 个点`);const s=new Float32Array(4*r);for(let e=0;e<r;e++){const r=t+e;s[4*e]=r<n.length?n[r]:0,s[4*e+1]=0,s[4*e+2]=0,s[4*e+3]=0}this.resources.colorTexture.subimage({data:s,width:r,height:1},0,e)}return console.log(`颜色纹理更新完成，属性: ${e}`),this.state.isDirty=!0,!0}catch(t){return console.error(`加载属性 ${e} 时出错:`,t),!1}}async updateTextureForAttribute(e,t,r,n){try{const n=this.data.field[e];let i;if(this.data.attributeCache&&this.data.attributeCache.has(n)?i=this.data.attributeCache.get(n):(i=await K.dataLoader.loadCellAttribute(n),this.data.attributeCache||(this.data.attributeCache=new Map),this.data.attributeCache.set(n,i)),!i||0===i.length)return void console.error(`属性 ${n} 数据不可用`);if(!this.resources.colorTexture)return void console.error("颜色纹理不存在");let a=new Float32Array(4*r).fill(0);for(let e=0;e<r;e++){const r=t+e;r<i.length&&(a[4*e]=i[r]||0)}let s=Math.floor(t/this.resources.textureSize[0]),o=t%this.resources.textureSize[0],l=r,c=0;while(l>0){let e=this.resources.textureSize[0]-o,t=Math.min(l,e),r=a.subarray(4*c,4*(c+t));this.resources.colorTexture.subimage({data:r,width:t,height:1},o,s),c+=t,l-=t,o=0,s+=1}}catch(i){console.error(`更新属性 ${this.data.field[e]} 纹理时出错:`,i)}}async setColorAttribute(e){try{if(!this.data.field||!Array.isArray(this.data.field)||0===this.data.field.length)return console.error("字段列表为空，无法设置颜色属性"),!1;let t=e;(void 0===e||null===e||e<0||e>=this.data.field.length)&&(console.warn(`属性索引 ${e} 超出范围[0, ${this.data.field.length-1}]，使用默认值0`),t=0);const r=this.data.field[t];console.log(`切换到属性: ${r} (索引: ${t})`),this.data.attributeCache&&this.data.attributeCache.has(r)&&this.data.attributeCache.delete(r),this.resources.colorTexture&&this.resources.colorTexture.destroy&&(this.resources.colorTexture.destroy(),this.resources.colorTexture=null),console.log(`正在加载属性数据: ${r}`);const n=await this.loadCellAttribute(r);if(!n)return console.error(`加载属性 ${r} 失败`),!1;if(this.data.colorIndex=t,this.resources.drawScatter)console.log(`已更新colorIndex为 ${t}，将在下次渲染时传递`);else{console.warn("绘制命令不存在，尝试重新创建");const e=this.createDrawCommand();if(!e)return console.error("无法创建绘制命令，无法继续渲染"),!1}return console.log("属性已更新，请求重新渲染"),this.state.isDirty=!0,!0}catch(t){return console.error("切换属性时出错:",t),!1}}async setHighlightAttribute(e,t){try{if(!e||void 0===t||t<0)return console.log(`高亮参数无效: ${e}:${t}，清除高亮`),this.clearHighlight(),!1;if(console.log(`设置高亮属性: ${e}, 值: ${t}`),!this.data.field||!Array.isArray(this.data.field))return console.error("字段列表无效，无法设置高亮"),!1;const r=this.data.field.indexOf(e);if(-1===r)return console.error(`属性 ${e} 不在字段列表中，可用字段: ${this.data.field.join(", ")}`),!1;const n=await this.loadHighlightAttributeData(e);if(!n||0===n.length)return console.error(`无法加载属性 ${e} 的数据，或数据为空`),!1;const i=Math.max(...Array.from(n).filter((e=>!isNaN(e))));if(t>i&&console.warn(`属性值 ${t} 超出数据范围 [0, ${i}]`),this.resources.highlightTexture||(console.log(`创建高亮纹理，尺寸: ${this.resources.textureSize}`),this.resources.highlightTexture=this.resources.regl.texture({shape:this.resources.textureSize,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp"})),this.state.highlightAttributeName=e,this.state.highlightAttributeValues=[t],console.log(`更新高亮纹理数据，总点数: ${this.data.total}`),!this.resources.textureSize||!Array.isArray(this.resources.textureSize)||2!==this.resources.textureSize.length||this.resources.textureSize[0]<=0||this.resources.textureSize[1]<=0)return console.error(`纹理尺寸无效: ${this.resources.textureSize}`),!1;const a=this.resources.textureSize[0],s=this.resources.textureSize[1];for(let e=0;e<s;e++){const t=e*a,r=Math.min(a,Math.max(0,this.data.total-t));if(r<=0)break;const i=new Float32Array(4*r);for(let e=0;e<r;e++){const r=t+e;let a=!1;if(r<n.length){const e=n[r];a=void 0!==e&&this.state.highlightAttributeValues.some((t=>Math.abs(e-t)<.01))}i[4*e]=0,i[4*e+1]=0,i[4*e+2]=0,i[4*e+3]=a?1:0}this.resources.highlightTexture.subimage({data:i,width:r,height:1},0,e)}return console.log(`高亮纹理更新完成，属性: ${e}, 值: ${t}`),this.state.isDirty=!0,!0}catch(r){return console.error("设置高亮属性时出错:",r),this.clearHighlight(),!1}}async loadHighlightAttributeData(e){try{if(console.log(`加载高亮属性数据: ${e}`),this.data.attributeCache&&this.data.attributeCache.has(e)){const t=this.data.attributeCache.get(e);return t||new Float32Array(0)}const t=await K.dataLoader.loadCellAttribute(e),r=t instanceof Float32Array&&t.length>0?t:new Float32Array(0);return this.data.attributeCache||(this.data.attributeCache=new Map),this.data.attributeCache.set(e,r),r}catch(t){return console.error(`加载高亮属性 ${e} 时出错:`,t),new Float32Array(0)}}clearHighlight(){if(this.state.highlightAttributeName=null,this.state.highlightAttributeValues=[],this.resources.highlightTexture){const t=this.resources.textureSize[0],r=this.resources.textureSize[1];try{const e=new Float32Array(t*r*4).fill(0);this.resources.highlightTexture.subimage({data:e,width:t,height:r}),console.log("高亮纹理已清除")}catch(e){console.error("清除高亮纹理时出错:",e)}}this.state.isDirty=!0,this.state.animationFrameId||(this.state.animationFrameId=requestAnimationFrame(this.renderFrame))}createDrawCommand(){try{if(console.log("开始创建绘制命令..."),console.log("渲染器状态:",{hasRegl:!!this.resources.regl,hasPositionBuffer:!!this.resources.positionBuffer,hasColorTexture:!!this.resources.colorTexture,hasGeneBuffer:!!this.resources.geneBuffer,hasGeneColorTexture:!!this.resources.geneColorTexture,dataTotal:this.data.total,dataCount:this.data.count}),!this.resources.regl||!this.resources.positionBuffer)return console.error("无法创建绘制命令：REGL或位置缓冲区不存在"),!1;const e="#version 300 es\n      precision highp float;\n      precision highp int;\n      \n      in vec2 position;\n      in float vertexId;\n      in float gene;\n      uniform float zoom;\n      uniform vec2 xRange;\n      uniform vec2 yRange;\n      uniform vec2 geneExpRange;\n      uniform float aspectRatio;\n      uniform mat4 transform;\n      uniform bool geneColor;\n      uniform float viewportRatio;\n\n      uniform sampler2D pointDataTexture[1]; // 只使用一个纹理\n      uniform sampler2D geneColorTexture; // 基因颜色纹理\n      uniform bool hasGeneData; // 是否有基因数据\n      uniform vec2 textureSize;\n      uniform int filterNum;\n      out float v_localIndex;\n      uniform sampler2D filterTexture;\n      out vec4 v_color;\n      out float v_size;\n      uniform float hoverCategory;\n      uniform int currentColorField;\n      \n      // 从纹理获取颜色数据\n      vec4 getTextureData(vec2 uv) {\n        return texture(pointDataTexture[0], uv);\n      }\n      \n      // 从基因颜色纹理获取颜色\n      vec4 getGeneColor(vec2 uv) {\n        return texture(geneColorTexture, uv);\n      }\n      \n      uniform sampler2D highlightTexture; // 高亮纹理\n      uniform sampler2D hoverTexture; // 悬停纹理\n      uniform float highlightSize; // 高亮点大小倍数\n      uniform bool hasHighlight; // 是否有高亮状态\n      uniform bool isAttributeHighlight; // 添加isAttributeHighlight声明\n      uniform bool isCheckHighlight; // 添加isCheckHighlight声明，勾选高亮时非高亮点变灰\n      \n      // 检查点是否被高亮\n      bool isHighlighted(vec2 uv) {\n        if (!hasHighlight) return false;\n        vec4 highlightData = texture(highlightTexture, uv);\n        return highlightData.a > 0.5; // 使用alpha通道存储高亮状态\n      }\n      \n      // 检查点是否被悬停高亮\n      bool isHovered(vec2 uv) {\n        vec4 hoverData = texture(hoverTexture, uv);\n        return hoverData.a > 0.5; // 使用alpha通道存储悬停状态\n      }\n\n      vec3 getColorFromValue(float value) {\n        // 使用多层次颜色映射\n        float baseHue = mod(value * 0.618033988749895, 1.0);\n        float colorGroup = floor(mod(value, 5.0)); \n        float secondaryShift = colorGroup * 0.2 + mod(float(currentColorField) * 0.1, 0.2);\n        float hue = mod(baseHue + secondaryShift, 1.0);\n        float saturation = 0.6 + mod(value, 1.0) * 0.3;\n        float brightness = 0.7 + mod(value * 7.0, 1.0) * 0.2;\n        \n        vec3 rgb = vec3(0.0);\n        float h = hue * 6.0;\n        float i = floor(h);\n        float f = h - i;\n        float p = brightness * (1.0 - saturation);\n        float q = brightness * (1.0 - saturation * f);\n        float t = brightness * (1.0 - saturation * (1.0 - f));\n\n        if (i == 0.0) rgb = vec3(brightness, t, p);\n        else if (i == 1.0) rgb = vec3(q, brightness, p);\n        else if (i == 2.0) rgb = vec3(p, brightness, t);\n        else if (i == 3.0) rgb = vec3(p, q, brightness);\n        else if (i == 4.0) rgb = vec3(t, p, brightness);\n        else rgb = vec3(brightness, p, q);\n        \n        return rgb;\n      }\n\n      float checkAllFilters(vec2 uv) {\n        int count=0;\n        bool result = false;\n        bool isFirstCondition = true;\n        bool preResult = false;\n        bool prePreResult = false;\n        \n        if(filterNum == 0) {\n          vec4 data = getTextureData(uv);\n          return data.x; // 值始终存储在R通道\n        }\n        \n        for(int i=0; i<filterNum; i++) {\n          if(i >= filterNum) break; // 提前终止\n          \n          vec4 filterCondition=texelFetch(filterTexture, ivec2(i,0), 0);\n          int typeClass = int(filterCondition.r);\n          int typeItem = int(filterCondition.g);\n          float expectedValue = filterCondition.b;\n          int operatorType = int(filterCondition.a);\n        \n          // 从纹理读取数据\n          vec4 data0 = getTextureData(uv);\n          float value=-1.0;\n          float colorValue = data0.x; // 值始终存储在R通道\n          \n          bool cond = (abs(colorValue - expectedValue) < 0.001);\n          \n          if(i == 0) {\n              result = cond;\n          } else {\n              if(operatorType == 1) { // OR\n                  result = result || cond;\n              } else if(operatorType == 2) {\n                result = result ||(prePreResult && cond);\n              } else { // AND\n                  result = result && cond;\n              }\n          }\n          if(operatorType != 2) {\n            prePreResult = preResult;\n            preResult = result;\n          }\n        }\n        \n        if(result) {\n          vec4 data = getTextureData(uv);\n          return data.x; // 值始终存储在R通道\n        } else {\n          return -1.0;\n        }\n      }\n      \n      void main() {\n        vec2 normalized = vec2(\n          ((position.x - xRange.x) / (xRange.y - xRange.x) * 2.0 - 1.0) * 0.4,\n          ((position.y - yRange.x) / (yRange.y - yRange.x) * 2.0 - 1.0) * 0.4 * aspectRatio\n        );\n        \n        v_localIndex = vertexId;\n\n        float row = floor(vertexId / textureSize.x);\n        float col = mod(vertexId, textureSize.x);\n        vec2 uv = vec2(\n          (col + 0.5) / textureSize.x,\n          (row + 0.5) / textureSize.y\n        );\n\n        // 从纹理读取数据\n        float value = checkAllFilters(uv);\n\n        // 检查点是否被高亮\n        bool pointHighlighted = isHighlighted(uv);\n        \n        // 属性悬停相关变量\n        bool isAttributeHoverMode = (hoverCategory == -999.0);\n        bool pointIsHovered = false;\n        if (isAttributeHoverMode) {\n          pointIsHovered = isHovered(uv);\n        }\n\n        // 优先使用基因颜色纹理\n        if(hasGeneData && value >= 0.0) {\n          vec4 geneColorData = getGeneColor(uv);\n          v_color = geneColorData;\n        } else if(geneColor && gene > 0.0 && (geneExpRange.x == -1.0 || geneExpRange.y == -1.0 || (gene >= geneExpRange.x && gene <= geneExpRange.y))) {\n          // 基因染色模式\n          float intensity = clamp(gene / 3.0, 0.0, 1.0);\n          vec3 redColor = vec3(0.94, 0.35, 0.35);\n          vec3 purpleColor = vec3(0.55, 0.16, 0.63);\n          vec3 finalColor = mix(redColor, purpleColor, intensity);\n          v_color = vec4(finalColor, 1.0);\n        } else {\n            // 🔧 修复：统一颜色计算逻辑，先计算基本颜色，再根据筛选和高亮状态调整\n            vec3 rgb;\n            float alpha = 0.8;  // 默认透明度\n            \n            // 计算基本颜色（无论是否符合筛选条件）\n            if(value >= 0.0) {\n                // 符合筛选条件的点，使用属性值计算颜色\n                rgb = getColorFromValue(value);\n            } else {\n                // 不符合筛选条件的点，使用当前染色属性的默认颜色\n                vec4 data = getTextureData(uv);\n                rgb = getColorFromValue(data.x); // 使用实际属性值计算颜色\n            }\n            \n            // 判断是否处于悬停高亮模式\n            bool isHoverMode = hoverCategory != -1.0;\n            \n            // 🔧 修复：重新组织悬浮和高亮的优先级逻辑，确保悬浮效果在勾选后依然可见\n            bool hoverEffectApplied = false;\n            \n            // 首先处理悬浮效果（最高优先级）\n            if (isAttributeHoverMode && pointIsHovered) {\n                rgb *= 1.3; // 悬浮时增加更多亮度，确保可见\n                alpha = 1.0; // 完全不透明\n                hoverEffectApplied = true;\n            } else if (isHoverMode && value == hoverCategory) {\n                rgb *= 1.3; // 悬浮时增加更多亮度，确保可见\n                alpha = 1.0; // 完全不透明\n                hoverEffectApplied = true;\n            }\n            \n            // 然后处理高亮状态（当没有悬浮效果时）\n            if (!hoverEffectApplied && hasHighlight) {\n                if (pointHighlighted) {\n                    // 🔧 修复：符合勾选条件的点保持原色，不增亮\n                    alpha = 1.0; // 完全不透明\n                } else if (isCheckHighlight) {\n                    // 勾选高亮模式下，非高亮点变灰\n                    rgb = vec3(0.35, 0.35, 0.35);\n                    alpha = 0.7;\n                }\n            }\n            \n            // 最后处理属性悬浮模式下非悬浮点的变暗效果\n            if (isAttributeHoverMode && !pointIsHovered && !hoverEffectApplied) {\n                rgb *= 0.85;\n                alpha = 0.6;\n            }\n            \n            // 🔧 修复：最后处理不符合筛选条件的点\n            if(value < 0.0 && !hasHighlight) {\n                // 只有在没有高亮状态时，不符合筛选条件的点才变灰\n                rgb = vec3(0.4, 0.4, 0.4);\n                alpha = 0.8;\n            }\n            \n            v_color = vec4(rgb, alpha);\n        }\n\n        // 计算点的大小和Z值\n        float scale = 1.0;\n        float zValue = 0.0;\n        \n        // 🔧 修复：重新组织点大小和层级的优先级，确保悬浮效果优先级最高\n        // 悬浮效果具有最高优先级\n        if ((isAttributeHoverMode && pointIsHovered) || (value==hoverCategory && hoverCategory!=-1.0)) {\n            // 悬浮时稍微放大，但不如勾选那么明显\n            scale = 1.2;\n            zValue = -0.7; // 悬浮点显示在最上层\n        } else if(pointHighlighted) {\n            // 高亮点增大，但比之前小一些\n            scale = highlightSize;\n            zValue = -0.6; // 高亮点显示在第二层\n        } else if(value < 0.0) {\n            zValue = 0.5; // 灰色点放在后面\n        }\n        \n        // 保存点大小供片段着色器使用 - 减小基础大小从3.0到2.0\n        v_size = 2.0 * zoom * scale;\n        \n        gl_Position = transform * vec4(normalized, zValue, 1);\n        \n        // 使用viewportRatio确保在高DPI显示器上点大小正确\n        gl_PointSize = v_size * viewportRatio;\n      }\n      ",t="#version 300 es\n      precision highp float;\n      precision highp int;\n      in float v_localIndex;\n      in vec4 v_color;\n      in float v_size;\n      out vec4 fragColor;\n      uniform bool useAntialiasing;\n     \n      void main() {\n        // 计算到圆心的距离\n        vec2 cxy = 2.0 * gl_PointCoord - 1.0;\n        float r = dot(cxy, cxy);\n        \n        // 基本圆形\n        if (r > 1.0) {\n          discard;\n        }\n        \n        vec4 color = v_color;\n        \n        // 应用抗锯齿\n        if (useAntialiasing) {\n          // 使用固定的delta值代替fwidth计算\n          float delta = 0.05;\n          float alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\n          \n          // 应用抗锯齿\n          color.a *= alpha;\n          \n          // 增加点的半径方向渐变以使其更自然\n          float gradient = 1.0 - (r * 0.3); // 减小渐变程度，使颜色更均匀\n          color.rgb *= gradient;\n        }\n        \n        // 输出最终颜色\n        fragColor = color;\n      }";return this.resources.drawScatter=this.resources.regl({viewport:{x:0,y:0,width:()=>this.resources.canvas.width,height:()=>this.resources.canvas.height},frag:t,vert:e,attributes:{position:this.resources.regl.prop("position"),vertexId:this.resources.vertexIdBuffer,gene:this.resources.geneBuffer},uniforms:{transform:this.resources.regl.prop("transform"),zoom:this.resources.regl.prop("zoom"),xRange:[this.data.dataRange.min_x,this.data.dataRange.max_x],yRange:[this.data.dataRange.min_y,this.data.dataRange.max_y],aspectRatio:()=>{const e=this.container.clientWidth,t=this.container.clientHeight;return e/Math.max(t,1)},"pointDataTexture[0]":(e,t)=>t.colorTexture,highlightTexture:(e,t)=>t.highlightTexture,hoverTexture:(e,t)=>t.hoverTexture||t.colorTexture,textureSize:(e,t)=>t.textureSize,filterTexture:(e,t)=>t.filterTexture||t.colorTexture,hoverCategory:this.resources.regl.prop("hoverCategory"),filterNum:this.resources.regl.prop("filterNum"),currentColorField:this.resources.regl.prop("currentColorField"),geneExpRange:(e,t)=>t.geneExpRange.range?[t.geneExpRange.range.start,t.geneExpRange.range.end]:[-1,-1],geneColor:(e,t)=>!!t.geneExpRange.color,viewportRatio:()=>this.state.viewportRatio,useAntialiasing:()=>this.options.antialiasing,highlightSize:()=>this.options.highlightSize,hasHighlight:(e,t)=>t.hasHighlight,isAttributeHighlight:(e,t)=>t.isAttributeHighlight||!1,isCheckHighlight:(e,t)=>t.isCheckHighlight||!1,geneColorTexture:(e,t)=>t.geneColorTexture||this.resources.colorTexture,hasGeneData:(e,t)=>t.hasGeneData||!1},count:this.data.total,primitive:"points",depth:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:"src alpha",dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"}}}),this.state.isDirty=!0,!0}catch(e){return console.error("创建绘制命令失败:",e),this.handleError("创建绘制命令时",e),this.resources.drawScatter=null,!1}}setPanningMode(){const e=this.resources.canvas;this.boundStartSelection&&(e.removeEventListener("mousedown",this.boundStartSelection,{capture:!0}),e.removeEventListener("mousemove",this.boundUpdateSelection,{capture:!0}),e.removeEventListener("mouseup",this.boundEndSelection,{capture:!0})),this.boundStartPanning=this.startPanning.bind(this),this.boundEndPanning=this.endPanning.bind(this),this.boundHandleMouseMove=this.handleMouseMove.bind(this),e.addEventListener("mousedown",this.boundStartPanning),e.addEventListener("mouseup",this.boundEndPanning),e.addEventListener("mousemove",this.boundHandleMouseMove),this.state.isSelecting=!1,this.state.selectionMode=!1,this.state.selectionVisible=!1,e.style.cursor="grab",this.state.isDirty=!0,console.log("已切换回平移模式，选区框已清除")}setSelectionMode(){if(!this.options.selectionEnabled)return void console.warn("选区功能已禁用");const e=this.resources.canvas;this.boundStartPanning&&(e.removeEventListener("mousedown",this.boundStartPanning),e.removeEventListener("mouseup",this.boundEndPanning),e.removeEventListener("mousemove",this.boundHandleMouseMove)),this.boundStartSelection=this.startSelection.bind(this),this.boundUpdateSelection=this.updateSelection.bind(this),this.boundEndSelection=this.endSelection.bind(this),e.addEventListener("mousedown",this.boundStartSelection,{capture:!0}),e.addEventListener("mousemove",this.boundUpdateSelection,{capture:!0}),e.addEventListener("mouseup",this.boundEndSelection,{capture:!0}),this.state.isPanning=!1,this.state.lastMousePosition=null,this.state.selectionMode=!0,e.style.cursor="crosshair",console.log("已切换到选区模式，可以进行区域选择")}startPanning(e){this.state.selectionMode||(e.preventDefault(),this.state.isPanning=!0,this.state.lastMousePosition={x:e.clientX,y:e.clientY},this.state.velocity={x:0,y:0},this.state.lastTime=performance.now(),this.resources.canvas.style.cursor="grabbing")}endPanning(){this.state.isPanning=!1,this.resources.canvas.style.cursor="grab",this.state.inertiaEnabled&&(Math.abs(this.state.velocity.x)>.01||Math.abs(this.state.velocity.y)>.01)&&this.applyInertia()}handleMouseMove(e){"select"!==this.getMode()&&(this.state.isPanning&&this.state.lastMousePosition?this.pan(e):this.throttledHoverPoint(e))}scheduleRender(e=!1){this.state.isDirty=!0,e&&!this.state.animationFrameId&&(this.state.animationFrameId=requestAnimationFrame((()=>{this.renderFrame(),this.state.animationFrameId=null})))}createTransformMatrix(){return[this.state.zoom*this.state.zoom,0,0,0,0,this.state.zoom*this.state.zoom,0,0,0,0,1,0,this.state.offsetX,this.state.offsetY,0,1]}dispose(){try{if(null!==this.state.animationFrameId&&(cancelAnimationFrame(this.state.animationFrameId),this.state.animationFrameId=null),this.resources.canvas){this.resources.canvas.removeEventListener("wheel",this.smoothZoom),this.boundStartPanning&&(this.resources.canvas.removeEventListener("mousedown",this.boundStartPanning),this.resources.canvas.removeEventListener("mouseup",this.boundEndPanning),this.resources.canvas.removeEventListener("mousemove",this.boundHandleMouseMove)),this.boundStartSelection&&(this.resources.canvas.removeEventListener("mousedown",this.boundStartSelection,{capture:!0}),this.resources.canvas.removeEventListener("mousemove",this.boundUpdateSelection,{capture:!0}),this.resources.canvas.removeEventListener("mouseup",this.boundEndSelection,{capture:!0}));const e=this.handleResize.bind(this);window.removeEventListener("resize",e)}if(this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null,console.log("ResizeObserver已清理")),this.resources.regl){this.resources.positionBuffer&&this.resources.positionBuffer.destroy&&(this.resources.positionBuffer.destroy(),this.resources.positionBuffer=null),this.resources.vertexIdBuffer&&this.resources.vertexIdBuffer.destroy&&(this.resources.vertexIdBuffer.destroy(),this.resources.vertexIdBuffer=null),this.resources.geneBuffer&&this.resources.geneBuffer.destroy&&(this.resources.geneBuffer.destroy(),this.resources.geneBuffer=null),this.resources.filterTexture&&this.resources.filterTexture.destroy&&(this.resources.filterTexture.destroy(),this.resources.filterTexture=null),this.resources.colorTexture&&this.resources.colorTexture.destroy&&(this.resources.colorTexture.destroy(),this.resources.colorTexture=null),this.resources.highlightTexture&&this.resources.highlightTexture.destroy&&(this.resources.highlightTexture.destroy(),this.resources.highlightTexture=null),this.resources.hoverTexture&&this.resources.hoverTexture.destroy&&(this.resources.hoverTexture.destroy(),this.resources.hoverTexture=null),this.resources.geneColorTexture&&this.resources.geneColorTexture.destroy&&(this.resources.geneColorTexture.destroy(),this.resources.geneColorTexture=null),this.resources.textures&&this.resources.textures.length>0&&(this.resources.textures.forEach((e=>{e&&e.destroy&&e.destroy()})),this.resources.textures=[]);const e=this.resources.regl._gl;if(this.resources.regl.destroy&&(this.resources.regl.destroy(),this.resources.regl=null),e){e.getExtension("WEBGL_lose_context")?.loseContext();const t=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(let n=0;n<t;n++)e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_2D,null),e.bindTexture(e.TEXTURE_CUBE_MAP,null);e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null);const r=e.getParameter(e.MAX_VERTEX_ATTRIBS);for(let n=0;n<r;n++)e.disableVertexAttribArray(n)}}return this.resources.canvas&&this.resources.canvas.parentNode&&(this.resources.canvas.parentNode.removeChild(this.resources.canvas),this.resources.canvas=null),this.data.treeMap.clear(),this.data.quadTree=null,this.data.total=0,this.data.count=0,this.data.attributeCache&&(this.data.attributeCache.clear(),this.data.attributeCache=null),this.state={zoom:this.options.defaultZoom,offsetX:this.options.defaultOffset[0],offsetY:this.options.defaultOffset[1],isPanning:!1,isSelecting:!1,selectionMode:!1,selectionStart:null,selectionEnd:null,selectionVisible:!1,selectedIndices:[],hoverCategory:-1,isZooming:!1,targetZoom:this.options.defaultZoom,viewportRatio:1,isDirty:!1,selectionStartData:null,selectionEndData:null},this.boundStartPanning=null,this.boundEndPanning=null,this.boundHandleMouseMove=null,this.boundStartSelection=null,this.boundUpdateSelection=null,this.boundEndSelection=null,window.gc&&window.gc(),console.log("渲染器资源已完全释放"),!0}catch(e){return console.error("释放资源时发生错误:",e),this.handleError("释放资源时",e),!1}}handleError(e,t){if(console.error(`${e}:`,t),this.container){const e=document.createElement("div");e.className="renderer-error",e.textContent=`渲染错误: ${t.message||"未知错误"}`,e.style.cssText="color: red; padding: 20px; background: rgba(255,255,255,0.9); position: absolute; top: 10px; left: 10px; z-index: 1000; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);";const r=document.createElement("button");r.textContent="×",r.style.cssText="margin-left: 10px; background: none; border: none; cursor: pointer;",r.onclick=()=>e.remove(),e.appendChild(r),this.container.appendChild(e),setTimeout((()=>{e.parentNode&&e.remove()}),1e4)}}pan(e){if(this.state.selectionMode)return;if(!this.state.isPanning||!this.state.lastMousePosition)return;const t=performance.now(),r=t-this.state.lastTime;this.state.lastTime=t;const n=e.movementX,i=e.movementY;r>0&&(this.state.velocity.x=.8*n+.2*this.state.velocity.x,this.state.velocity.y=.8*i+.2*this.state.velocity.y),this.state.offsetX+=2*n*this.state.zoom/(this.state.zoom*this.resources.canvas.width),this.state.offsetY-=2*i*this.state.zoom/(this.state.zoom*this.resources.canvas.height),this.state.lastMousePosition={x:e.clientX,y:e.clientY},this.scheduleRender()}applyInertia(){const e=.95,t=()=>{if(Math.abs(this.state.velocity.x)<.01&&Math.abs(this.state.velocity.y)<.01)return;this.state.velocity.x*=e,this.state.velocity.y*=e;const r=this.state.velocity.x/(this.state.zoom*this.resources.canvas.width),n=this.state.velocity.y/(this.state.zoom*this.resources.canvas.height);this.state.offsetX+=2*r*this.state.zoom,this.state.offsetY-=2*n*this.state.zoom,this.scheduleRender(),requestAnimationFrame(t)};t()}smoothZoom(e){const t=.1;this.state.targetZoom+=e<0?t:-t,this.state.targetZoom=Math.max(.1,this.state.targetZoom),this.state.isZooming||(this.state.isZooming=!0,this.animateZoom())}animateZoom(){this.state.zoom+=.2*(this.state.targetZoom-this.state.zoom),Math.abs(this.state.targetZoom-this.state.zoom)<.01?(this.state.zoom=this.state.targetZoom,this.state.isZooming=!1):requestAnimationFrame(this.animateZoom.bind(this)),this.scheduleRender()}handleResize(){if(this.container&&this.resources.canvas&&this.resources.regl)if(document.contains(this.container)){console.log("ScatterRenderer: 开始处理尺寸变化");try{const t=this.container.offsetWidth,r=this.container.offsetHeight;if(console.log(`ScatterRenderer: 容器尺寸 - 宽度: ${t}, 高度: ${r}`),0===t||0===r)return void console.warn("ScatterRenderer: 容器尺寸为0，跳过尺寸更新");const n=window.devicePixelRatio||1;this.state.viewportRatio=n;const i=Math.floor(t*n),a=Math.floor(r*n);if(this.resources.canvas.width===i&&this.resources.canvas.height===a)return void console.log("ScatterRenderer: 画布尺寸未变化，跳过更新");console.log(`ScatterRenderer: 更新画布尺寸 - 宽度: ${i}, 高度: ${a}, 像素比: ${n}`),this.resources.canvas.width=i,this.resources.canvas.height=a,this.resources.canvas.style.width=t+"px",this.resources.canvas.style.height=r+"px";try{this.resources.regl&&this.resources.regl._gl&&(this.resources.regl._gl.viewport(0,0,i,a),console.log(`ScatterRenderer: REGL视口已更新为 ${i}x${a}`))}catch(e){console.error("ScatterRenderer: 更新REGL视口时出错:",e)}this.state.aspectRatio=t/r,this.state.isDirty=!0,this.scheduleRender(!0),console.log("ScatterRenderer: 尺寸更新完成，已请求重新渲染")}catch(e){console.error("ScatterRenderer: 处理尺寸变化时出错:",e)}}else console.warn("ScatterRenderer: 容器已从DOM中移除，跳过尺寸更新");else console.warn("ScatterRenderer: 关键资源未初始化，跳过尺寸更新")}getMousePositionInWebGL(e){const t=this.container.getBoundingClientRect(),r=(e.clientX-t.left)/t.width*2-1,n=-((e.clientY-t.top)/t.height*2-1);return[r,n]}getDataCoordinates(e){const[t,r]=e,n=this.container.clientWidth/this.container.clientHeight,i=this.createTransformMatrix(),a=i[0],s=(t-i[12])/a,o=(r-i[13])/a,l=(s/.4+1)/2*(this.data.dataRange.max_x-this.data.dataRange.min_x)+this.data.dataRange.min_x,c=(o/(.4*n)+1)/2*(this.data.dataRange.max_y-this.data.dataRange.min_y)+this.data.dataRange.min_y;return[l,c]}getWebGLCoordinates(e){const[t,r]=e,n=this.container.clientWidth/this.container.clientHeight,i=.4*((t-this.data.dataRange.min_x)/(this.data.dataRange.max_x-this.data.dataRange.min_x)*2-1),a=.4*((r-this.data.dataRange.min_y)/(this.data.dataRange.max_y-this.data.dataRange.min_y)*2-1)*n,s=this.createTransformMatrix(),o=i*s[0]+s[12],l=a*s[5]+s[13];return[o,l]}startSelection(e){e.preventDefault(),e.stopPropagation(),this.state.isPanning=!1,this.state.isSelecting=!0;const t=this.getMousePositionInWebGL(e),r=this.getDataCoordinates(t);this.state.selectionStartData=r,this.state.selectionEndData=r,this.state.selectionStart=t,this.state.selectionEnd=t,this.resources.canvas.style.cursor="crosshair",console.log("开始选区: ",{webGLCoords:t,dataCoords:r}),this.scheduleRender()}updateSelection(e){if(!this.state.isSelecting)return;e.preventDefault(),e.stopPropagation();const t=this.getMousePositionInWebGL(e),r=this.getDataCoordinates(t);this.state.selectionEndData=r,this.state.selectionEnd=t,console.log("更新选区: ",{start:this.state.selectionStartData,end:r}),this.scheduleRender()}async endSelection(e){if(!this.state.isSelecting)return;e.preventDefault(),e.stopPropagation();const t=this.getMousePositionInWebGL(e),r=this.getDataCoordinates(t);this.state.selectionEndData=r,this.state.selectionEnd=t;const n=Math.min(this.state.selectionStartData[0],this.state.selectionEndData[0]),i=Math.max(this.state.selectionStartData[0],this.state.selectionEndData[0]),a=Math.min(this.state.selectionStartData[1],this.state.selectionEndData[1]),s=Math.max(this.state.selectionStartData[1],this.state.selectionEndData[1]),o=Math.abs(i-n)>.001&&Math.abs(s-a)>.001;if(console.log("结束选区: ",{start:this.state.selectionStartData,end:r,hasSelection:o,selectionBox:{minX:n,maxX:i,minY:a,maxY:s}}),this.state.isSelecting=!1,o){this.state.selectionVisible=!0;const e=await this.getSelectedPoints();this.callbacks.onPointSelected&&this.callbacks.onPointSelected(e)}else this.clearSelection();this.scheduleRender(),this.resources.canvas.style.cursor="crosshair"}async getSelectedPoints(){if(!this.state.selectionStartData||!this.state.selectionEndData)return[];const[e,t]=this.state.selectionStartData,[r,n]=this.state.selectionEndData,i=Math.min(e,r),a=Math.max(e,r),s=Math.min(t,n),o=Math.max(t,n);console.log("选区范围（数据坐标）:",i,a,s,o);const l=this.data.treeMap.get("tree");if(!l)return[];const c=l.findNodesInRange(l.root,{minX:i,maxX:a,minY:s,maxY:o});console.log("选区内找到节点数:",c.length);try{const e=[],t=new Map;for(const r of this.data.field){let e=null;this.data.attributeCache&&this.data.attributeCache.has(r)?e=this.data.attributeCache.get(r):(console.log(`属性 ${r} 数据不在缓存中，尝试加载`),e=await K.dataLoader.loadCellAttribute(r),e&&e.length>0&&(this.data.attributeCache||(this.data.attributeCache=new Map),this.data.attributeCache.set(r,e))),e&&e.length>0&&t.set(r,e)}for(const r of c){const n=await this.safeGetMapData(r.id);if(!n||0===n.length)continue;const l=this.data.nodeIndices.get(r.id);if(l)for(let r=0;r<n.length;r++){const c=n[r];if(c[0]>=i&&c[0]<=a&&c[1]>=s&&c[1]<=o){const n=l.startIndex+r,i=[c[0],c[1]],a=[];for(const e of this.data.field){const r=t.get(e);r&&n<r.length?a.push(r[n]||0):a.push(0)}i.push(...a);let s=[.4,.4,.4,1];if(this.data.colorIndex>=0&&this.data.colorIndex<this.data.field.length){const e=this.data.field[this.data.colorIndex],r=t.get(e);if(r&&n<r.length){const e=r[n]||0;s=v(e,this.data.colorIndex)}}i.push(s),e.push(i)}}else console.warn(`找不到节点 ${r.id} 的索引信息，跳过处理`)}return console.log("选中点数:",e.length),console.log("选中点数据格式示例:",e.length>0?e[0]:"无数据"),e}catch(u){return console.error("获取选区点时出错:",u),[]}}clearSelection(){console.log("ScatterRenderer: 开始清除选区状态"),console.log("清除前状态:",{selectionStart:this.state.selectionStart,selectionEnd:this.state.selectionEnd,selectionStartData:this.state.selectionStartData,selectionEndData:this.state.selectionEndData,isSelecting:this.state.isSelecting,selectionVisible:this.state.selectionVisible,selectionMode:this.state.selectionMode}),this.state.selectionStart=null,this.state.selectionEnd=null,this.state.selectionStartData=null,this.state.selectionEndData=null,this.state.selectedIndices=[],this.state.isSelecting=!1,this.state.selectionVisible=!1,this.state.selectionMode=!1,this.setPanningMode(),this.state.isDirty=!0,this.state.animationFrameId||(this.state.animationFrameId=requestAnimationFrame(this.renderFrame)),console.log("ScatterRenderer: 选区状态已清除")}drawSelectionBox(){if(!this.state.selectionStartData||!this.state.selectionEndData)return;const e=this.getWebGLCoordinates(this.state.selectionStartData),t=this.getWebGLCoordinates(this.state.selectionEndData),r=Math.min(e[0],t[0]),n=Math.max(e[0],t[0]),i=Math.min(e[1],t[1]),a=Math.max(e[1],t[1]);Math.abs(n-r)<.01&&Math.abs(a-i)<.01||(this.drawMaskLayer(r,n,i,a),this.drawBorders(r,n,i,a),console.log("绘制选区框: ",{minX:r,maxX:n,minY:i,maxY:a}))}drawMaskLayer(e,t,r,n){if(this.resources.regl)try{const i=[[-1,-1],[-1,r],[1,r],[-1,-1],[1,-1],[1,r],[-1,1],[-1,n],[1,n],[-1,1],[1,1],[1,n],[-1,r],[e,r],[e,n],[-1,r],[-1,n],[e,n],[1,r],[t,r],[t,n],[t,n],[1,n],[1,r]],a=this.resources.regl.buffer(i);this.resources.regl({viewport:{width:this.resources.canvas.width,height:this.resources.canvas.height},depth:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"}},frag:(0,X.generateMaskLayerFragmentShader)(),vert:"#version 300 es\n          precision mediump float;\n          in vec2 position;\n          void main() {\n            gl_Position = vec4(position, -0.99, 1); // 将z值设置为接近近平面，确保显示在前面\n          }\n        ",attributes:{position:a},count:i.length,primitive:"triangles"})(),a.destroy()}catch(i){console.error("绘制遮罩层错误:",i)}}drawBorders(e,t,r,n){if(this.resources.regl)try{const i=.001,a=[[e,r],[t,r],[e,r+i],[e,r+i],[t,r],[t,r+i],[t,r],[t+i,r],[t,n],[t,n],[t+i,r],[t+i,n],[e,n-i],[t,n-i],[e,n],[e,n],[t,n-i],[t,n],[e,r],[e+i,r],[e,n],[e,n],[e+i,r],[e+i,n]],s=this.resources.regl.buffer(a);this.resources.regl({viewport:{width:this.resources.canvas.width,height:this.resources.canvas.height},depth:{enable:!1},blend:{enable:!0,func:{srcRGB:"one",dstRGB:"zero",srcAlpha:"one",dstAlpha:"zero"}},frag:"#version 300 es\n          precision mediump float;\n          out vec4 fragColor;\n          void main() {\n            fragColor = vec4(0.2, 0.2, 0.2, 1.0); // 亮蓝色，完全不透明\n          }\n        ",vert:"#version 300 es\n          precision mediump float;\n          in vec2 position;\n          void main() {\n            gl_Position = vec4(position, -0.95, 1.0); // z值设为-0.95，确保在最上层\n          }\n        ",attributes:{position:s},primitive:"triangles",count:a.length})(),s.destroy()}catch(i){console.error("绘制边框错误:",i)}}async hoverPoint(e){if(this.state.selectionMode||this.state.isPanning||this.state.isSelecting)return;const[t,r]=this.getMousePositionInWebGL(e),[n,i]=this.getDataCoordinates([t,r]),a=this.data.treeMap.get("tree");if(!a)return;const s=a.findNodeByPoint(n,i);if(!s)return-1!==this.state.hoverCategory&&(this.state.hoverCategory=-1,this.scheduleRender()),void this.hideTooltip();const o=await this.safeGetMapData(s.id)||[],l=this.data.nodeIndices.get(s.id);if(!l)return void console.warn(`找不到节点 ${s.id} 的索引信息`);const c=5,u=Math.max(.2,1.5/Math.sqrt(this.state.zoom)),h=c*u*(2/Math.min(this.resources.canvas.width,this.resources.canvas.height));let d=null,f=1/0,g=-1;for(let p=0;p<o.length;p++){const[e,n]=this.getWebGLCoordinates([o[p][0],o[p][1]]),i=e-t,a=n-r,s=Math.sqrt(i*i+a*a);s<f&&(f=s,s<h&&(d=o[p],g=p))}if(d){const t=l.startIndex+g;let r=-1;if(this.data.colorIndex>=0&&this.data.colorIndex<this.data.field.length){const e=this.data.field[this.data.colorIndex];if(this.data.attributeCache&&this.data.attributeCache.has(e)){const n=this.data.attributeCache.get(e);t<n.length&&(r=n[t]||0)}else console.log(`属性 ${e} 数据不在缓存中，需要加载`)}this.state.hoverCategory=r,console.log(`设置悬停类别: ${r}`),this.showTooltip(d,e,r,t),this.callbacks.onPointHovered&&this.callbacks.onPointHovered({...d,attributeValue:r,globalIndex:t})}else this.state.hoverCategory=-1,this.hideTooltip();this.scheduleRender()}setHoverCategory(e){this.state.isTransitioning=!1,this.state.hoverCategory!==e&&(this.state.hoverCategory=e,this.scheduleRender(),console.log(`设置悬停类别: ${e}`))}clearHoverCategory(){if(-1!==this.state.hoverCategory){console.log("清除悬停类别，保留勾选高亮状态");const e={highlightAttributeName:this.state.highlightAttributeName,highlightAttributeValues:[...this.state.highlightAttributeValues||[]],highlightByAttribute:this.state.highlightByAttribute,isCheckHighlight:this.state.isCheckHighlight};this.state.hoverCategory=-1,this.state.hoverAttributeName=null,this.state.hoverValueIndex=-1,this.resources.hoverTexture&&(this.resources.hoverTexture.destroy(),this.resources.hoverTexture=null),this.state.highlightAttributeName=e.highlightAttributeName,this.state.highlightAttributeValues=e.highlightAttributeValues,this.state.highlightByAttribute=e.highlightByAttribute,this.state.isCheckHighlight=e.isCheckHighlight,this.state.isDirty=!0,this.state.animationFrameId||(this.state.animationFrameId=requestAnimationFrame(this.renderFrame)),console.log("悬停状态已清除，勾选高亮状态已保留:",e)}}showTooltip(e,t,r=-1,n=-1){let i=document.getElementById("tooltip");if(!i){i=document.createElement("div"),i.id="tooltip",i.className="tooltip-main";const e="\n        position: absolute;\n        background-color: #fff;\n        border: 2px solid #ff0000;\n        border-radius: 4px;\n        padding: 8px;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n        z-index: 9999;\n        max-width: 250px;\n        pointer-events: none;\n        font-family: Arial, sans-serif;\n      ";i.style.cssText=e,this.container.appendChild(i)}const a=v(r,this.data.colorIndex),s=`rgba(${255*a[0]}, ${255*a[1]}, ${255*a[2]}, ${a[3]})`,o=this.data.colorIndex>=0&&this.data.colorIndex<this.data.field.length?this.data.field[this.data.colorIndex]:"category",l=this.options.fieldValue&&this.options.fieldValue[o]&&this.options.fieldValue[o][r]||`Value: ${r}`;i.innerHTML=`\n      <p style="margin: 0 0 8px 0;">\n        <span style="display:inline-block;width:20px;height:20px;border-radius:50%;background-color:${s};"></span>\n        <span style="margin-left:10px;font-size:16px;font-weight:bold;">${l}</span>\n      </p>\n      <p style="margin:0 0 5px 30px;font-size:14px;"> Colored by ${o}</p>\n      <p style="margin:0 0 0 30px;font-size:12px; color:#828282;">Coords: (${e[0].toFixed(3)}, ${e[1].toFixed(3)})</p>\n      <p style="margin:0 0 0 30px;font-size:12px; color:#828282;">Index: ${n}</p>\n    `;const c=this.container.getBoundingClientRect(),u=t.clientX-c.left,h=t.clientY-c.top;i.style.display="block";const d=i.offsetWidth,f=i.offsetHeight;let g=u+20,p=h+20;g+d>c.width&&(g=u-d-10),p+f>c.height&&(p=h-f-10),g=Math.max(5,g),p=Math.max(5,p),i.style.left=`${g}px`,i.style.top=`${p}px`,i.style.transition="opacity 0.2s",i.style.opacity="1"}hideTooltip(){const e=document.getElementById("tooltip");e&&(e.style.opacity="0",setTimeout((()=>{e&&(e.style.display="none")}),200))}startRenderLoop(){null!==this.state.animationFrameId&&cancelAnimationFrame(this.state.animationFrameId),this.state.animationFrameId=requestAnimationFrame(this.renderFrame)}renderFrame(){const e=this.state.isDirty||this.state.isZooming||this.state.inertiaEnabled&&(Math.abs(this.state.velocity.x)>.01||Math.abs(this.state.velocity.y)>.01);if(e){U.Sr.startMark("render");try{if(this.resources.positionBuffer&&this.resources.colorTexture){U.WE.update();if(this.resources.drawScatter){this.resources.regl.clear({color:[1,1,1,1],depth:1});const e=void 0!==this.data.colorIndex?this.data.colorIndex:0,r=null!==this.resources.highlightTexture&&(null!==this.state.highlightAttributeName||this.state.highlightByAttribute),n=-1!==this.state.hoverCategory,i=this.state.isMouseInListArea&&!n,a=this.state.isCheckHighlight,s=!!a||r&&!n&&!i;try{(r||n||i)&&console.log(`渲染状态 - 高亮属性: ${this.state.highlightAttributeName}, 值: ${this.state.highlightAttributeValues}, 基于属性高亮: ${this.state.highlightByAttribute}, 悬停类别: ${this.state.hoverCategory}, 悬停模式: ${n}, 鼠标在列表空白处: ${i}, 有效高亮: ${s}`);const t=this.state.highlightByAttribute,o=this.state.isCheckHighlight||!1;console.log("渲染参数:",{hasColorTexture:!!this.resources.colorTexture,hasGeneColorTexture:!!this.resources.geneColorTexture,hasGeneData:null!==this.data.geneData&&null!==this.resources.geneColorTexture,total:this.data.total,filterNum:this.data.filterNum||0}),this.resources.drawScatter({position:this.resources.positionBuffer,transform:this.createTransformMatrix(),zoom:this.state.zoom,textureSize:this.resources.textureSize,colorTexture:this.resources.colorTexture,highlightTexture:r?this.resources.highlightTexture:this.resources.colorTexture,hoverTexture:this.resources.hoverTexture||this.resources.colorTexture,filterTexture:this.resources.filterTexture||this.resources.colorTexture,filterNum:this.data.filterNum||0,hoverCategory:-999!==this.state.hoverCategory?this.state.hoverCategory:-1,currentColorField:e,geneExpRange:this.options.geneExpRange||{range:{start:-1,end:-1}},hasHighlight:!!a||(s||this.state.highlightByAttribute),isAttributeHighlight:t,isCheckHighlight:o,geneColorTexture:this.resources.geneColorTexture||this.resources.colorTexture,hasGeneData:null!==this.data.geneData&&null!==this.resources.geneColorTexture}),(this.state.isSelecting||this.state.selectionVisible)&&this.state.selectionStart&&this.state.selectionEnd&&this.drawSelectionBox()}catch(t){console.error("绘制失败:",t),console.warn("尝试重建绘制命令..."),this.resources.drawScatter=null,this.createDrawCommand()&&console.log("绘制命令已重建，将在下一帧重试")}}}else console.warn("渲染资源不完整，跳过渲染");const e=U.Sr.endMark("render");U.Sr.trackRenderTime(e),U.un.checkRenderTime(e),this.state.isDirty=!1}catch(r){console.error("渲染失败:",r),this.handleError("渲染时",r)}}this.state.isZooming&&this.animateZoom(),this.state.animationFrameId=requestAnimationFrame(this.renderFrame)}setMode(e){if(!this.resources.canvas)return console.error("无法设置模式：canvas不存在"),!1;if("pan"===e.toLowerCase()&&!this.state.selectionMode||"select"===e.toLowerCase()&&this.state.selectionMode)return!0;switch(e.toLowerCase()){case"pan":return this.setPanningMode(),!0;case"select":return this.setSelectionMode(),!0;default:return console.error(`未知的模式: ${e}，可选值为 "pan" 或 "select"`),!1}}getMode(){return this.state.selectionMode?"select":"pan"}testSelection(e=!0,t=!0){const r=this.getMode(),n=[];n.push(`当前模式: ${r}`),e?(this.setMode("select"),n.push("已切换到选区模式"),t?(this.forceDrawSelectionBox(!1),n.push("已绘制测试选区框")):n.push("请拖动鼠标进行框选"),this.callbacks.onPointSelected?n.push("选中回调已设置，选中后将触发回调"):(n.push("警告: 未设置选中回调函数(onPointSelected)"),this.callbacks.onPointSelected=e=>{console.log(`选中了 ${e.length} 个点`),alert(`选中了 ${e.length} 个点`)},n.push("已添加测试回调"))):(this.setMode("pan"),n.push("已切换回平移模式"),this.state.selectionVisible&&(this.clearSelection(),n.push("已清除测试选区框")));const i=this.resources.regl._gl;return i&&(n.push(`WebGL版本: ${i.getParameter(i.VERSION)}`),n.push(`最大纹理大小: ${i.getParameter(i.MAX_TEXTURE_SIZE)}`)),n.join("\n")}setSelectionVisible(e=!0){return!(!this.state.selectionStart||!this.state.selectionEnd)&&(this.state.selectionVisible=e,this.scheduleRender(),!0)}forceDrawSelectionBox(e=!1){if(!this.state.selectionStartData||!this.state.selectionEndData){const e=0,t=0,r=.5;this.state.selectionStartData=[e-r/2,t-r/2],this.state.selectionEndData=[e+r/2,t+r/2],this.state.selectionStart=this.getWebGLCoordinates(this.state.selectionStartData),this.state.selectionEnd=this.getWebGLCoordinates(this.state.selectionEndData)}return this.state.selectionVisible=!0,console.log("强制绘制选区: ",{start:this.state.selectionStartData,end:this.state.selectionEndData,startWebGL:this.state.selectionStart,endWebGL:this.state.selectionEnd}),this.scheduleRender(),e&&setTimeout((()=>{this.clearSelection(),this.scheduleRender()}),3e3),!0}downloadCanvasAsPNG(e="scatter_plot"){try{const t=this.resources.canvas;if(!t)return void console.error("无法下载：画布不存在");const r=e.replace(/[^a-z0-9]/gi,"_").toLowerCase(),n=document.createElement("a");n.download=`${r}_${(new Date).toISOString().split("T")[0]}.png`,n.href=t.toDataURL("image/png"),document.body.appendChild(n),n.click(),setTimeout((()=>{document.body.removeChild(n),URL.revokeObjectURL(n.href)}),100),console.log("图像已下载")}catch(t){console.error("下载图像时出错:",t)}}setMouseInListArea(e){this.state.isMouseInListArea!==e&&(console.log(`鼠标${e?"进入":"离开"}列表区域`),this.state.isMouseInListArea=e,this.state.isCheckHighlight||(this.state.isDirty=!0))}async setHoverByAttribute(e,t){try{if(!e||void 0===t||t<0)return console.log(`悬停参数无效: ${e}:${t}，清除悬停`),this.clearHoverCategory(),!1;if(console.log(`设置基于属性的悬停: ${e}, 值索引: ${t}`),!this.data.field||!this.data.field.includes(e))return console.error(`属性 ${e} 不在字段列表中，可用字段: ${this.data.field.join(", ")}`),!1;const r=await this.loadHighlightAttributeData(e);if(!r||0===r.length)return console.error(`无法加载属性 ${e} 的数据，或数据为空`),!1;this.resources.hoverTexture||(console.log(`创建悬停纹理，尺寸: ${this.resources.textureSize}`),this.resources.hoverTexture=this.resources.regl.texture({shape:this.resources.textureSize,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp"})),console.log(`更新悬停纹理数据，总点数: ${this.data.total}，目标值索引: ${t}`);const n=this.resources.textureSize[0],i=this.resources.textureSize[1];for(let e=0;e<i;e++){const i=e*n,a=Math.min(n,Math.max(0,this.data.total-i));if(a<=0)break;const s=new Float32Array(4*a);for(let e=0;e<a;e++){const n=i+e;let a=!1;if(n<r.length){const e=Math.round(r[n]);a=e===t}s[4*e]=a?1:0,s[4*e+1]=0,s[4*e+2]=0,s[4*e+3]=a?1:0}this.resources.hoverTexture.subimage({data:s,width:a,height:1},0,e)}return this.state.hoverCategory=-999,this.state.hoverAttributeName=e,this.state.hoverValueIndex=t,this.state.isDirty=!0,!0}catch(r){return console.error("设置基于属性的悬停出错:",r),this.clearHoverByAttribute(),!1}}clearHoverByAttribute(){this.state.hoverCategory=-1,this.state.hoverAttributeName=null,this.state.hoverValueIndex=-1,this.resources.hoverTexture&&(this.resources.hoverTexture.destroy(),this.resources.hoverTexture=null),this.state.isDirty=!0}async loadAttributeAndHighlight(e,t,r=!1){try{if(!e||void 0===t||t<0)return console.log(`高亮参数无效: ${e}:${t}，清除高亮`),this.clearAttributeHighlight(),!1;if(console.log(`加载属性并高亮: ${e}, 值索引: ${t}, 勾选高亮: ${r}`),!this.data.field||!this.data.field.includes(e))return console.error(`属性 ${e} 不在字段列表中，可用字段: ${this.data.field.join(", ")}`),!1;const n=await this.loadHighlightAttributeData(e);if(!n||0===n.length)return console.error(`无法加载属性 ${e} 的数据，或数据为空`),!1;this.resources.highlightTexture||(console.log(`创建高亮纹理，尺寸: ${this.resources.textureSize}`),this.resources.highlightTexture=this.resources.regl.texture({shape:this.resources.textureSize,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp"})),this.state.highlightAttributeName=e,this.state.highlightAttributeValues=[t],this.state.highlightByAttribute=!0,this.state.isCheckHighlight=r,console.log(`更新高亮纹理数据，总点数: ${this.data.total}`);const i=this.resources.textureSize[0],a=this.resources.textureSize[1];for(let e=0;e<a;e++){const t=e*i,r=Math.min(i,Math.max(0,this.data.total-t));if(r<=0)break;const a=new Float32Array(4*r);for(let e=0;e<r;e++){const r=t+e;let i=!1;if(r<n.length){const e=Math.round(n[r]);i=this.state.highlightAttributeValues.some((t=>e===t))}a[4*e]=0,a[4*e+1]=0,a[4*e+2]=0,a[4*e+3]=i?1:0}this.resources.highlightTexture.subimage({data:a,width:r,height:1},0,e)}return console.log(`属性高亮纹理更新完成，属性: ${e}, 值索引: ${t}`),this.state.isDirty=!0,!0}catch(n){return console.error("设置属性高亮时出错:",n),this.clearAttributeHighlight(),!1}}clearAttributeHighlight(){if(console.log("完全清除所有属性高亮状态"),this.state.highlightAttributeName=null,this.state.highlightAttributeValues=[],this.state.highlightByAttribute=!1,this.state.isCheckHighlight=!1,this.state.multiAttributeHighlight.enabled=!1,this.state.multiAttributeHighlight.attributes.clear(),this.state.multiAttributeHighlight.isCheckHighlight=!1,this.resources.highlightTexture){const t=this.resources.textureSize[0],r=this.resources.textureSize[1];try{const e=new Float32Array(t*r*4).fill(0);this.resources.highlightTexture.subimage({data:e,width:t,height:r}),console.log("属性高亮纹理已清除")}catch(e){console.error("清除高亮纹理时出错:",e)}}this.state.isDirty=!0}async setMultipleAttributeHighlight(e,t,r=!1){try{if(!e||!Array.isArray(t)||0===t.length)return console.log(`多值高亮参数无效: ${e}:${t}，清除高亮`),this.clearAttributeHighlight(),!1;const n=t.filter((e=>"number"===typeof e&&e>=0));if(0===n.length)return console.log("没有有效的值索引，清除高亮"),this.clearAttributeHighlight(),!1;if(console.log(`设置多值高亮: ${e}, 值索引: [${n.join(", ")}], 勾选高亮: ${r}`),!this.data.field||!this.data.field.includes(e))return console.error(`属性 ${e} 不在字段列表中，可用字段: ${this.data.field.join(", ")}`),!1;const i=await this.loadHighlightAttributeData(e);if(!i||0===i.length)return console.error(`无法加载属性 ${e} 的数据，或数据为空`),!1;this.resources.highlightTexture||(console.log(`创建高亮纹理，尺寸: ${this.resources.textureSize}`),this.resources.highlightTexture=this.resources.regl.texture({shape:this.resources.textureSize,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp"})),this.state.highlightAttributeName=e,this.state.highlightAttributeValues=[...n],this.state.highlightByAttribute=!0,this.state.isCheckHighlight=r,console.log(`更新多值高亮纹理数据，总点数: ${this.data.total}，高亮值: [${n.join(", ")}]`);const a=this.resources.textureSize[0],s=this.resources.textureSize[1];for(let e=0;e<s;e++){const t=e*a,r=Math.min(a,Math.max(0,this.data.total-t));if(r<=0)break;const s=new Float32Array(4*r);for(let e=0;e<r;e++){const r=t+e;let a=!1;if(r<i.length){const e=Math.round(i[r]);a=n.includes(e)}s[4*e]=0,s[4*e+1]=0,s[4*e+2]=0,s[4*e+3]=a?1:0}this.resources.highlightTexture.subimage({data:s,width:r,height:1},0,e)}return console.log(`多值高亮纹理更新完成，属性: ${e}, 值索引: [${n.join(", ")}]`),this.state.isDirty=!0,!0}catch(n){return console.error("设置多值高亮时出错:",n),this.clearAttributeHighlight(),!1}}async setMultiAttributeIntersectionHighlight(e,t,r=!1){try{if(console.log("=== 设置多属性交集高亮开始 ==="),console.log(`属性: ${e}, 值索引: [${t.join(", ")}], 勾选高亮: ${r}`),!e||!Array.isArray(t))return console.log(`多属性交集高亮参数无效: ${e}:${t}`),!1;const n=t.filter((e=>"number"===typeof e&&e>=0));return this.data.field&&this.data.field.includes(e)?(this.state.multiAttributeHighlight.enabled=!0,this.state.multiAttributeHighlight.isCheckHighlight=r,n.length>0?(this.state.multiAttributeHighlight.attributes.set(e,n),console.log(`已添加属性 ${e} 的勾选状态: [${n.join(", ")}]`)):(this.state.multiAttributeHighlight.attributes.delete(e),console.log(`已移除属性 ${e} 的勾选状态`)),0===this.state.multiAttributeHighlight.attributes.size?(console.log("没有任何属性被勾选，禁用多属性交集高亮"),this.state.multiAttributeHighlight.enabled=!1,this.clearMultiAttributeHighlight(),!0):(await this.calculateIntersectionHighlight(),console.log("=== 设置多属性交集高亮完成 ==="),!0)):(console.error(`属性 ${e} 不在字段列表中，可用字段: ${this.data.field.join(", ")}`),!1)}catch(n){return console.error("设置多属性交集高亮时出错:",n),this.clearMultiAttributeHighlight(),!1}}async calculateIntersectionHighlight(){try{console.log("=== 开始计算多属性交集高亮 ===");const e=this.state.multiAttributeHighlight.attributes,t=Array.from(e.keys());console.log(`参与交集计算的属性: [${t.join(", ")}]`);const r=new Map;for(const s of t){const e=await this.loadHighlightAttributeData(s);if(!e||0===e.length)return console.error(`无法加载属性 ${s} 的数据`),!1;r.set(s,e),console.log(`已加载属性 ${s} 的数据，长度: ${e.length}`)}this.resources.highlightTexture||(console.log(`创建高亮纹理，尺寸: ${this.resources.textureSize}`),this.resources.highlightTexture=this.resources.regl.texture({shape:this.resources.textureSize,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp"})),this.state.highlightByAttribute=!0,this.state.isCheckHighlight=this.state.multiAttributeHighlight.isCheckHighlight,console.log(`更新多属性交集高亮纹理数据，总点数: ${this.data.total}`);const n=this.resources.textureSize[0],i=this.resources.textureSize[1];let a=0;for(let s=0;s<i;s++){const t=s*n,i=Math.min(n,Math.max(0,this.data.total-t));if(i<=0)break;const o=new Float32Array(4*i);for(let n=0;n<i;n++){const i=t+n;let s=!0;for(const[t,n]of e){const e=r.get(t);if(!e||i>=e.length){s=!1;break}const a=Math.round(e[i]),o=n.includes(a);if(!o){s=!1;break}}s&&a++,o[4*n]=0,o[4*n+1]=0,o[4*n+2]=0,o[4*n+3]=s?1:0}this.resources.highlightTexture.subimage({data:o,width:i,height:1},0,s)}console.log(`多属性交集高亮纹理更新完成，高亮点数: ${a}`);for(const[s,o]of e)console.log(`属性 ${s}: 勾选值索引 [${o.join(", ")}]`);return this.state.isDirty=!0,console.log("=== 多属性交集高亮计算完成 ==="),!0}catch(e){return console.error("计算多属性交集高亮时出错:",e),!1}}clearMultiAttributeHighlight(){if(console.log("清除多属性交集高亮状态"),this.state.multiAttributeHighlight.enabled=!1,this.state.multiAttributeHighlight.attributes.clear(),this.state.multiAttributeHighlight.isCheckHighlight=!1,this.state.highlightAttributeName=null,this.state.highlightAttributeValues=[],this.state.highlightByAttribute=!1,this.state.isCheckHighlight=!1,this.resources.highlightTexture){const t=this.resources.textureSize[0],r=this.resources.textureSize[1];try{const e=new Float32Array(t*r*4).fill(0);this.resources.highlightTexture.subimage({data:e,width:t,height:r}),console.log("多属性交集高亮纹理已清除")}catch(e){console.error("清除多属性交集高亮纹理时出错:",e)}}this.state.isDirty=!0,this.state.animationFrameId||(this.state.animationFrameId=requestAnimationFrame(this.renderFrame))}async updateGeneData(e,t=null){try{if(console.log("更新基因数据:",e),t&&console.log("应用表达范围过滤:",t),!e||!Array.isArray(e)||0===e.length)return console.log("基因数据为空，清除基因颜色映射"),this.data.geneData=null,void(this.state.isDirty=!0);e.length!==this.data.total&&console.warn(`基因数据长度 ${e.length} 与细胞总数 ${this.data.total} 不匹配`),this.data.geneData=e,this.data.geneExpressionRange=t,await this.updateGeneColorTexture(e,t),this.state.isDirty=!0,console.log("基因数据更新完成")}catch(r){console.error("更新基因数据时出错:",r)}}async updateGeneColorTexture(e,t=null){try{if(!this.resources.textureSize||!Array.isArray(this.resources.textureSize))return void console.error("纹理尺寸未初始化");const r=this.resources.textureSize[0],n=this.resources.textureSize[1];this.resources.geneColorTexture||(console.log("创建基因颜色纹理"),this.resources.geneColorTexture=this.resources.regl.texture({shape:this.resources.textureSize,format:"rgba",type:"float32",min:"nearest",mag:"nearest",wrap:"clamp"}));const i=e.filter((e=>e>0&&!isNaN(e)));if(0===i.length)return void console.log("没有有效的基因表达值");const a=Math.min(...i),s=Math.max(...i),o=s-a;console.log(`基因表达范围: ${a.toFixed(4)} - ${s.toFixed(4)}`);let l=null;t&&t.range&&(l=t.range,console.log(`应用表达范围过滤: ${l.start.toFixed(4)} - ${l.end.toFixed(4)}`));for(let t=0;t<n;t++){const n=t*r,i=Math.min(r,Math.max(0,this.data.total-n));if(i<=0)break;const s=new Float32Array(4*i);for(let t=0;t<i;t++){const r=n+t;if(r<e.length){const n=e[r];let i=!0;if(l&&(i=n>=l.start&&n<=l.end),i&&n>0){let e=0;o>0&&(e=(n-a)/o);const r=e,i=1-e,l=0,c=1;s[4*t]=r,s[4*t+1]=l,s[4*t+2]=i,s[4*t+3]=c}else s[4*t]=.4,s[4*t+1]=.4,s[4*t+2]=.4,s[4*t+3]=.6}else s[4*t]=.4,s[4*t+1]=.4,s[4*t+2]=.4,s[4*t+3]=.5}this.resources.geneColorTexture.subimage({data:s,width:i,height:1},0,t)}console.log("基因颜色纹理更新完成")}catch(r){console.error("更新基因颜色纹理时出错:",r)}}clearGeneData(){this.data.geneData=null,this.resources.geneColorTexture&&(this.resources.geneColorTexture.destroy(),this.resources.geneColorTexture=null),this.state.isDirty=!0,console.log("基因数据已清除")}updateFilter(e){try{if(console.log("🔍 ScatterRenderer.updateFilter 被调用:",e),!this.resources.regl)return void console.warn("REGL未初始化，无法更新筛选");const{typeClass:t,typeItem:r,typeValue:n,operatorType:i,filterNum:a}=e;if(!a||0===a)return console.log("清除筛选条件"),this.resources.filterTexture&&(this.resources.filterTexture.destroy(),this.resources.filterTexture=null),this.data.filterNum=0,void(this.state.isDirty=!0);const s=new Float32Array(4*a);for(let e=0;e<a;e++)s[4*e]=t[e]||0,s[4*e+1]=r[e]||0,s[4*e+2]=n[e]||0,s[4*e+3]=i[e]||0,console.log(`筛选条件 ${e}: class=${t[e]}, item=${r[e]}, value=${n[e]}, op=${i[e]}`);this.resources.filterTexture&&this.resources.filterTexture.destroy(),this.resources.filterTexture=this.resources.regl.texture({shape:[a,1],format:"rgba",type:"float32",data:s,min:"nearest",mag:"nearest",wrap:"clamp"}),this.data.filterNum=a,this.state.isDirty=!0,console.log(`✅ 筛选纹理已更新，包含 ${a} 个筛选条件`),this.state.animationFrameId||(this.state.animationFrameId=requestAnimationFrame(this.renderFrame))}catch(t){console.error("更新筛选时出错:",t)}}}var J=Q,ee={props:{geneData:{type:Array,default:()=>[]},geneExpRange:{type:Object,default:()=>({})}},data(){return{renderer:null,selectedIndices:[],isInitialized:!1,highlightListener:null,multipleHighlightListener:null,multiAttributeIntersectionListener:null,clearHighlightListener:null,hoverListener:null,clearHoverListener:null,mouseEnterListAreaListener:null,mouseLeaveListAreaListener:null,currentHighlight:null,currentCheckedHighlight:null}},computed:{...(0,o.aH)({operate:e=>e.uiState.operateActive||1,colorData:e=>e.cellData.colorData||[],total:e=>e.cellData.total||-1,colorBy:e=>e.cellData.colorField||"",typeClass:e=>e.uiState.typeClass||[],typeItem:e=>e.uiState.typeItem||[],typeValue:e=>e.uiState.typeValue||[],operatorType:e=>e.uiState.operatorType||[],filterNum:e=>e.uiState.filterNum||0,field:e=>e.cellData.field||[],fieldValue:e=>e.cellData.fieldValue||{},hoverVal:e=>e.cellData.hoverVal||-1})},watch:{operate:{handler(e){this.switchMode(e)}},colorBy:{async handler(e){if(!this.renderer||!this.isInitialized)return;const t=this.field.indexOf(e);t>=0&&await this.renderer.setColorAttribute(t)}},geneExpRange:{handler(e){this.renderer&&(console.log("基因表达范围更新:",e),this.geneData&&this.geneData.length>0&&e&&e.range?(console.log("应用基因表达范围过滤"),this.renderer.updateGeneData(this.geneData,e)):this.geneData&&this.geneData.length>0&&this.renderer.updateGeneData(this.geneData),this.renderer.options.geneExpRange=e,this.renderer.state.isDirty=!0)},deep:!0},geneData:{handler(e){if(this.renderer&&this.isInitialized&&(console.log("基因数据更新:",e),this.renderer.updateGeneData)){const t=this.geneExpRange;t&&t.range?(console.log("应用基因表达范围过滤:",t),this.renderer.updateGeneData(e,t)):this.renderer.updateGeneData(e)}},deep:!0},total:{handler(e){e>0&&!this.renderer&&this.field&&this.field.length>0&&(console.log(`数据已就绪，total: ${e}，开始初始化渲染器`),this.initRenderer())},immediate:!0},field:{handler(e){e&&e.length>0&&!this.renderer&&this.total>0&&(console.log(`字段列表已就绪，长度: ${e.length}，开始初始化渲染器`),this.initRenderer())},immediate:!0},typeClass:{handler(){this.updateFilter()},deep:!0},typeItem:{handler(){this.updateFilter()},deep:!0},typeValue:{handler(){this.updateFilter()},deep:!0},operatorType:{handler(){this.updateFilter()},deep:!0},filterNum:{handler(){this.updateFilter()}}},mounted(){console.log("ScatterBrainSingle mounted - 开始诊断"),console.log("初始数据状态:",{total:this.total,fieldLength:this.field?this.field.length:0,colorBy:this.colorBy,geneDataLength:this.geneData?this.geneData.length:0}),"undefined"!==typeof window&&window.addEventListener("datasetChanged",this.handleDatasetChange),this.total>0&&this.field&&this.field.length>0?(console.log("初始数据已就绪，开始初始化渲染器"),this.initRenderer()):console.log(`等待数据加载完成，total: ${this.total}, 字段数: ${this.field?this.field.length:0}`),this.setupHighlightListeners()},beforeDestroy(){if(console.log("ScatterBrainSingle: 组件即将销毁，开始清理资源"),"undefined"!==typeof window&&window.removeEventListener("datasetChanged",this.handleDatasetChange),this.removeHighlightListeners(),this.renderer)try{"function"===typeof this.renderer.clearHoverCategory&&this.renderer.clearHoverCategory(),this.renderer.clearAttributeHighlight&&"function"===typeof this.renderer.clearAttributeHighlight&&this.renderer.clearAttributeHighlight(),"function"===typeof this.renderer.dispose&&this.renderer.dispose(),console.log("ScatterBrainSingle: 渲染器已清理")}catch(e){console.error("ScatterBrainSingle: 清理渲染器时出错:",e)}finally{this.renderer=null}this.isInitialized=!1,this.selectedIndices=[],this.currentHighlight=null,this.currentCheckedHighlight=null,console.log("ScatterBrainSingle: 组件资源清理完成")},methods:{async handleDatasetChange(e){if(console.log("ScatterBrainSingle: 数据集切换到",e.detail.dataset),this.renderer)try{const t=e.detail.oldDataset||this.datasetName;console.log(`数据集切换: ${t} -> ${e.detail.dataset}`),await this.renderer.resetForNewDataset(t),this.renderer&&"function"===typeof this.renderer.dispose&&this.renderer.dispose()}catch(t){if(console.error("重置渲染器资源时出错:",t),this.renderer&&"function"===typeof this.renderer.dispose)try{this.renderer.dispose()}catch(r){console.error("清理渲染器时出错:",r)}}finally{this.renderer=null}this.isInitialized=!1,this.selectedIndices=[],this.currentHighlight=null,this.currentCheckedHighlight=null,setTimeout((()=>{this.total>0&&this.field&&this.field.length>0&&(console.log("数据集切换后重新初始化渲染器"),this.initRenderer())}),500)},updateFilter(){this.renderer&&this.isInitialized&&(console.log("🔍 ScatterBrainSingle.updateFilter 被调用"),console.log("筛选数据:",{typeClass:this.typeClass,typeItem:this.typeItem,typeValue:this.typeValue,operatorType:this.operatorType,filterNum:this.filterNum}),this.renderer.updateFilter({typeClass:this.typeClass,typeItem:this.typeItem,typeValue:this.typeValue,operatorType:this.operatorType,filterNum:this.filterNum}))},async initRenderer(){try{if(U.Sr.startMark("initializeRenderer"),this.total<=0)return console.warn("total参数无效，等待有效数据后再初始化渲染器..."),void setTimeout((()=>{this.total>0?this.initRenderer():console.warn("total参数仍然无效，请检查数据加载")}),1e3);if(!this.field||!Array.isArray(this.field)||0===this.field.length)return console.warn("字段列表为空，等待字段数据加载后再初始化渲染器..."),void setTimeout((()=>{this.field&&this.field.length>0?this.initRenderer():console.warn("字段列表仍然为空，请检查数据加载")}),1e3);const e=this.$refs.scatterBrain;this.renderer=new J(e,{pointSize:3,defaultZoom:1,defaultOffset:[0,0],antialiasing:!0,highlightSize:1.5}),await this.renderer.initialize(),this.renderer.callbacks.onPointSelected=this.handlePointSelected;const t=this.field.indexOf(this.colorBy),r=t>=0?t:0;console.log(`开始加载数据，total: ${this.total}, 字段数: ${this.field.length}, colorBy: ${this.colorBy}`),await this.renderer.loadData({quadTreePath:(0,l.buildDatasetPath)("quad_tree.json"),total:this.total,field:this.field,colorBy:this.colorBy,colorIndex:r}),this.renderer.setMode(1===this.operate?"pan":"select"),document.addEventListener("keydown",this.handleKeyDown),await this.renderer.setColorAttribute(r);const n=U.Sr.endMark("initializeRenderer");console.log(`渲染器初始化完成，耗时: ${n.toFixed(2)}ms`),this.isInitialized=!0}catch(e){console.error("初始化ScatterBrainSingle渲染器失败:",e)}},setupHighlightListeners(){this.highlightListener||(this.highlightListener=this.handleHighlightEvent.bind(this),this.multipleHighlightListener=this.handleMultipleHighlightEvent.bind(this),this.multiAttributeIntersectionListener=this.handleMultiAttributeIntersectionEvent.bind(this),this.clearHighlightListener=this.handleClearHighlightEvent.bind(this),this.hoverListener=this.handleHoverEvent.bind(this),this.clearHoverListener=this.handleClearHoverEvent.bind(this),this.mouseEnterListAreaListener=this.handleMouseEnterListArea.bind(this),this.mouseLeaveListAreaListener=this.handleMouseLeaveListArea.bind(this),document.addEventListener("highlight-attribute",this.highlightListener),document.addEventListener("highlight-multiple-attributes",this.multipleHighlightListener),document.addEventListener("highlight-multi-attribute-intersection",this.multiAttributeIntersectionListener),document.addEventListener("clear-highlight",this.clearHighlightListener),document.addEventListener("cell-property-item-mouseenter",this.hoverListener),document.addEventListener("cell-property-item-mouseleave",this.clearHoverListener),document.addEventListener("mouse-enter-list-area",this.mouseEnterListAreaListener),document.addEventListener("mouse-leave-list-area",this.mouseLeaveListAreaListener))},removeHighlightListeners(){this.highlightListener&&(document.removeEventListener("highlight-attribute",this.highlightListener),this.highlightListener=null),this.multipleHighlightListener&&(document.removeEventListener("highlight-multiple-attributes",this.multipleHighlightListener),this.multipleHighlightListener=null),this.multiAttributeIntersectionListener&&(document.removeEventListener("highlight-multi-attribute-intersection",this.multiAttributeIntersectionListener),this.multiAttributeIntersectionListener=null),this.clearHighlightListener&&(document.removeEventListener("clear-highlight",this.clearHighlightListener),this.clearHighlightListener=null),this.hoverListener&&(document.removeEventListener("cell-property-item-mouseenter",this.hoverListener),this.hoverListener=null),this.clearHoverListener&&(document.removeEventListener("cell-property-item-mouseleave",this.clearHoverListener),this.clearHoverListener=null),this.mouseEnterListAreaListener&&(document.removeEventListener("mouse-enter-list-area",this.mouseEnterListAreaListener),this.mouseEnterListAreaListener=null),this.mouseLeaveListAreaListener&&(document.removeEventListener("mouse-leave-list-area",this.mouseLeaveListAreaListener),this.mouseLeaveListAreaListener=null)},async handleHighlightEvent(e){if(!this.renderer||!this.isInitialized)return;const{attributeName:t,attributeValue:r,isCheckHighlight:n}=e.detail;if(t&&void 0!==r){console.log(`接收到高亮事件: 属性=${t}, 值=${r}, 勾选高亮=${n}`);try{n?(await this.renderer.loadAttributeAndHighlight(t,r,!0),this.currentCheckedHighlight={attributeName:t,attributeValue:r,isCheckHighlight:!0},console.log("已保存单值勾选高亮状态:",this.currentCheckedHighlight)):await this.renderer.setHighlightAttribute(t,r)}catch(i){console.error("设置高亮时出错:",i)}}else console.warn("高亮事件缺少必要参数")},async handleMultipleHighlightEvent(e){if(!this.renderer||!this.isInitialized)return;const{attributeName:t,attributeValueIndices:r,isCheckHighlight:n}=e.detail;if(t&&Array.isArray(r)&&0!==r.length){console.log(`接收到多值高亮事件: 属性=${t}, 值索引=[${r.join(", ")}], 勾选高亮=${n}`);try{await this.renderer.setMultipleAttributeHighlight(t,r,n),this.currentCheckedHighlight={attributeName:t,attributeValueIndices:[...r],isCheckHighlight:!0},console.log("已保存多值勾选高亮状态:",this.currentCheckedHighlight)}catch(i){console.error("设置多值高亮时出错:",i)}}else console.warn("多值高亮事件缺少必要参数")},async handleMultiAttributeIntersectionEvent(e){if(!this.renderer||!this.isInitialized)return;const{attributeName:t,attributeValueIndices:r}=e.detail;if(t&&Array.isArray(r)){console.log(`接收到多属性交集高亮事件: 属性=${t}, 值索引=[${r.join(", ")}]`);try{0===r.length?(console.log(`清除属性 ${t} 的勾选高亮`),await this.renderer.setMultiAttributeIntersectionHighlight(t,[],!0),0===this.renderer.state.multiAttributeHighlight.attributes.size&&(console.log("没有任何属性被勾选，清除勾选高亮状态"),this.currentCheckedHighlight=null)):(await this.renderer.setMultiAttributeIntersectionHighlight(t,r,!0),this.currentCheckedHighlight={mode:"multi-attribute-intersection",isCheckHighlight:!0},console.log("已设置多属性交集高亮状态"))}catch(n){console.error("设置多属性交集高亮时出错:",n)}}else console.warn("多属性交集高亮事件缺少必要参数")},handleClearHighlightEvent(e){if(this.renderer&&this.isInitialized){console.log("接收到清除高亮事件",e.detail);try{const t=e.detail||{},r=t.attributeName,n=t.checkForCheckedItems,i=t.force,a=t.reason;if(console.log(`清除高亮事件详情: 属性=${r}, 检查勾选=${n}, 强制=${i}, 原因=${a}`),i)return console.log("强制清除所有高亮状态"),this.renderer.clearAttributeHighlight(),this.currentHighlight=null,void(this.currentCheckedHighlight=null);if(n&&this.currentCheckedHighlight)return void console.log("需要检查勾选项，且有勾选高亮状态，忽略清除请求");if(this.currentCheckedHighlight){const e=this.currentCheckedHighlight.attributeName;if(r&&r!==e)return void console.log(`清除属性 ${r} 的高亮，保留勾选高亮 ${e}`);if(!r)return void console.log("有勾选高亮状态，忽略清除高亮事件")}console.log("没有勾选高亮状态，执行清除操作"),this.renderer.clearAttributeHighlight(),this.currentHighlight=null,this.currentCheckedHighlight=null,console.log("已清除所有高亮状态")}catch(t){console.error("清除高亮时出错:",t)}}},handlePointSelected(e){console.log(`选中了${e.length}个点`),this.selectedIndices=e,this.$emit("selectArea",e)},handleKeyDown(e){"Escape"===e.key&&this.renderer&&this.renderer.setMode("pan")},switchMode(e){this.renderer&&this.renderer.setMode(1===e?"pan":"select")},downloadImage(){this.renderer&&this.renderer.downloadCanvasAsPNG(`scatter_${this.colorBy}`)},backupDownload(){try{const e=document.querySelector("#canvasContainer");if(!e)return;const t=e.querySelector("canvas");if(!t)return;const r=document.createElement("a");r.download=`scatter_plot_${this.colorBy||"default"}.png`,r.href=t.toDataURL("image/png"),document.body.appendChild(r),r.click(),setTimeout((()=>{document.body.removeChild(r),URL.revokeObjectURL(r.href)}),100)}catch(e){console.error("下载图像失败:",e)}},async handleHoverEvent(e){if(this.renderer&&this.isInitialized)try{if(!e.detail)return void console.warn("悬停事件缺少详情信息");const{valueIndex:t,attributeName:r,attributeValue:n}=e.detail;if(console.log(`悬停事件: 属性=${r}, 值=${n}, 索引=${t}`),void 0===t||t<0)return void console.warn(`无效的悬停索引: ${t}`);r===this.colorBy?(console.log(`使用当前颜色字段悬停方式: ${r}, 值索引: ${t}`),this.renderer.setHoverCategory(t)):(console.log(`使用跨属性悬停方式: ${r}, 值索引: ${t}`),await this.renderer.loadAttributeAndHighlight(r,t,!1))}catch(t){console.error("处理悬停事件出错:",t)}},async handleClearHoverEvent(){if(this.renderer&&this.isInitialized)try{if(console.log("清除悬停高亮，保留勾选高亮"),this.currentCheckedHighlight){if(console.log("检测到勾选高亮状态，直接恢复而不清除...",this.currentCheckedHighlight),"multi-attribute-intersection"===this.currentCheckedHighlight.mode)console.log("恢复多属性交集高亮状态"),await this.renderer.calculateIntersectionHighlight();else{const{attributeName:e,attributeValueIndices:t,isCheckHighlight:r}=this.currentCheckedHighlight;if(Array.isArray(t))await this.renderer.setMultipleAttributeHighlight(e,t,r);else{const t=this.currentCheckedHighlight.attributeValue;void 0!==t&&await this.renderer.loadAttributeAndHighlight(e,t,r)}}this.renderer.clearHoverCategory()}else this.renderer.clearHoverCategory()}catch(e){console.error("清除悬停高亮出错:",e)}},handleMouseEnterListArea(){this.renderer&&this.isInitialized&&(console.log("ScatterBrainSingle: 鼠标进入列表区域"),this.renderer.setMouseInListArea(!0))},handleMouseLeaveListArea(){this.renderer&&this.isInitialized&&(console.log("ScatterBrainSingle: 鼠标离开列表区域"),this.renderer.setMouseInListArea(!1))},handleContainerResize(){if(this.renderer&&this.isInitialized){console.log("ScatterBrainSingle: 处理容器尺寸变化");try{const e=this.$refs.scatterBrain;if(e){const{offsetWidth:t,offsetHeight:r}=e;console.log(`ScatterBrainSingle: 容器当前尺寸 - 宽度: ${t}, 高度: ${r}`)}this.$nextTick((()=>{setTimeout((()=>{this.renderer&&"function"===typeof this.renderer.handleResize?(console.log("ScatterBrainSingle: 调用渲染器handleResize方法"),this.renderer.handleResize(),console.log("ScatterBrainSingle: 渲染器尺寸已更新")):console.warn("ScatterBrainSingle: 渲染器handleResize方法不可用")}),100)}))}catch(e){console.error("ScatterBrainSingle: 处理容器尺寸变化时出错:",e)}}else console.warn("ScatterBrainSingle: 渲染器未初始化，跳过尺寸变化处理")},clearSelection(){if(this.renderer&&this.isInitialized){console.log("ScatterBrainSingle: 清除选区状态");try{"function"===typeof this.renderer.clearSelection&&this.renderer.clearSelection()}catch(e){console.error("ScatterBrainSingle: 清除选区状态时出错:",e)}}},setMode(e){if(this.renderer&&this.isInitialized){console.log(`ScatterBrainSingle: 设置操作模式为 ${e}`);try{"function"===typeof this.renderer.setMode&&this.renderer.setMode(e)}catch(t){console.error(`ScatterBrainSingle: 设置操作模式为 ${e} 时出错:`,t)}}}}},te=ee,re=(0,h.A)(te,H,N,!1,null,null,null),ne=re.exports,ie=r(9182),ae=r.n(ie),se=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"select-list ml-3 mr-3"},[t("div",{staticClass:"select-item"},e._l(e.source.node,(function(r,n,i){return t("p",{key:i,staticClass:"info-item"},["x"!==n&&"y"!==n?[t("span",{staticClass:"text-hidden",staticStyle:{width:"40%"}},[e._v(e._s(n))]),t("span",{staticClass:"text-hidden",staticStyle:{width:"50%"}},[e._v(e._s(r))])]:e._e()],2)})),0)])])},oe=[],le={name:"infoList",props:{index:{type:Number},source:{type:Object,default(){return{}}},label:{type:String},value:{type:String}},mounted(){}},ce=le,ue=(0,h.A)(ce,se,oe,!1,null,"07b8a7c6",null),he=ue.exports,de=function(){var e=this,t=e._self._c;return t("div",{staticClass:"graph-controls"},[t("v-row",{staticClass:"graph-row",class:{"flex-column":e.$vuetify.breakpoint.xs}},[t("v-col",{staticClass:"dataset-info",attrs:{cols:e.$vuetify.breakpoint.xs?12:5/e.graphNum}},[t("p",{staticClass:"mb-2 dataset-name text-truncate"},[e._v(" "+e._s(e.datasetName)+" ")]),t("p",{staticClass:"status-line"},[t("svg",{staticClass:"v-icon__svg mr-1",attrs:{viewBox:"0 0 24 24",role:"img","aria-hidden":"true"}},[t("path",{attrs:{d:"M12,19.58V19.58C10.4,19.58 8.89,18.96 7.76,17.83C6.62,16.69 6,15.19 6,13.58C6,12 6.62,10.47 7.76,9.34L12,5.1M17.66,7.93L12,2.27V2.27L6.34,7.93C3.22,11.05 3.22,16.12 6.34,19.24C7.9,20.8 9.95,21.58 12,21.58C14.05,21.58 16.1,20.8 17.66,19.24C20.78,16.12 20.78,11.05 17.66,7.93Z"}})]),t("span",{staticClass:"mr-2 text-truncate"},[e._v(e._s(e.colorBy))]),t("v-icon",{staticClass:"mr-1",attrs:{small:""}},[e._v("mdi-link")]),e.filterNum?t("span",{staticClass:"mr-2"},[e._v(e._s(e.filterNum)+" filters")]):t("span",{staticClass:"mr-2"},[e._v("None")]),t("v-icon",{staticClass:"mr-1",attrs:{small:""}},[e._v("mdi-camera-outline")]),t("span",[e._v("Sync Camera")])],1)]),t("v-col",{staticClass:"control-buttons",attrs:{cols:e.$vuetify.breakpoint.xs?12:7/e.graphNum}},[t("div",{staticClass:"icons-container"},[t("v-icon",{staticClass:"graph-icon",class:{opearate_active:1===e.operateActive},on:{click:function(t){return e.changeOperator(1)}}},[e._v("mdi-arrow-expand-all")]),t("v-icon",{staticClass:"graph-icon",class:{opearate_active:2===e.operateActive},on:{click:e.openSelectDrawer}},[e._v("mdi-select-arrow-up")]),t("v-divider",{staticClass:"mx-2",staticStyle:{height:"20px"},attrs:{inset:"",vertical:""}}),t("v-icon",{staticClass:"graph-icon",class:{opearate_active:3===e.operateActive},on:{click:e.separateGraph}},[e._v("mdi-plus-circle-multiple-outline")]),t("v-icon",{staticClass:"graph-icon",class:{opearate_active:4===e.operateActive},on:{click:e.downloadImage}},[e._v("mdi-arrow-down")]),t("v-icon",{staticClass:"graph-icon",class:{opearate_active:5===e.operateActive},on:{click:e.deleteSeparateGraph}},[e._v("mdi-delete")])],1)])],1)],1)},fe=[],ge={name:"GraphControls",props:{datasetName:{type:String,default:""},colorBy:{type:String,default:""},filterNum:{type:Number,default:0},operateActive:{type:Number,default:1},graphNum:{type:Number,default:1}},methods:{...(0,o.i0)("uiState",["setOperateActive","openDrawer"]),changeOperator(e){this.setOperateActive(e),this.$emit("changeOperator",e)},openSelectDrawer(){this.setOperateActive(2),this.openDrawer(),this.$emit("openSelectDrawer")},separateGraph(){this.setOperateActive(3),this.$emit("separateGraph")},deleteSeparateGraph(){this.setOperateActive(5),this.$emit("deleteSeparateGraph")},downloadImage(){this.$emit("downloadImage")}}},pe=ge,me=(0,h.A)(pe,de,fe,!1,null,"30eed7df",null),ve=me.exports,ye={mixins:[E.o],props:{datasetType:{type:String,default:"single"},visualizationType:{type:String,default:"umap"}},components:{VirtualList:ae(),ScatterBrainSingle:ne,GraphControls:ve},data(){return{itemComponent:he,graphNum:1,selectedItem:0,selectInfo:{},colorData:[],orginColorData:[],refKey:0,umapData:[],partialData:[],colorRange:{},sizeData:[],quadTree:null,nodeMap:null,hoverCategory:-1,treeMap:new Map,typeClass:[],typeItem:[],typeValue:[],operatorType:[],geneData:[],selectedTypes:[]}},computed:{...(0,o.aH)("cellData",["typeInfo","classInfo","hoverInfo","field","total","dataRange","summaryData","colorField","geneExpRange"]),...(0,o.L8)("cellData",["getFieldValue"]),...(0,o.aH)("uiState",["drawer","operateActive","selectNodes"]),...(0,o.L8)("uiState",["isDrawerOpen"]),geneExp(){return this.getNonReactiveData("geneExp")||{}},fieldValue(){return this.getFieldValue},colorBy(){return this.colorField},datasetName(){return this.$store.state.cellData.datasetName},filterNum(){return this.typeClass.length},...(0,o.aH)({loading:e=>e.loading})},watch:{drawer:{handler(e,t){this.$nextTick((()=>{setTimeout((()=>{this.handleDrawerStateChange(e)}),100)}))},immediate:!1},typeInfo:{handler(e){this.filterTypeData(e)},deep:!0},classInfo:{handler(e){this.filterTypeData(this.typeInfo)},deep:!0},geneExp:{handler(e){console.log("🧬 SingleCellGraph geneExp watcher triggered:",{isEmpty:_.isEmpty(e),geneCount:e?Object.keys(e).length:0,genes:e?Object.keys(e):[],datasetType:this.datasetType}),_.isEmpty(e)?(console.log("🧬 设置 geneData 为空数组"),this.geneData=[]):(console.log("🧬 调用 filterGeneExp 处理基因数据"),this.filterGeneExp(e))},deep:!0},hoverInfo:{handler(e){console.log("🖱️ SingleCellGraph hoverInfo watcher:",e),_.isEmpty(e)?(console.log("🖱️ 清除悬浮高亮，恢复选中状态"),this.hoverCategory=-1,this.filterTypeData(this.typeInfo)):this.getHoverFilterData(e)},deep:!0}},methods:{...(0,o.i0)("uiState",["setOperateActive","toggleDrawer","closeDrawer","openDrawer","setSelectNodes"]),filterTypeData(e){const t=[],r=[],n=[],i=[];let a=0,s=!1;for(const o in e)if("Class"!==o){const l=e[o],c=_.indexOf(this.field,o);if(-1===c)continue;const u=Math.floor(c/4),h=c%4;for(const e of l){let l=!1;for(let e=0;e<a;e++)t[e]===u&&r[e]===h&&(s||0!==i[e]?l=!0:s=!0);t.push(u),r.push(h);const c=_.indexOf(this.fieldValue[o],e);n.push(c),s?i.push(2):l||0===i.length?i.push(1):i.push(0),a++}}else{const s=e[o];if(Array.isArray(s)){const e=_.indexOf(this.field,"Siletti_modf_SCANVI_L2");if(-1===e)continue;const o=Math.floor(e/4),l=e%4;for(const c of s){t.push(o),r.push(l);const e=_.indexOf(this.fieldValue["Siletti_modf_SCANVI_L2"],c);-1!==e&&(n.push(e),i.push(1),a++)}}else for(const e in s){const o=s[e],l=_.indexOf(this.field,"Siletti_modf_SCANVI_L2");if(-1===l)continue;const c=Math.floor(l/4),u=l%4;for(const e of o){t.push(c),r.push(u);const s=_.indexOf(this.fieldValue["Siletti_modf_SCANVI_L2"],e);n.push(s),i.push(1),a++}}}this.typeClass=t,this.typeItem=r,this.typeValue=n,this.operatorType=i,this.$store.commit("uiState/SET_FILTER_DATA",{typeClass:t,typeItem:r,typeValue:n,operatorType:i,filterNum:a})},getHoverFilterData(e){if(console.log("🖱️ 处理悬浮高亮:",e),!e||!e.key)return void console.warn("悬浮信息不完整:",e);const{key:t,value:r,type:n,valueIndex:i}=e,a=_.indexOf(this.field,t);if(-1===a)return void console.warn(`属性 ${t} 在 field 中未找到`);let s=i;if((void 0===s||s<0)&&this.fieldValue[t]&&Array.isArray(this.fieldValue[t])&&(s=this.fieldValue[t].indexOf(r)),void 0===s||s<0)return void console.warn(`无法确定属性值 ${r} 在 ${t} 中的索引`);console.log(`🖱️ 悬浮高亮: ${t}[${a}] = ${r}[${s}]`);const o=[Math.floor(a/4)],l=[a%4],c=[s],u=[0],h=1;this.hoverCategory=s,this.$store.commit("uiState/SET_FILTER_DATA",{typeClass:o,typeItem:l,typeValue:c,operatorType:u,filterNum:h,isHover:!0}),console.log("🖱️ 悬浮高亮数据已设置")},filterGeneExp(e){let t=Object.keys(e),r=t[0];console.log("🧬 filterGeneExp:",{keys:t,selectedKey:r,dataLength:e[r]?e[r].length:0,sampleData:e[r]?e[r].slice(0,5):[]}),this.geneData=e[r],console.log("🧬 设置 geneData 完成，长度:",this.geneData?this.geneData.length:0)},separateGraph(){this.setOperateActive(3),this.graphNum=2,this.colorData=this.orginColorData,this.partialData=this.umapData,this.refKey=this.refKey+1},deleteSeparateGraph(){this.graphNum>1&&(this.graphNum=1,this.setOperateActive(1))},selectArea(e){if(!e||!e.length)return;const t=[];for(let i=0;i<e.length;i++){const r={};let n=e[i].slice(2,e[i].length-1)||[];n.forEach(((t,n)=>{n<e[i].length-1&&(r[this.field[n]]=this.fieldValue[this.field[n]][t])}));const a=e[i][e[i].length-1]||[];let s=a.map((e=>Math.round(255*e))).join(",");s=`rgba(${s})`,t.push({node:r,color:s,id:i})}const r=_.groupBy(t,"color"),n=Object.keys(r).map((e=>({key:e,value:r[e]})));this.setSelectNodes(n),this.selectInfo=n[0]||{},this.colorData=this.orginColorData,this.partialData=this.umapData},changeCellItem(e=0){this.selectInfo=this.selectNodes[e]},changeOperator(e){this.setOperateActive(e),1===e&&(this.clearSelectionAndRestore(),this.drawer&&this.closeDrawer())},openSelectDrawer(){this.openDrawer(),this.setOperateActive(2)},getHoverFilterData(e){if(!e||!e.key)return;const t=_.indexOf(this.field,e.key);if(-1===t)return;const r=Math.floor(t/4),n=t%4,i=_.indexOf(this.fieldValue[e.key],e.value);if(-1!==i){for(let e=0;e<this.filterNum;e++)if(this.typeClass[e]===r&&this.typeItem[e]===n&&this.typeValue[e]===i)return;this.typeClass.push(r),this.typeItem.push(n),this.typeValue.push(i),this.operatorType.push(1),this.hoverCategory=i}},downloadImage(){const e="single"===this.datasetType?this.$refs.singleChart:this.$refs.multipleChart;if(e){if("function"!==typeof e.downloadImage)return"single"===this.datasetType&&e.backupDownload?void e.backupDownload():void this.directDownload();try{e.downloadImage()}catch(t){this.directDownload()}}else this.directDownload()},directDownload(){try{const e="single"===this.datasetType?document.querySelector("#canvasContainer"):document.querySelector(".scatter-container");if(!e)return;const t=e.querySelector("canvas");if(!t)return;const r=document.createElement("a"),n=`scatter_plot_${this.colorBy||"default"}.png`;r.download=n,r.href=t.toDataURL("image/png"),document.body.appendChild(r),r.click(),setTimeout((()=>{document.body.removeChild(r),URL.revokeObjectURL(r.href)}),100)}catch(e){console.error("直接下载失败:",e)}},handleDrawerStateChange(e){if(console.log("抽屉状态变化: "+(e?"打开":"关闭")),!e){console.log("抽屉关闭，清除选区效果");try{this.setOperateActive(1),this.setSelectNodes([]),this.selectInfo={};const e="single"===this.datasetType?this.$refs.singleChart:this.$refs.multipleChart;e&&("function"===typeof e.clearSelection&&e.clearSelection(),"function"===typeof e.setMode&&e.setMode("pan"),"single"===this.datasetType&&e.renderer&&("function"===typeof e.renderer.clearSelection&&e.renderer.clearSelection(),"function"===typeof e.renderer.setMode&&e.renderer.setMode("pan"))),this.colorData=this.orginColorData,this.partialData=this.umapData,console.log("抽屉关闭时的选区效果已清除")}catch(t){console.error("抽屉关闭时清除选区效果出错:",t)}}if("single"===this.datasetType&&this.$refs.singleChart?this.$refs.singleChart.handleContainerResize&&this.$refs.singleChart.handleContainerResize():"multiple"===this.datasetType&&this.$refs.multipleChart&&this.$refs.multipleChart.handleContainerResize&&this.$refs.multipleChart.handleContainerResize(),this.graphNum>1){const e=this.$refs.singleChart||this.$refs.multipleChart;Array.isArray(e)&&e.forEach((e=>{e&&e.handleContainerResize&&e.handleContainerResize()}))}},clearSelectionAndRestore(){console.log("清除选区效果并恢复图形原状");try{this.setOperateActive(1),this.setSelectNodes([]),this.selectInfo={};const e="single"===this.datasetType?this.$refs.singleChart:this.$refs.multipleChart;e&&("function"===typeof e.clearSelection&&e.clearSelection(),"function"===typeof e.setMode&&e.setMode("pan"),"single"===this.datasetType&&e.renderer&&("function"===typeof e.renderer.clearSelection&&e.renderer.clearSelection(),"function"===typeof e.renderer.setMode&&e.renderer.setMode("pan"))),this.colorData=this.orginColorData,this.partialData=this.umapData,console.log("选区效果已清除，图形已恢复原状")}catch(e){console.error("清除选区效果时出错:",e)}},handleCloseDrawer(){console.log("点击关闭按钮，关闭Selected Cells抽屉");try{this.clearSelectionAndRestore(),this.closeDrawer(),console.log("抽屉关闭指令已发送，选区效果已清除")}catch(e){console.error("关闭抽屉时出错:",e)}}}},be=ye,xe=(0,h.A)(be,V,B,!1,null,"5b87b382",null),we=xe.exports,Se={name:"HomeView",mixins:[E.o],components:{ViewManager:f,CellProperties:I,Genes:M,SingleCellGraphVue:we},data(){return{tab:1,tabList:[{text:"View Manager",component:"ViewManager",icon:"mdi-hub"},{text:"Cell Properties",component:"CellProperties",icon:"mdi-cog"},{text:"Genes",component:"Genes",icon:"mdi-magnify"}],notCellType:["x","y","Siletti_modf_SCANVI_L1","Siletti_modf_SCANVI_L2","region","subregion"],addCellType:["Class"],classInfo:{},flag:"a",signDelete:!1,summaryData:{},sidebarWidth:400,minSidebarWidth:400,maxSidebarWidth:600,initialX:0,initialWidth:0,isPanelOpen:!1}},async mounted(){await this.loadInitialData()},computed:{...(0,o.aH)("cellData",["typeInfo","hoverInfo","colorField","datasetList","field","total","dataRange","geneList","datasetName","geneExpRange"]),...(0,o.L8)("cellData",["getCellInfoList","getFieldValue"]),...(0,o.L8)("uiState",["getGridClass"]),cellInfoList(){return this.getCellInfoList},fieldValue(){return this.getFieldValue},geneExp(){return this.getNonReactiveData("geneExp")||{}},gridClass(){return this.getGridClass||""}},watch:{datasetList:{async handler(e){e.includes("multiple")&&await this.loadDatasetSummary()}}},methods:{...(0,o.i0)("cellData",["loadFieldsInfo","loadCellTypeValues","setTypeInfo","setHoverInfo","setColorField","loadGeneList"]),...(0,o.i0)("uiState",["updateGridClass","setCurrentRangeSelected"]),async loadInitialData(){try{await this.loadFieldsInfo(),await this.loadCellTypeValues(),await this.$store.dispatch("cellData/loadGeneList")}catch(e){console.error("加载初始数据失败:",e)}},async loadDatasetSummary(){try{const e=await fetch("/multiple_outputs/dataset_summary.json");this.summaryData=await e.json()}catch(e){console.error("加载数据集摘要失败:",e)}},getType(e){console.log("🏠 HomeView.getType 被调用:",e);const t={...this.typeInfo};"plain"===e.type?(console.log("🏠 处理普通类型选择"),t[e.data.key]=e.data.value,e.data.value.length||delete t[e.data.key]):(console.log("🏠 处理树形视图选择 (Class)"),t[e.data.key]=e.data.value,w().isEmpty(t[e.data.key])&&delete t[e.data.key]),console.log("🏠 更新后的 typeInfo:",t),this.setTypeInfo(t)},getHover(e){let t={};if("over"===e.mode){const r="treeView"===e.type?e.data.hasOwnProperty("children")?"Siletti_modf_SCANVI_L1":"Siletti_modf_SCANVI_L2":e.data.key,n="treeView"===e.type?e.data.name:e.data.value;t={key:r,value:n,type:e.type},"treeView"!==e.type||e.data.hasOwnProperty("children")||(t["parent"]=e.data.parent)}this.setHoverInfo(t)},getGeneExp(e){if(w().isEmpty(e))this.$store.commit("cellData/SET_GENE_EXP",{});else{const t=Object.keys(e),r=t[t.length-1];this.$store.commit("cellData/SET_GENE_EXP",{[r]:e[r]})}},getColorBy(e){this.setColorField(e),this.$store.commit("cellData/SET_GENE_EXP_RANGE",{...this.geneExpRange,color:!1})},changeLayout(e){this.$store.commit("cellData/SET_DATASET_LIST",e),this.updateGridClass(),this.flag=(new Date).getTime(),this.signDelete=!0},deleteGrap(e){console.log(`开始删除图表，索引: ${e}`);try{const t=this.$children.filter((e=>"SingleCellGraphVue"===e.$options.name));if(t[e]&&t[e].$refs.singleChart){const r=t[e].$refs.singleChart;r.renderer&&"function"===typeof r.renderer.dispose&&(console.log(`清理第${e}个图表的渲染器`),r.renderer.dispose(),r.renderer=null)}this.$nextTick((()=>{setTimeout((()=>{const t=[...this.datasetList];t.splice(e,1),this.$store.commit("cellData/SET_DATASET_LIST",t),this.updateGridClass(),this.flag=(new Date).getTime(),this.signDelete=t.length>1,console.log(`图表删除完成，剩余图表数量: ${t.length}`)}),100)}))}catch(t){console.error("删除图表时出错:",t);const r=[...this.datasetList];r.splice(e,1),this.$store.commit("cellData/SET_DATASET_LIST",r),this.updateGridClass(),this.flag=(new Date).getTime(),this.signDelete=r.length>1}},getRangeSelected(e){this.$store.commit("cellData/SET_GENE_EXP_RANGE",e),this.setCurrentRangeSelected(e)},initResize(e){e.preventDefault(),document.addEventListener("mousemove",this.doResize),document.addEventListener("mouseup",this.stopResize),document.body.style.userSelect="none",this.initialX=e.clientX,this.initialWidth=this.sidebarWidth},doResize(e){this.sidebarWidth=this.initialWidth+(e.clientX-this.initialX),this.sidebarWidth<this.minSidebarWidth&&(this.sidebarWidth=this.minSidebarWidth),this.sidebarWidth>this.maxSidebarWidth&&(this.sidebarWidth=this.maxSidebarWidth)},stopResize(){document.removeEventListener("mousemove",this.doResize),document.removeEventListener("mouseup",this.stopResize),document.body.style.userSelect=""},handlePanelStateChange(e){this.isPanelOpen=e},async handleDatasetChanged(e){try{console.log("HomeView: 接收到数据集切换事件",e),await this.loadInitialData(),this.flag="a"===this.flag?"b":"a",console.log("HomeView: 数据集切换处理完成")}catch(t){console.error("HomeView: 处理数据集切换失败:",t)}}},beforeDestroy(){document.removeEventListener("mousemove",this.doResize),document.removeEventListener("mouseup",this.stopResize)}},Ce=Se,Ae=(0,h.A)(Ce,n,i,!1,null,"d53030e6",null),_e=Ae.exports},1614:function(e,t,r){"use strict";r.d(t,{$7:function(){return u},SM:function(){return h},Vv:function(){return l},kH:function(){return o}});const n="cellVisDB",i=2,a="dataCache";function s(){return new Promise(((e,t)=>{const r=window.indexedDB.open(n);r.onsuccess=r=>{const s=r.target.result,o=s.version;s.close();const l=Math.max(o,i);console.log(`IndexedDB: 当前版本=${o}, 目标版本=${l}`);const c=window.indexedDB.open(n,l);c.onupgradeneeded=e=>{const t=e.target.result;console.log(`IndexedDB: 升级数据库从版本 ${e.oldVersion} 到 ${e.newVersion}`),t.objectStoreNames.contains(a)||(console.log(`IndexedDB: 创建对象仓库 ${a}`),t.createObjectStore(a,{autoIncrement:!0}))},c.onsuccess=t=>{const r=t.target.result;console.log(`IndexedDB: 成功打开数据库，版本=${r.version}`),e(r)},c.onerror=e=>{console.error("IndexedDB: 打开数据库失败:",e.target.error),t(e.target.error)}},r.onerror=r=>{console.log("IndexedDB: 数据库不存在，创建新数据库");const s=window.indexedDB.open(n,i);s.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(a)||t.createObjectStore(a,{autoIncrement:!0})},s.onsuccess=t=>{const r=t.target.result;e(r)},s.onerror=e=>{console.error("IndexedDB: 创建数据库失败:",e.target.error),t(e.target.error)}}}))}function o(e,t){return s().then((r=>new Promise(((n,i)=>{const s=r.transaction(a,"readwrite"),o=s.objectStore(a),l=o.put(t,e);l.onsuccess=()=>n(l.result),l.onerror=e=>{console.error("存储数据失败:",e.target.error),i(e.target.error)},s.oncomplete=()=>{console.log(`数据 ${e} 成功存储到IndexDB`)},s.onerror=e=>{console.error("事务执行失败:",e.target.error),i(e.target.error)}}))))}function l(e){return s().then((t=>new Promise(((r,n)=>{const i=t.transaction(a,"readonly"),s=i.objectStore(a),o=s.get(e);o.onsuccess=()=>r(o.result),o.onerror=e=>{console.error("获取数据失败:",e.target.error),n(e.target.error)}}))))}function c(){return new Promise(((e,t)=>{console.log("IndexedDB: 开始删除数据库以解决版本冲突...");const r=window.indexedDB.deleteDatabase(n);r.onsuccess=()=>{console.log("IndexedDB: 数据库删除成功"),e()},r.onerror=e=>{console.error("IndexedDB: 数据库删除失败:",e.target.error),t(e.target.error)},r.onblocked=()=>{console.warn("IndexedDB: 数据库删除被阻止，可能有其他连接未关闭"),setTimeout((()=>{e()}),1e3)}}))}async function u(){try{await c();const e=await s();e.close(),console.log("IndexedDB: 数据库重置完成")}catch(e){throw console.error("IndexedDB: 重置数据库失败:",e),e}}async function h(e){try{console.log(`IndexedDB: 开始清理数据集 ${e} 的缓存...`);const t=await s(),r=t.transaction(a,"readwrite"),n=r.objectStore(a),i=await new Promise(((e,t)=>{const r=n.getAllKeys();r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})),o=i.filter((t=>"string"===typeof t&&t.startsWith(`${e}_`)));console.log(`IndexedDB: 找到 ${o.length} 个需要清理的缓存项`);const l=o.map((e=>new Promise(((t,r)=>{const i=n.delete(e);i.onsuccess=()=>t(),i.onerror=()=>r(i.error)}))));await Promise.all(l),await new Promise(((e,t)=>{r.oncomplete=()=>e(),r.onerror=()=>t(r.error)})),t.close(),console.log(`IndexedDB: 数据集 ${e} 的缓存清理完成`)}catch(t){throw console.error(`IndexedDB: 清理数据集缓存失败 (${e}):`,t),t}}},4201:function(){},6445:function(e,t,r){"use strict";r.d(t,{dataLoader:function(){return d}});var n=r(1614),i=(r(8661),r(374)),a=r(2004);function s(e){const t=(0,a.vh)();return t?`${t}_${e}`:(console.warn("无法获取当前数据集，使用默认缓存键"),e)}async function o(e){try{const t=await(0,n.Vv)(e);return t||null}catch(t){return console.error("检查缓存失败:",t),null}}async function l(e,t){try{return await(0,n.kH)(e,t),!0}catch(r){return console.error("缓存数据失败:",r),!1}}async function c(e,t=null){if(t){const e=await o(t);if(e)return console.log(`使用缓存数据: ${t}`),new Float32Array(e)}try{const r=await fetch(e);if(!r.ok)throw new Error(`加载二进制文件失败: ${r.status} ${r.statusText}`);const n=await r.arrayBuffer(),i=new Float32Array(n);if(t){const e=Array.from(i);await l(t,e)}return i}catch(r){return console.error(`加载二进制文件失败: ${e}`,r),new Float32Array(0)}}async function u(e){const t=`coords_${e.split("/").pop()}`,r=s(t);try{i.Sr.startMark(`loadCoords:${e}`);const t=await c(e,r);if(0===t.length||t.length%2!==0)throw new Error(`坐标数据格式无效: ${e}`);const n=t.length/2,a=i.Sr.endMark(`loadCoords:${e}`);return i.un.checkLoadTime(a),{points:t,count:n}}catch(n){return console.error(`加载坐标数据失败: ${e}`,n),{points:new Float32Array(0),count:0}}}class h{constructor(){this.maxRetries=3,this.retryDelay=500,this.abortController=null,this.loadStatus={inProgress:!1,loaded:0,total:0,errors:[]}}async loadQuadTree(e){const t=(0,a.vh)(),r=`quadtree_${t}`;return(0,a.by)(r,(async()=>{i.Sr.startMark("loadQuadTree");try{const t=await this.fetchWithRetry(e);if(!t.ok)throw new Error(`加载四叉树失败: ${t.status} ${t.statusText}`);const r=await t.json(),n=i.Sr.endMark("loadQuadTree");return i.un.checkLoadTime(n),r}catch(t){throw this.handleError("加载四叉树失败",t),t}}))}async loadDataBlock(e){i.Sr.startMark(`loadBlock:${e}`);try{const t=await this.fetchWithRetry(e);if(!t.ok)throw new Error(`加载数据块失败: ${t.status} ${t.statusText}`);const r=await t.json(),n=i.Sr.endMark(`loadBlock:${e}`);return i.un.checkLoadTime(n),r}catch(t){throw this.handleError(`加载数据块失败: ${e}`,t),t}}async loadCoordinateBlock(e){try{const r=e,i=s(r);let o=await(0,n.Vv)(i);if(!o||0===o.length){console.log(`节点 ${e} 未从缓存中获取到数据，尝试从文件加载`);const r=(0,a.buildDatasetPath)(`blocks/${e}.bin`);try{const{points:t,count:a}=await u(r);if(!(a>0))return console.warn(`节点 ${e} 文件加载失败或为空`),{points:new Float32Array(0),count:0};o=[];for(let e=0;e<t.length;e+=2)o.push([t[e],t[e+1]]);await(0,n.kH)(i,o),console.log(`节点 ${e} 数据已重新加载并缓存，共 ${a} 个点`)}catch(t){return console.error(`从文件加载节点 ${e} 失败:`,t),{points:new Float32Array(0),count:0}}}const l=new Float32Array(o.flat()),c=o.length;return{points:l,count:c}}catch(r){if("VersionError"===r.name){console.warn(`IndexedDB版本冲突，重置数据库后重试加载节点 ${e}`);try{return await(0,n.$7)(),await this.loadCoordinateBlock(e)}catch(i){console.error("重置IndexedDB失败:",i)}}console.error(`加载节点 ${e} 数据失败:`,r);try{console.log(`作为备选方案，直接从文件加载节点 ${e}`);const t=(0,a.buildDatasetPath)(`blocks/${e}.bin`),{points:r,count:n}=await u(t);if(n>0){const e=[];for(let n=0;n<r.length;n+=2)e.push([r[n],r[n+1]]);const t=new Float32Array(e.flat());return{points:t,count:e.length}}}catch(o){console.error("备选方案也失败:",o)}return{points:new Float32Array(0),count:0}}}async loadCellAttribute(e,t=null){const r=(0,a.vh)(),n=`cell_attr_${r}_${e}`;return(0,a.by)(n,(async()=>{try{const r=(0,a.buildDatasetPath)(`cell_types/${e}.bin`);this.loadStatus.inProgress=!0,this.loadStatus.field=e,console.log(`从路径加载属性数据: ${r} (去重键: ${n})`),this.abortController=new AbortController;const i=await this.fetchWithRetry(r,{signal:this.abortController.signal,cache:"no-store",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"}});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const o=i.headers.get("Content-Length"),c=o?parseInt(o,10):0,u=i.body.getReader(),h=[];let d=0;while(1){const{done:e,value:r}=await u.read();if(e)break;h.push(r),d+=r.length,t&&c>0&&t(Math.min(d/c,.99))}const f=new Uint8Array(d);let g=0;for(const e of h)f.set(e,g),g+=e.length;const p=f.buffer,m=new Float32Array(p);console.log(`属性 ${e} 加载完成，数据长度: ${m.length}`);const v=`attr_${e}`,y=s(v);return await l(y,Array.from(m)),t&&t(1),this.loadStatus.inProgress=!1,m}catch(r){if(this.loadStatus.inProgress=!1,"AbortError"===r.name)return console.log(`加载属性 ${e} 已取消`),new Float32Array(0);throw this.handleError(`加载属性 ${e} 失败`,r),r}}))}async loadAllCellAttributes(e,t){this.loadStatus.inProgress=!0,this.loadStatus.loaded=0,this.loadStatus.total=e.length,this.loadStatus.errors=[];const r=new Map;try{const n=await Promise.allSettled(e.map((async(e,n)=>{try{const n=await this.loadCellAttribute(e);return r.set(e,n),this.loadStatus.loaded++,t&&t({loaded:this.loadStatus.loaded,total:this.loadStatus.total,progress:this.loadStatus.loaded/this.loadStatus.total,field:e}),{field:e,success:!0}}catch(i){return this.loadStatus.errors.push({field:e,error:i.message}),{field:e,success:!1,error:i.message}}}))),i=n.filter((e=>"rejected"===e.status||"fulfilled"===e.status&&!e.value.success));return i.length>0&&console.warn(`${i.length}个细胞属性数据加载失败`),r}catch(n){throw this.handleError("加载细胞属性数据失败",n),n}finally{this.loadStatus.inProgress=!1}}cancelLoading(){this.abortController&&(this.abortController.abort(),this.loadStatus.inProgress=!1,console.log("数据加载已取消"))}getLoadStatus(){return{...this.loadStatus}}async fetchWithRetry(e,t={}){let r;for(let i=0;i<=this.maxRetries;i++)try{return this.abortController&&(t.signal=this.abortController.signal),await fetch(e,t)}catch(n){if(r=n,"AbortError"===n.name||i===this.maxRetries)throw n;const t=this.retryDelay*Math.pow(2,i);console.warn(`请求失败，${t}ms后重试(${i+1}/${this.maxRetries}): ${e}`),await new Promise((e=>setTimeout(e,t)))}throw r}handleError(e,t){"AbortError"!==t.name?(console.error(`${e}:`,t),this.loadStatus.errors.push({context:e,message:t.message,timestamp:(new Date).toISOString()})):console.log(`${e}: 操作已取消`)}}const d=new h},7876:function(e){var t=6402,r=34041,n=36193,i={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:n},EXT_color_buffer_float:{},OES_standard_derivatives:{},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},a={};e.exports={overrideContextType:function(e){const t=this,r=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=function(e,n){return t.wrapGLContext(r.bind(this)("webgl2",n),a)};var n=e();return HTMLCanvasElement.prototype.getContext=r,n},wrapGLContext:function(e,t){for(var r in e[this.versionProperty]=2,i)t[r.toLowerCase()]=i[r];e.getExtension("EXT_color_buffer_float");const n=e.getExtension;e.getExtension=function(r){return t[r.toLowerCase()]||n.apply(e,[r])};const a=this,s=e.texImage2D;return e.texImage2D=function(t,r,n,i,o,l,c,u,h){if(6==arguments.length){var d=a.getInternalFormat(e,n,o);s.apply(e,[t,r,d,i,webgl.getTextureType(e,o),l])}else{d=a.getInternalFormat(e,n,u);s.apply(e,[t,r,d,i,o,l,c,a.getTextureType(e,u),h])}},t["webgl_draw_buffers"]={drawBuffersWEBGL:function(){return e.drawBuffers.apply(e,arguments)}},t["oes_vertex_array_object"]={VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES:function(){return e.createVertexArray()},deleteVertexArrayOES:function(){return e.deleteVertexArray.apply(e,arguments)},isVertexArrayOES:function(){return e.isVertexArray.apply(e,arguments)},bindVertexArrayOES:function(){return e.bindVertexArray.apply(e,arguments)}},t["angle_instanced_arrays"]={VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE:function(){return e.drawArraysInstanced.apply(e,arguments)},drawElementsInstancedANGLE:function(){return e.drawElementsInstanced.apply(e,arguments)},vertexAttribDivisorANGLE:function(){return e.vertexAttribDivisor.apply(e,arguments)}},e},versionProperty:"___regl_gl_version___",getInternalFormat:function(e,i,a){return 2!==e[this.versionProperty]?i:i===t?e.DEPTH_COMPONENT24:i===r?e.DEPTH24_STENCIL8:a===n&&i===e.RGBA?e.RGBA16F:a===n&&i===e.RGB?e.RGB16F:a===e.FLOAT&&i===e.RGBA?e.RGBA32F:a===e.FLOAT&&i===e.RGB?e.RGB32F:i},getTextureType:function(e,t){return 2!==e[this.versionProperty]?t:t===n?e.HALF_FLOAT:t}}},9182:function(e,t,r){
/*!
 * vue-virtual-scroll-list v2.3.4
 * open source under the MIT license
 * https://github.com/tangbc/vue-virtual-scroll-list#readme
 */
(function(t,n){e.exports=n(r(6848))})(0,(function(e){"use strict";function t(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function r(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?t(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e){return l(e)||c(e)||u(e)||d()}function l(e){if(Array.isArray(e))return h(e)}function c(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function u(e,t){if(e){if("string"===typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?h(e,t):void 0}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function d(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e["default"]:e;var f={FRONT:"FRONT",BEHIND:"BEHIND"},g={INIT:"INIT",FIXED:"FIXED",DYNAMIC:"DYNAMIC"},p=0,m=function(){function e(t,r){n(this,e),this.init(t,r)}return a(e,[{key:"init",value:function(e,t){this.param=e,this.callUpdate=t,this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.fixedSizeValue=0,this.calcType=g.INIT,this.offset=0,this.direction="",this.range=Object.create(null),e&&this.checkRange(0,e.keeps-1)}},{key:"destroy",value:function(){this.init(null,null)}},{key:"getRange",value:function(){var e=Object.create(null);return e.start=this.range.start,e.end=this.range.end,e.padFront=this.range.padFront,e.padBehind=this.range.padBehind,e}},{key:"isBehind",value:function(){return this.direction===f.BEHIND}},{key:"isFront",value:function(){return this.direction===f.FRONT}},{key:"getOffset",value:function(e){return(e<1?0:this.getIndexOffset(e))+this.param.slotHeaderSize}},{key:"updateParam",value:function(e,t){var r=this;this.param&&e in this.param&&("uniqueIds"===e&&this.sizes.forEach((function(e,n){t.includes(n)||r.sizes["delete"](n)})),this.param[e]=t)}},{key:"saveSize",value:function(e,t){this.sizes.set(e,t),this.calcType===g.INIT?(this.fixedSizeValue=t,this.calcType=g.FIXED):this.calcType===g.FIXED&&this.fixedSizeValue!==t&&(this.calcType=g.DYNAMIC,delete this.fixedSizeValue),this.calcType!==g.FIXED&&"undefined"!==typeof this.firstRangeTotalSize&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=o(this.sizes.values()).reduce((function(e,t){return e+t}),0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):delete this.firstRangeTotalSize)}},{key:"handleDataSourcesChange",value:function(){var e=this.range.start;this.isFront()?e-=p:this.isBehind()&&(e+=p),e=Math.max(e,0),this.updateRange(this.range.start,this.getEndByStart(e))}},{key:"handleSlotSizeChange",value:function(){this.handleDataSourcesChange()}},{key:"handleScroll",value:function(e){this.direction=e<this.offset||0===e?f.FRONT:f.BEHIND,this.offset=e,this.param&&(this.direction===f.FRONT?this.handleFront():this.direction===f.BEHIND&&this.handleBehind())}},{key:"handleFront",value:function(){var e=this.getScrollOvers();if(!(e>this.range.start)){var t=Math.max(e-this.param.buffer,0);this.checkRange(t,this.getEndByStart(t))}}},{key:"handleBehind",value:function(){var e=this.getScrollOvers();e<this.range.start+this.param.buffer||this.checkRange(e,this.getEndByStart(e))}},{key:"getScrollOvers",value:function(){var e=this.offset-this.param.slotHeaderSize;if(e<=0)return 0;if(this.isFixedType())return Math.floor(e/this.fixedSizeValue);var t=0,r=0,n=0,i=this.param.uniqueIds.length;while(t<=i){if(r=t+Math.floor((i-t)/2),n=this.getIndexOffset(r),n===e)return r;n<e?t=r+1:n>e&&(i=r-1)}return t>0?--t:0}},{key:"getIndexOffset",value:function(e){if(!e)return 0;for(var t=0,r=0,n=0;n<e;n++)r=this.sizes.get(this.param.uniqueIds[n]),t+="number"===typeof r?r:this.getEstimateSize();return t}},{key:"isFixedType",value:function(){return this.calcType===g.FIXED}},{key:"getLastIndex",value:function(){return this.param.uniqueIds.length-1}},{key:"checkRange",value:function(e,t){var r=this.param.keeps,n=this.param.uniqueIds.length;n<=r?(e=0,t=this.getLastIndex()):t-e<r-1&&(e=t-r+1),this.range.start!==e&&this.updateRange(e,t)}},{key:"updateRange",value:function(e,t){this.range.start=e,this.range.end=t,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())}},{key:"getEndByStart",value:function(e){var t=e+this.param.keeps-1,r=Math.min(t,this.getLastIndex());return r}},{key:"getPadFront",value:function(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)}},{key:"getPadBehind",value:function(){var e=this.range.end,t=this.getLastIndex();return this.isFixedType()?(t-e)*this.fixedSizeValue:(t-e)*this.getEstimateSize()}},{key:"getEstimateSize",value:function(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}}]),e}(),v={dataKey:{type:[String,Function],required:!0},dataSources:{type:Array,required:!0},dataComponent:{type:[Object,Function],required:!0},keeps:{type:Number,default:30},extraProps:{type:Object},estimateSize:{type:Number,default:50},direction:{type:String,default:"vertical"},start:{type:Number,default:0},offset:{type:Number,default:0},topThreshold:{type:Number,default:0},bottomThreshold:{type:Number,default:0},pageMode:{type:Boolean,default:!1},rootTag:{type:String,default:"div"},wrapTag:{type:String,default:"div"},wrapClass:{type:String,default:""},wrapStyle:{type:Object},itemTag:{type:String,default:"div"},itemClass:{type:String,default:""},itemClassAdd:{type:Function},itemStyle:{type:Object},headerTag:{type:String,default:"div"},headerClass:{type:String,default:""},headerStyle:{type:Object},footerTag:{type:String,default:"div"},footerClass:{type:String,default:""},footerStyle:{type:Object},itemScopedSlots:{type:Object}},y={index:{type:Number},event:{type:String},tag:{type:String},horizontal:{type:Boolean},source:{type:Object},component:{type:[Object,Function]},slotComponent:{type:Function},uniqueKey:{type:[String,Number]},extraProps:{type:Object},scopedSlots:{type:Object}},b={event:{type:String},uniqueKey:{type:String},tag:{type:String},horizontal:{type:Boolean}},x={created:function(){this.shapeKey=this.horizontal?"offsetWidth":"offsetHeight"},mounted:function(){var e=this;"undefined"!==typeof ResizeObserver&&(this.resizeObserver=new ResizeObserver((function(){e.dispatchSizeChange()})),this.resizeObserver.observe(this.$el))},updated:function(){this.resizeObserver.observe(this.$el)},beforeDestroy:function(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)},methods:{getCurrentSize:function(){return this.$el?this.$el[this.shapeKey]:0},dispatchSizeChange:function(){this.$parent.$emit(this.event,this.uniqueKey,this.getCurrentSize(),this.hasInitial)}}},w=e.component("virtual-list-item",{mixins:[x],props:y,render:function(e){var t=this.tag,n=this.component,i=this.extraProps,a=void 0===i?{}:i,s=this.index,o=this.source,l=this.scopedSlots,c=void 0===l?{}:l,u=this.uniqueKey,h=this.slotComponent,d=r(r({},a),{},{source:o,index:s});return e(t,{key:u,attrs:{role:"listitem"}},[h?h({item:o,index:s,scope:d}):e(n,{props:d,scopedSlots:c})])}}),S=e.component("virtual-list-slot",{mixins:[x],props:b,render:function(e){var t=this.tag,r=this.uniqueKey;return e(t,{key:r,attrs:{role:r}},this.$slots["default"])}}),C={ITEM:"item_resize",SLOT:"slot_resize"},A={HEADER:"thead",FOOTER:"tfoot"},_=e.component("virtual-list",{props:v,data:function(){return{range:null}},watch:{"dataSources.length":function(){this.virtual.updateParam("uniqueIds",this.getUniqueIdFromDataSources()),this.virtual.handleDataSourcesChange()},keeps:function(e){this.virtual.updateParam("keeps",e),this.virtual.handleSlotSizeChange()},start:function(e){this.scrollToIndex(e)},offset:function(e){this.scrollToOffset(e)}},created:function(){this.isHorizontal="horizontal"===this.direction,this.directionKey=this.isHorizontal?"scrollLeft":"scrollTop",this.installVirtual(),this.$on(C.ITEM,this.onItemResized),(this.$slots.header||this.$slots.footer)&&this.$on(C.SLOT,this.onSlotResized)},activated:function(){this.scrollToOffset(this.virtual.offset),this.pageMode&&document.addEventListener("scroll",this.onScroll,{passive:!1})},deactivated:function(){this.pageMode&&document.removeEventListener("scroll",this.onScroll)},mounted:function(){this.start?this.scrollToIndex(this.start):this.offset&&this.scrollToOffset(this.offset),this.pageMode&&(this.updatePageModeFront(),document.addEventListener("scroll",this.onScroll,{passive:!1}))},beforeDestroy:function(){this.virtual.destroy(),this.pageMode&&document.removeEventListener("scroll",this.onScroll)},methods:{getSize:function(e){return this.virtual.sizes.get(e)},getSizes:function(){return this.virtual.sizes.size},getOffset:function(){if(this.pageMode)return document.documentElement[this.directionKey]||document.body[this.directionKey];var e=this.$refs.root;return e?Math.ceil(e[this.directionKey]):0},getClientSize:function(){var e=this.isHorizontal?"clientWidth":"clientHeight";if(this.pageMode)return document.documentElement[e]||document.body[e];var t=this.$refs.root;return t?Math.ceil(t[e]):0},getScrollSize:function(){var e=this.isHorizontal?"scrollWidth":"scrollHeight";if(this.pageMode)return document.documentElement[e]||document.body[e];var t=this.$refs.root;return t?Math.ceil(t[e]):0},scrollToOffset:function(e){if(this.pageMode)document.body[this.directionKey]=e,document.documentElement[this.directionKey]=e;else{var t=this.$refs.root;t&&(t[this.directionKey]=e)}},scrollToIndex:function(e){if(e>=this.dataSources.length-1)this.scrollToBottom();else{var t=this.virtual.getOffset(e);this.scrollToOffset(t)}},scrollToBottom:function(){var e=this,t=this.$refs.shepherd;if(t){var r=t[this.isHorizontal?"offsetLeft":"offsetTop"];this.scrollToOffset(r),setTimeout((function(){e.getOffset()+e.getClientSize()+1<e.getScrollSize()&&e.scrollToBottom()}),3)}},updatePageModeFront:function(){var e=this.$refs.root;if(e){var t=e.getBoundingClientRect(),r=e.ownerDocument.defaultView,n=this.isHorizontal?t.left+r.pageXOffset:t.top+r.pageYOffset;this.virtual.updateParam("slotHeaderSize",n)}},reset:function(){this.virtual.destroy(),this.scrollToOffset(0),this.installVirtual()},installVirtual:function(){this.virtual=new m({slotHeaderSize:0,slotFooterSize:0,keeps:this.keeps,estimateSize:this.estimateSize,buffer:Math.round(this.keeps/3),uniqueIds:this.getUniqueIdFromDataSources()},this.onRangeChanged),this.range=this.virtual.getRange()},getUniqueIdFromDataSources:function(){var e=this.dataKey;return this.dataSources.map((function(t){return"function"===typeof e?e(t):t[e]}))},onItemResized:function(e,t){this.virtual.saveSize(e,t),this.$emit("resized",e,t)},onSlotResized:function(e,t,r){e===A.HEADER?this.virtual.updateParam("slotHeaderSize",t):e===A.FOOTER&&this.virtual.updateParam("slotFooterSize",t),r&&this.virtual.handleSlotSizeChange()},onRangeChanged:function(e){this.range=e},onScroll:function(e){var t=this.getOffset(),r=this.getClientSize(),n=this.getScrollSize();t<0||t+r>n+1||!n||(this.virtual.handleScroll(t),this.emitEvent(t,r,n,e))},emitEvent:function(e,t,r,n){this.$emit("scroll",n,this.virtual.getRange()),this.virtual.isFront()&&this.dataSources.length&&e-this.topThreshold<=0?this.$emit("totop"):this.virtual.isBehind()&&e+t+this.bottomThreshold>=r&&this.$emit("tobottom")},getRenderSlots:function(e){for(var t=[],r=this.range,n=r.start,i=r.end,a=this.dataSources,s=this.dataKey,o=this.itemClass,l=this.itemTag,c=this.itemStyle,u=this.isHorizontal,h=this.extraProps,d=this.dataComponent,f=this.itemScopedSlots,g=this.$scopedSlots&&this.$scopedSlots.item,p=n;p<=i;p++){var m=a[p];if(m){var v="function"===typeof s?s(m):m[s];"string"===typeof v||"number"===typeof v?t.push(e(w,{props:{index:p,tag:l,event:C.ITEM,horizontal:u,uniqueKey:v,source:m,extraProps:h,component:d,slotComponent:g,scopedSlots:f},style:c,class:"".concat(o).concat(this.itemClassAdd?" "+this.itemClassAdd(p):"")})):console.warn("Cannot get the data-key '".concat(s,"' from data-sources."))}else console.warn("Cannot get the index '".concat(p,"' from data-sources."))}return t}},render:function(e){var t=this.$slots,r=t.header,n=t.footer,i=this.range,a=i.padFront,s=i.padBehind,o=this.isHorizontal,l=this.pageMode,c=this.rootTag,u=this.wrapTag,h=this.wrapClass,d=this.wrapStyle,f=this.headerTag,g=this.headerClass,p=this.headerStyle,m=this.footerTag,v=this.footerClass,y=this.footerStyle,b={padding:o?"0px ".concat(s,"px 0px ").concat(a,"px"):"".concat(a,"px 0px ").concat(s,"px")},x=d?Object.assign({},d,b):b;return e(c,{ref:"root",on:{"&scroll":!l&&this.onScroll}},[r?e(S,{class:g,style:p,props:{tag:f,event:C.SLOT,uniqueKey:A.HEADER}},r):null,e(u,{class:h,attrs:{role:"group"},style:x},this.getRenderSlots(e)),n?e(S,{class:v,style:y,props:{tag:m,event:C.SLOT,uniqueKey:A.FOOTER}},n):null,e("div",{ref:"shepherd",style:{width:o?"0px":"100%",height:o?"100%":"0px"}})])}});return _}))}}]);
//# sourceMappingURL=home.1d6778df.js.map